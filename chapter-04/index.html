<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Développer pour les navigateurs web</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Développer pour les navigateurs web</h1>
<div class="details">
<span id="revdate">2017-09-06</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>La popularité de Node s&#8217;est établie également pour la profusion d&#8217;outillage apportée au développement web <em>frontend</em>.</p>
</div>
<div class="paragraph">
<p>Ce chapitre nous apprendra le rôle de Node en tant qu&#8217;extension au développement <em>frontend</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Polyfills et compatibilité <em>ECMASCript</em></p>
</li>
<li>
<p>Importer des modules <em>npm</em> pour le web</p>
</li>
<li>
<p>Créer du code modulaire, avec ou sans <em>framework</em></p>
</li>
<li>
<p>Échanges de données en temps-réel</p>
</li>
<li>
<p>Outillage utile au quotidien</p>
</li>
<li>
<p>Tester son code et la compatibilité avec les navigateurs web</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Avant l&#8217;apparition de Node, rare était l&#8217;outillage n&#8217;imposant pas une ou plusieurs plates-formes de développement : <em>YUICompressor</em> demandait Java, <em>Google Closure Compiler</em> demandait Java, <em>sprockets</em> Ruby et <em>pngquant</em> quelques dépendances système comme <em>libpng</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;existence de Node et du registre <em>npm</em> a favorisé le développement d&#8217;un écosystème orienté <em>frontend</em> plus simple à appréhender.
Cela s&#8217;étend de la découverte au téléchargement des librairies tierces ainsi qu&#8217;à la compilation, l&#8217;optimisation et l&#8217;exécution des tests des applications web côté client.</p>
</div>
<div class="paragraph">
<p>Cet <strong>écosystème rend l&#8217;écriture de code moderne normale</strong> ; un code anticipant les futurs standards d'<em>ECMAScript</em> et <em>HTML5</em>, sur les navigateurs actuels et anciens.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre se réfère aux versions de <strong>Node v6</strong> et <strong>npm v4</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Utilisation des exemples</div>
<div class="paragraph">
<p>Les exemples légendés avec un <em>nom de fichier</em> sont disponibles dans le module <em>npm</em> dédié à cet ouvrage.
Ils sont fonctionnels et destinés à être exécutés sur votre ordinateur :</p>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exécution du bloc de code légendé par <code>modules/node-timer.js</code>.</div>
<div class="content">
<pre>$ npm install --global nodebook@latest
$ nodebook chapter 4
$ node ./examples/modules/node-timer.js</pre>
</div>
</div>
<div class="paragraph">
<p>Certains exemples de ce chapitre correspondent à des pages HTML destinées à être utilisées dans des navigateurs web modernes comme Firefox, Chrome, Edge ou encore Safari.</p>
</div>
<div class="paragraph">
<p>Ils sont accessible en démarrant le serveur web dédié aux exemples de de chapitre :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ nodebook chapter 4
$ npm start
$ open http://localhost:4000/examples</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#_quel_rapport_entre_node_et_les_navigateurs_web">1. Quel rapport entre Node et les navigateurs web ?</a></li>
<li><a href="#_écrire_dès_à_présent_le_code_du_futur">2. Écrire dès à présent le code du futur</a>
<ul class="sectlevel2">
<li><a href="#_la_fin_de_l_approche_par_le_dénominateur_commun">2.1. La fin de l&#8217;approche par le dénominateur commun</a></li>
<li><a href="#transpilation">2.2. Écrire au plus proche des standards</a></li>
<li><a href="#polyfills">2.3. Combler les manques avec des <em>polyfills</em></a></li>
</ul>
</li>
<li><a href="#modules">3. Importer des modules</a>
<ul class="sectlevel2">
<li><a href="#modules-script">3.1. La balise <code>&lt;script&gt;</code></a></li>
<li><a href="#modules-es2015">3.2. Les modules <em>ECMAScript 2015</em></a></li>
<li><a href="#browserify">3.3. Importer des modules <em>npm</em> pour le web</a></li>
<li><a href="#_récapitulatif">3.4. Récapitulatif</a></li>
</ul>
</li>
<li><a href="#_conception_modulaire">4. Conception modulaire</a>
<ul class="sectlevel2">
<li><a href="#_le_syndrome_du_plugin_em_jquery_em">4.1. Le syndrome du plugin <em>jQuery</em></a></li>
<li><a href="#_vers_une_approche_em_jquery_em_composite">4.2. Vers une approche <em>jQuery</em> composite</a></li>
<li><a href="#_partager_le_code_métier_avec_node">4.3. Partager le code métier avec Node</a></li>
<li><a href="#_séparation_du_fond_et_de_la_forme_données_rendu_et_interactions">4.4. Séparation du fond et de la forme : données, rendu et interactions</a></li>
<li><a href="#react">4.5. Rapprocher données, rendu et interactions avec <em>React</em></a></li>
</ul>
</li>
<li><a href="#io">5. Des requêtes AJAX au temps-réel</a>
<ul class="sectlevel2">
<li><a href="#io-fetch">5.1. Échange ponctuel de données avec <code>fetch()</code></a></li>
<li><a href="#io-eventsource">5.2. Approche unidirectionnelle avec <em>EventSource</em></a></li>
<li><a href="#io-websocket">5.3. Échanges en temps-réel avec <em>WebSocket</em></a></li>
</ul>
</li>
<li><a href="#_développer_au_quotidien">6. Développer au quotidien</a>
<ul class="sectlevel2">
<li><a href="#watchify">6.1. Reconstruire en continu avec <code>watchify</code></a></li>
<li><a href="#livereload">6.2. Changements en temps-réel dans le navigateur</a></li>
<li><a href="#node-sass">6.3. Modulariser ses feuilles de style avec <em>Sass</em></a></li>
<li><a href="#ui-bundling">6.4. Lier composants visuels et feuilles de style</a></li>
<li><a href="#_optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</a></li>
</ul>
</li>
<li><a href="#testing">7. Tester son code</a>
<ul class="sectlevel2">
<li><a href="#testing-101">7.1. Que tester ?</a></li>
<li><a href="#_s_outiller_pour_écrire_des_assertions">7.2. S&#8217;outiller pour écrire des assertions</a></li>
<li><a href="#_tester_ses_composants_react_sans_navigateur_web">7.3. Tester ses composants React sans navigateur web</a></li>
<li><a href="#_tester_code_et_composants_dans_les_navigateurs_web">7.4. Tester code et composants dans les navigateurs web</a></li>
<li><a href="#ci">7.5. Intégration continue et compatibilité navigateurs</a></li>
</ul>
</li>
<li><a href="#_conclusion">8. Conclusion</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quel_rapport_entre_node_et_les_navigateurs_web">1. Quel rapport entre Node et les navigateurs web ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce chapitre peut sembler confus au premier abord.
Si Node s&#8217;exécute au niveau du système d&#8217;exploitation — "côté serveur" — en quoi est-il lié au développement <em>frontend</em> — "côté client" ?
Est-ce parce que du code écrit pour Node peut aussi fonctionner dans un navigateur web ?
<em>Quid</em> de l&#8217;utilisation de <code>require('fs')</code> pour accéder au système de fichiers ?</p>
</div>
<div class="paragraph">
<p>La réponse <em>courte</em> est : <strong>nous n&#8217;exécutons pas Node dans un navigateur web</strong>.</p>
</div>
<div class="paragraph">
<p>Et la réponse <em>longue</em> : <strong>Node est utilisé pour assembler du code</strong>, le <em>transformer</em> et le rendre fonctionnel dans une paire de balises <code>&lt;script&gt;&lt;/script&gt;</code>.<br>
Ce code peut être aussi bien fourni par des <strong>librairies tierces</strong> installées via <em>npm</em> (<em>jQuery</em>, <em>React</em> ou <em>d3</em> par exemple) que par de l'<strong>outillage</strong> (optimiseurs, suite de tests, orchestration de tâches etc.) ou encore par le <strong>code réutilisable</strong> de notre propre application web.</p>
</div>
<div class="paragraph">
<p>Il faut également bien comprendre qu&#8217;il y a plusieurs "problèmes" cachés sous une même question :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les navigateurs web et Node utilisent différentes machines virtuelles JavaScript, avec différents niveaux de complétion dans l&#8217;implémentation d'<em>ECMAScript</em> ;</p>
</li>
<li>
<p>Les navigateurs web et Node n&#8217;ont pas accès aux mêmes APIs – Node accède à <code>fs</code> et <code>http</code> tandis que les navigateurs ont <code>File</code> et <code>fetch</code>/<code>XmlHttpRequest</code> ;</p>
</li>
<li>
<p>Les navigateurs web et Node ne gèrent pas le chargement de modules de la même manière – voir la section <a href="#managing-dependencies">gestion des dépendances</a> ;</p>
</li>
<li>
<p>L&#8217;implémentation même d'<em>ECMAScript</em> va différer selon les versions de Node employées – un navigateur moderne et Node 6 comprendraient l&#8217;objet natif <code>Promise</code> mais pas Node 0.12.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce processus n&#8217;est <em>pas magique</em> et nous verrons graduellement au cours des prochaines sections comment tout ceci fonctionne.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_écrire_dès_à_présent_le_code_du_futur">2. Écrire dès à présent le code du futur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transformer du code ECMAScript a pendant longtemps été chose pénible.
Je pense par exemple à de la minification de code (pour réduire les temps de transfert sur les antiques lignes ADSL 128K) ou à de la conversion automatique de code <em>ECMAScript 3</em> en <em>ECMAScript 5</em>.
Cela nécessitait systématiquement l&#8217;utilisation d&#8217;un autre environnement qu&#8217;ECMAScript lui-même: <em>Rhino</em> nécessitait Java, <em>Spidermonkey</em> nécessitait C++ et <em>Trident</em> nécessitait un environnement Windows en plus de C++.</p>
</div>
<div class="paragraph">
<p><strong>esprima</strong> chamboule les règles du jeu en décembre 2011 : ce parseur <em>ECMAScript</em> — lui-même écrit en <em>ECMAScript</em> – exporte une compréhension de code sous forme d&#8217;arbre syntaxique abstrait (<em>abstract syntax tree</em>, <em>AST</em>).
Cet arbre est lui-même analysable par de <strong>nouveaux outils émergents</strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les <em>source maps</em> pour associer le code transformé au code d&#8217;origine, notamment dans les outils de développement des navigateurs web ;</p>
</li>
<li>
<p>des <em>minifieurs</em> plus efficaces et ayant connaissance des portions de code exécutées ;</p>
</li>
<li>
<p>des <em>analyseurs de code</em> pour informer le développeur d&#8217;erreurs de syntaxe, de non-respect de styles de développement etc. ;</p>
</li>
<li>
<p>des <em>convertisseurs de code</em> pour passer d'<em>ECMAScript</em> vers <em>CoffeeScript</em>, de modules <em>CommonJS</em> vers des modules <em>ECMAScript 2015</em> etc.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Annonce d'<em>esprima</em></div>
<div class="paragraph">
<p><em>Aryia Hidayat</em> introduit esprima dans un billet de blog.
Il y présente notamment des comparatifs de performances d&#8217;exécution sur différentes VM ECMAScript et face à d&#8217;autres parseurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://ariya.io/2011/12/introducing-esprima" class="bare">ariya.io/2011/12/introducing-esprima</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_la_fin_de_l_approche_par_le_dénominateur_commun">2.1. La fin de l&#8217;approche par le dénominateur commun</h3>
<div class="paragraph">
<p>Qui n&#8217;a pas déjà entamé un projet en posant la question à un client, en regardant les statistiques de traffic ou en se posant une question à soi-même : quelle est la liste des versions de navigateurs avec lequel notre site ou application web doit être compatible ?</p>
</div>
<div class="paragraph">
<p>La version de navigateur la plus ancienne ou la moins conforme aux standards était celle qui donnait le <em>la</em> (qui a prononcé <em>Internet Explorer 7</em> dans la salle ?).<br>
Cela voulait dire se priver de techniques modernes, standardisées ou en cours de standardisation.
Cela voulait dire des <em>hacks</em> dans ses CSS, dans son code <em>ECMAScript</em> et dans ses ressources graphiques.</p>
</div>
</div>
<div class="sect2">
<h3 id="transpilation">2.2. Écrire au plus proche des standards</h3>
<div class="paragraph">
<p>Fort heureusement l&#8217;arrivée d'<em>esprima</em> change la donne et permet d&#8217;écrire un code proche des standards qui résiste au temps.
Son existence facilite l'<strong>émergence d&#8217;outils automatisant les transformations de code</strong> pour satisfaire nos besoins spécifiques.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs éléments à prendre en compte concernant la standardisation de nouvelles versions d'<em>ECMAScript</em> et les évolutions de sa syntaxe :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>la <strong>cadence de standardisation</strong> a été revue pour devenir prédictible – une volonté d&#8217;une fois par an ;</p>
</li>
<li>
<p>les <strong>fonctionnalités et éléments de syntaxe sont implémentés un par un</strong>, à des vitesses différentes par les différents navigateurs web ;</p>
</li>
<li>
<p><em>deux tiers</em> de navigateurs fonctionnent sur des <strong>rythmes de mises à jour en cycle court</strong> (de six à neuf semaines) – le <em>tiers</em> restant est cadencé à <strong>une seule mise à jour par an</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il vaut mieux <strong>parier sur les standards comme stratégie à long terme</strong> si on tient compte du <em>temps de développement</em> et du <em>temps de maintenance</em> d&#8217;une base de code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Question</span> Standards, quels standards ?</div>
<div class="paragraph">
<p>Il y a plusieurs organismes prenant part à la standardisation de langages et d&#8217;APIs lorsque l&#8217;on touche aux navigateurs web :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pour le <em>langage HTML</em> : WHATWG (<span class="URL"><a href="https://html.spec.whatwg.org/" class="bare">html.spec.whatwg.org/</a></span>) ;</p>
</li>
<li>
<p>Pour l'<em>API DOM</em> : WHATWG (<span class="URL"><a href="https://dom.spec.whatwg.org/" class="bare">dom.spec.whatwg.org/</a></span>) ;</p>
</li>
<li>
<p>Pour le <em>langage CSS</em> : W3C (<span class="URL"><a href="https://www.w3.org/standards/techs/css" class="bare">www.w3.org/standards/techs/css</a></span>) ;</p>
</li>
<li>
<p>Pour le <em>langage ECMAScript</em> : TC39 (<span class="URL"><a href="https://github.com/tc39" class="bare">github.com/tc39</a></span>) ;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lorsque nous écrivons du code, nous pouvons rencontrer quatre cas de figure :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>élément de syntaxe non-implémenté</strong> : transformer le code pour l&#8217;adapter aux navigateurs cibles ;</p>
</li>
<li>
<p><strong>élément de syntaxe partiellement implémenté</strong> : utiliser l&#8217;implémentation native des navigateurs et à défaut, transformer le code pour l&#8217;adapter aux autres navigateurs ;</p>
</li>
<li>
<p><strong>élément de syntaxe totalement implémenté</strong> : utiliser l&#8217;implémentation native des navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il arrive que certains éléments de syntaxe soient <strong>abandonnés</strong> pendant le processus de standardisation – ou que leur implémentation change beaucoup (on pensera à <code>Object.observe</code>).</p>
</div>
<div class="paragraph">
<p>La question qui nous taraude est : <strong>comment transformer le code</strong> pour satisfaire à la fois les navigateurs compatibles et les autres ?<br>
<strong>Babel</strong> est un outil de choix  pour parvenir à ces fins d&#8217;écriture de code résistant au(x standards du) temps.</p>
</div>
<div class="paragraph">
<p>Ce module convertit de manière sélective toute syntaxe <em>ECMAScript 2015</em> – ainsi que <em>ECMAScript 2016</em>, etc. – vers de l'<em>ECMAScript 5</em>, compréhensible par les <em>navigateurs web modernes</em>.
L&#8217;intérêt de sa <em>sélectivité</em> fait que l&#8217;on peut progressivement arrêter de convertir les éléments de syntaxe couverts par 100% des navigateurs web modernes.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Traceur</div>
<div class="paragraph">
<p><em>Traceur</em> est un des premiers transpilateurs <em>ECMAScript 2015</em> vers <em>ECMAScript 5</em> à avoir émergé dans l&#8217;écosystème Node.</p>
</div>
<div class="paragraph">
<p>Il a permis de commencer à <strong>écrire des modules en <em>ECMAScript 2015</em> bien avant que la spécification ne soit entièrement terminée</strong>.
Et donc de pouvoir anticiper son apprentissage tout en mettant le langage à l&#8217;épreuve avant sa finalisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre un code utilisant des éléments de syntaxe d'<em>ECMAScript 2015</em>.</p>
</div>
<div class="listingblock">
<div class="title">babel-es2015.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const getOS = userAgent =&gt; {
  const [, os, version] = userAgent.match(/\(([^;]+)\s?;\s?([^\)]+)\)/);
  return {os, version};
};

const {userAgent} = window.navigator; <i class="conum" data-value="1"></i><b>(1)</b>

console.log(getOS(userAgent)); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous destructurons l'<em>agent utilisateur</em> du navigateur – à noter que ce même code exécuté par Node lancerait une exception car <code>window</code> n&#8217;existe pas dans cet environnement ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche un objet content le <em>nom</em> de votre système d&#8217;exploitation ainsi que sa <em>version</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce code représente l'<strong>idéal de ce que l&#8217;on souhaite écrire</strong>.
Le seul obstacle consiste à <em>traduire</em> ce code pour l&#8217;ensemble des navigateurs web compatibles avec <em>ECMAScript 5</em>.</p>
</div>
<div class="paragraph">
<p>Exécutons cette commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm run babel -- --no-babelrc examples/babel-es2015.js</pre>
</div>
</div>
<div class="paragraph">
<p>La sortie affichée correspond <em>exactement</em> à notre code d&#8217;origine.
C&#8217;est parce que sans configuration, <em>babel</em> ne transforme rien.<br>
L&#8217;ouvrage contient un fichier de configuration <code>.babelrc</code>.
Nous expliquerons son contenu après en avoir observé son impact :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm run babel -- examples/babel-es2015.js</pre>
</div>
</div>
<div class="paragraph">
<p>La sortie a changé et renvoie un code totalement fonctionnel sur des navigateurs web ne supportant pas <em>ECMAScript 2015</em> :</p>
</div>
<div class="listingblock">
<div class="title">babel-es2015ified.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var getOS = function getOS(userAgent) {
  var _userAgent$match = userAgent.match(/\(([^;]+)\s?;\s?([^\)]+)\)/),
      os = _userAgent$match[1],
      version = _userAgent$match[2];

  return { os: os, version: version };
};

var userAgent = window.navigator.userAgent;


console.log(getOS(userAgent));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il existe de nombreuses règles de transformation.
Chacune d&#8217;entre elles ciblent une fonctionnalité spécifique d&#8217;une version d'<em>ECMAScript</em>.
Les <strong><em>presets</em> des modules <em>npm</em> faisant office de groupes logiques</strong>.</p>
</div>
<div class="paragraph">
<p>Les <em>presets</em> suivants nous aideront à convertir chaque édition de spécification <em>ECMAScript</em> vers <em>ECMASCript 5</em>.
Le <strong>dernier <em>preset</em> est le plus simple à utiliser</strong> car il se base sur les parts de marché des navigateurs web pour déterminer les règles de conversion :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>preset-es2015</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2015/" class="bare">babeljs.io/docs/plugins/preset-es2015/</a></span>) ;</p>
</li>
<li>
<p><code>preset-es2016</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2016/" class="bare">babeljs.io/docs/plugins/preset-es2016/</a></span>) ;</p>
</li>
<li>
<p><code>preset-es2017</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2017/" class="bare">babeljs.io/docs/plugins/preset-es2017/</a></span>) ;</p>
</li>
<li>
<p><code>preset-latest</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-latest/" class="bare">babeljs.io/docs/plugins/preset-latest/</a></span>) ;</p>
</li>
<li>
<p><code>preset-env</code> (<span class="URL"><a href="https://npmjs.com/babel-preset-env" class="bare">npmjs.com/babel-preset-env</a></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ils sont à placer dans un fichier de configuration nommé <code>.babelrc</code>.
L&#8217;exemple suivant illustre la <em>combinaison</em> de deux <em>presets</em> pour convertir la syntaxe <em>ECMAScript 2015</em> et <em>ECMAScript 2016</em> vers <em>ECMAScript 5</em> :</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre>{
  "presets": [
    "es2015",
    "es2016"
  ]
}</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Documentation de <em>babel</em></div>
<div class="paragraph">
<p>Toutes les options de configuration sont documentées sur le site officiel de <em>babel</em>.
Une autre page explique où placer et quoi mettre dans les fichiers <code>.babelrc</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://babeljs.io/docs/usage/api/#options" class="bare">babeljs.io/docs/usage/api/#options</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://babeljs.io/docs/usage/babelrc/" class="bare">babeljs.io/docs/usage/babelrc/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="polyfills">2.3. Combler les manques avec des <em>polyfills</em></h3>
<div class="paragraph">
<p>Des outils comme <em>babel</em> nous permettent d&#8217;écrire avec une <strong>syntaxe moderne</strong>.
Les <strong>polyfills</strong> sont des bouts de code qui nous permettent de <strong>combler les fonctionnalités manquantes</strong> – leur implémentation.</p>
</div>
<div class="paragraph">
<p>Un <strong>polyfill harmonise la présence d&#8217;une fonctionnalité</strong> au sein d&#8217;une variété de navigateurs web et d&#8217;environnements JavaScript.
Cela se fera au détriment de <strong>quelques kilo-octets de code</strong> à charger en plus dans nos applications.
L&#8217;appel à un service de polyfill externe entrainera un <strong>léger ralentissement du chargement</strong> de notre page.</p>
</div>
<div class="paragraph">
<p>Prenons le bloc de code suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

Promise.resolve('ok');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprenons que :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cette <strong>syntaxe est valide</strong> dans toutes les versions d'<em>ECMAScript</em> (<em>babel</em> ne changera rien à ce code) ;</p>
</li>
<li>
<p>l&#8217;objet global <code>Promise</code> existe dans un navigateur moderne ;</p>
</li>
<li>
<p>l&#8217;objet global <code>Promise</code> n&#8217;existe pas dans <em>Internet Explorer 11</em>, entre autres.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce code fonctionnerait donc sur un navigateur moderne mais pas dans <em>IE11</em>.
L&#8217;inclusion d&#8217;un <em>polyfill</em> de <code>Promise</code> résoudrait le problème.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Bonne pratique</span> Quand inclure les <em>polyfills</em> ?</div>
<div class="paragraph">
<p><strong>Un polyfill se charge toujours en premier</strong>.
On incluera tous les polyfills d&#8217;un coup <strong>avant notre propre code</strong>.</p>
</div>
<div class="paragraph">
<p>Nous garantissons ainsi une <strong>cohérence et stabilité de comportement</strong> au sein de notre application, peu importe l&#8217;ordre d&#8217;exécution de nos scripts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Parlons maintenant des méthodes d&#8217;inclusion des <em>polyfills</em> pour mieux comprendre comment procéder.</p>
</div>
<div class="paragraph">
<p>Le <strong>service polyfill.io</strong> est de loin la méthode la plus simple à utiliser.
Il suffit d&#8217;inclure un script dans toutes vos pages web.
<em>polyfill.io</em> déterminera les <em>polyfills</em> à charger en fonction de la compatibilité du navigateur chargeant la page :</p>
</div>
<div class="listingblock">
<div class="title">polyfill.io.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Example polyfill.io&lt;/title&gt;
    &lt;script src="https://cdn.polyfill.io/v2/polyfill.min.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script&gt;
      Promise.resolve('ok')
        .then(msg =&gt; console.log(msg));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> polyfill.io</div>
<div class="paragraph">
<p><em>polyfill.io</em> possède une documentation très complète.
Elle nous aidera à configurer finement le service en fonction de nos besoins.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://qa.polyfill.io/v2/docs/" class="bare">qa.polyfill.io/v2/docs/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous pouvons déduire <strong>deux règles</strong> de l&#8217;exemple précédent :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>inclure les <em>polyfills</em> en <strong>tout premier</strong> ;</p>
</li>
<li>
<p>inclure les <em>polyfills</em> <strong>en dehors</strong> de notre code.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La deuxième méthode est d'<strong>embarquer les polyfills</strong> dans notre base de code.
L&#8217;avantage est de maitriser notre base de code et de ne pas dépendre d&#8217;un service externe.
L&#8217;inconvénient est que nous chargeons du code qui sera inutile dans les navigateurs et environnements disposant déjà de ces fonctionnalités :</p>
</div>
<div class="listingblock">
<div class="title">polyfill-import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Exemple polyfill custom&lt;/title&gt;
    &lt;script type="module"&gt;
      import 'es6-promise/auto';        <i class="conum" data-value="1"></i><b>(1)</b>
      import 'core-js/fn/number/is-nan';<i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script&gt;
      Promise.resolve(Number.isNaN(NaN))
        .then(msg =&gt; console.log(msg));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous verrons <a href="#modules">comment importer des modules</a> ci-après ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On importe un deuxième <em>polyfill</em>, celui de la méthode <code>Number.isNaN</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le module <em>npm</em> <code>core-js</code> est une librairie exhaustive de <em>polyfills</em> pouvant être inclus un à un ou par versions d'<em>ECMAScript</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <code>core-js</code></div>
<div class="paragraph">
<p>La documentation en ligne de <code>core-js</code> liste l&#8217;ensemble des <em>polyfills</em> supportés par ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/core-js" class="bare">npmjs.com/core-js</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>babel</em> et son <em>preset</em> <code>babel-preset-env</code> nous facilitent l&#8217;inclusion de <em>polyfills</em> selon la compatibilité navigateurs que l&#8217;on souhaite maintenir au sein de notre application. Le fichier <code>.babelrc</code> suivant configure l&#8217;inclusion des <em>polyfills</em> à l&#8217;aide des clés <code>useBuiltIns</code> et <code>targets</code> :</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
  "comments": false,
  "presets": [
    "react",
    [
      "env", {
        "loose": true,
        "useBuiltIns": true,
        "targets": {
          "ie": 9,
          "browsers": [
            "&gt; 5%"
          ]
        }
      }
    ]
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette configuration illustre un souhait de compatibilité avec <em>Internet Explorer 9</em> et les navigateurs web disposant d&#8217;une part de marché supérieure à 5%.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Performance et duplication</div>
<div class="paragraph">
<p>Il faut veiller à ne pas alourdir inutilement une application.</p>
</div>
<div class="paragraph">
<p>Laissons la responsabilité de <em>polyfiller</em> aux utilisateurs de notre code ; particulièrement si celui-ci est <strong>redistribué</strong> en tant que module <em>npm</em> public.</p>
</div>
<div class="paragraph">
<p>Si plusieurs scripts nécessitent des polyfills, mieux vaut inclure ces derniers <em>en une fois</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script src="polyfills.js"&gt;&lt;/script&gt;
&lt;script src="script-a.js"&gt;&lt;/script&gt;
&lt;script src="script-b.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, une dernière méthode est d'<strong>importer la fonction de <em>polyfill</em> sans réécrire les objets globaux</strong>.
Cette pratique a l&#8217;avantage de <em>ne pas entrainer d&#8217;effets secondaires</em> et de garantir le <em>même comportement</em> dans tous les navigateurs web.
L&#8217;inconvénient est qu&#8217;on n&#8217;utilise pas la fonctionnalité native des navigateurs lorsqu&#8217;elle est présente.
Nous nous retrouvons tributaires de la qualité d&#8217;implémentation du <em>polyfill</em>.</p>
</div>
<div class="listingblock">
<div class="title">polyfill-require.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import {Promise as PromisePolyfill} from 'es6-promise';

PromisePolyfill.resolve('ok').then(msg =&gt; console.log(msg));

console.log('Promise' in window);                <i class="conum" data-value="1"></i><b>(1)</b>
console.log(PromisePolyfill === window.Promise); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>true</code> si le navigateur implémente l&#8217;API <em>Promise</em> – sinon affiche <code>false</code> et l&#8217;utilisation d&#8217;un <em>polyfill</em> prend tout son sens ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>false</code> car le <em>polyfill</em> de <em>Promise</em> est une function strictement différente de <code>window.Promise</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Bonnes pratiques constatées</div>
<div class="paragraph">
<p>De bons usages des <em>polyfills</em> ainsi les risques liés à leur utilisation sont compilés dans un guide édité par le W3C.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://w3ctag.github.io/polyfills/" class="bare">w3ctag.github.io/polyfills/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Importer des modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Importer des modules est une pratique courante avec Node.
Ça l&#8217;est en revanche beaucoup moins dans l&#8217;univers du web puisqu&#8217;il n&#8217;existait rien de <em>natif</em> avant les <a href="#modules-es2015">modules ECMAScript 2015</a>.</p>
</div>
<div class="paragraph">
<p>Auparavant, on aura vu débarquer les modules <em>AMD</em> (<em>Asynchronous Module Definition</em>) pour gérer les dépendances <em>entre scripts</em>.
Les librairies <em>Dojo</em>, <em>RequireJS</em> et <em>YUI</em> ont popularisé ce motif de conception.
Un désir d&#8217;universalité a ensuite émergé avec le gain de popularité croissant de Node avec les modules <em>UMD</em>, conciliant modules <em>AMD</em> et <em>CommonJS</em>.</p>
</div>
<div class="paragraph">
<p>Les modules <em>ECMAScript 2015</em> ont émergé de ce bouillonnement.</p>
</div>
<div class="sect2">
<h3 id="modules-script">3.1. La balise <code>&lt;script&gt;</code></h3>
<div class="paragraph">
<p>Rappelons-le, la méthode incontournable pour charger du code dans un navigateur web est l&#8217;utilisation de la base <code>&lt;script&gt;</code>.
Le chargement puis l&#8217;évaluation et l&#8217;exécution du script bloque le temps nécessaire le rendu d&#8217;un document HTML.</p>
</div>
<div class="listingblock">
<div class="title">import/script.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script src="global-dom-log.js"&gt;&lt;/script&gt;
&lt;script src="script.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les différents <em>scripts</em> partagent le même espace mémoire, permettant ainsi à <code>script.js</code> d&#8217;avoir accès à la fonction <code>log</code> définie dans <code>global-dom-log.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">import/global-dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// eslint-disable-next-line no-unused-vars
const log = (message) =&gt; {
  document.querySelector('#logs').textContent = String(message).trim();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">import/script.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/* global log */
window.addEventListener('load', () =&gt; {
  log('OK');<i class="conum" data-value="2"></i><b>(2)</b>
});

log('KO');  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche une erreur car <code>&lt;div id="logs"&gt;</code> n&#8217;existe pas encore dans le document à ce stade de l&#8217;exécution ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cette ligne est exécutée une fois le document chargé – <code>&lt;div id="logs"&gt;</code> contient désormais le texte <code>OK</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>S&#8217;il est facile d&#8217;ajouter du code dans le navigateur, on constate plusieurs problèmes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>partager du code entre scripts repose sur une <strong>attente explicite</strong> ;</p>
</li>
<li>
<p>le partage de variables entre scripts peut entrainer des <strong>collisions</strong> (par exemple, deux variables du même nom définies dans des scripts différents) ;</p>
</li>
<li>
<p>il n&#8217;y a pas de moyen évident de rendre des bouts de code <em>privé</em> au sein de chaque script.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le développement frontend basé sur de l&#8217;outillage Node va justement nous aider à <strong>solidifier et renforcer la réutilisabilité de notre code</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modules-es2015">3.2. Les modules <em>ECMAScript 2015</em></h3>
<div class="paragraph">
<p>Nous avons évoqué les <a href="../chapter-02/index.html#primitives">primitives <em>ECMAScript 2015</em></a> dans le Chapitre 2.
Les modules font partie des fonctionnalités tant attendues.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/module-import.png" alt="module import" width="85%">
</div>
<div class="title">Figure 1. Utilisation des modules <em>ECMAScript 2015</em> dans un navigateur web (ici, Safari pour macOS).</div>
</div>
<div class="paragraph">
<p>L&#8217;attribut <code>type="module"</code> a été introduit pour maintenir une compatibilité entre scripts classiques et les modules <em>ECMAScript 2015</em>.
Ce mécanisme de modules introduit plusieurs concepts importants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>toute variable est privée</strong> sauf si elle est <em>exportée</em> avec l&#8217;opérateur <code>export</code> ;</p>
</li>
<li>
<p>les <strong>modules sont explicitement inclus</strong> avec l&#8217;opérateur <code>import</code> ;</p>
</li>
<li>
<p>les <strong>variables globales</strong> définies par l&#8217;utilisateur ne sont pas accessibles depuis un module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retravaillons le document HTML de la section précédente :</p>
</div>
<div class="listingblock">
<div class="title">import/import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script&gt;const pro = 'test';&lt;/script&gt;
&lt;script type="module" src="script-import.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voulons maintenant (sa)voir si la variable <code>pro</code> définie avant l&#8217;inclusion du module <code>script-import.js</code> est constatée.
Nous voulons également savoir si la syntaxe d&#8217;import de la fonction <code>log</code> fonctionne :</p>
</div>
<div class="listingblock">
<div class="title">import/script-import.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import {log} from './dom-log.js';

console.log(typeof pro);    <i class="conum" data-value="1"></i><b>(1)</b>
console.log(typeof log);    <i class="conum" data-value="2"></i><b>(2)</b>
console.log(typeof window); <i class="conum" data-value="3"></i><b>(3)</b>

window.addEventListener('load', () =&gt; {
  log('OK');
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>undefined</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>function</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>object</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De même que nous avons utilisé <code>import</code> pour importer de manière sélective une fonction du module <code>dom-log.js</code>, l&#8217;opérateur <code>export</code> nous aide à exposer des objets, fonctions et variables :</p>
</div>
<div class="listingblock">
<div class="title">import/dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">export function log (message, target = '#logs') {
  document.querySelector(target).textContent = String(message).trim();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="browserify">3.3. Importer des modules <em>npm</em> pour le web</h3>
<div class="paragraph">
<p>Qu&#8217;en est-il alors des modules <em>npm</em> ?
Nous pouvons transpiler et importer du code, ce serait très utile si nous pouvions également importer du <em>code tiers</em>.
Cela nous éviterait de réinventer la roue, d&#8217;avoir accès à du code bien testé et trop coûteux à écrire nous-mêmes.</p>
</div>
<div class="paragraph">
<p>Nous avons vu comment <a href="../chapter-02/index.html#api-require">charger des modules <em>npm</em></a> dans le Chapitre 2.
Si seulement nous pouvions faire la même chose côté client…<br>
Continuons sur la lancée de nos exemples précédents pour tenter d&#8217;inclure la librairie <em>jQuery</em> afin de manipuler notre document HTML :</p>
</div>
<div class="listingblock">
<div class="title">import/script-import-jquery.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import $ from 'jquery';

console.log($.fn.jquery);  <i class="conum" data-value="1"></i><b>(1)</b>

$(document).ready(() =&gt; {
  $('#logs').text('OK');   <i class="conum" data-value="2"></i><b>(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>$.fn.jquery</code> contient le numéro de version de jQuery ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitut jQuery pour remplacer le texte dans <code>&lt;div id="logs"&gt;</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le document HTML chargeant ce module est en tout point similaire au précédent exemple :</p>
</div>
<div class="listingblock">
<div class="title">import/import-jquery.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script type="module" src="script-import-jquery.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le seul <em>hic</em>, c&#8217;est que <strong>cela ne fonctionne pas</strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le navigateur <em>ne peut pas savoir</em> où se trouve la dépendance demandée ;</p>
</li>
<li>
<p>rien ne garantit que <code>jquery</code> expose son code en tant que module <em>ECMAScript 2015</em> ;</p>
</li>
<li>
<p>on n&#8217;a certainement pas envie d&#8217;exposer publiquement le répertoire <code>node_modules</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est alors qu&#8217;entre en jeu <strong>browserify</strong>.
<em>browserify</em> est un outil générique de transformation de code.
Il peut être utilisé en ligne de commande, via son API Node mais aussi par le biais de plugins pour d&#8217;autres outils (comme Gulp, Grunt etc.).</p>
</div>
<div class="paragraph">
<p><em>browserify</em> a été initialement créé pour transformer du code écrit pour Node en code fonctionnel dans les navigateurs web.
Il expose notamment un concept d&#8217;intégrations (les <em>transforms</em>) afin d&#8217;effectuer des remplacements ligne à ligne.</p>
</div>
<div class="paragraph">
<p>Là où <em>babel</em> cherche uniquement à traduire un langage vers un autre, <em>browserify</em> est le couteau suisse pour effectuer des remplacements majeurs dans le code :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>portage de la fonction <code>require()</code> et inclusion du code des modules sous-jacents ;</p>
</li>
<li>
<p>suppression de code conditionnel ;</p>
</li>
<li>
<p>remplacement d&#8217;API spécifiques à Node par des polyfills pour le web ;</p>
</li>
<li>
<p>extraction de CSS ;</p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>browserify</em> est intéressant au sens où il nous apprend à nous constituer nous-mêmes notre outillage, pour nos propres besoins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser browserify</div>
<div class="paragraph">
<p><em>browserify</em> est un outil extrêmement versatile, modulaire et puissant.
Son apprentissage progressif peut faire de lui un allié de choix dans tous vos projets Node et web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/browserify" class="bare">npmjs.com/browserify</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://github.com/substack/browserify-handbook" class="bare">github.com/substack/browserify-handbook</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Revenons maintenant à notre code auquel il manque la compréhension des modules <em>npm</em>.
Nous allons maintenant chercher à transformer le fichier <code>script-import-jquery.js</code> pour à la fois rendre la syntaxe <code>import</code> intelligible  (c&#8217;est le rôle de <em>babel</em>) mais aussi pour faire le lien avec les modules <em>npm</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm run browserify -- \
  -t babelify \
  -e examples/import/script-import-jquery.js \
  -o examples/import/script-import-jquery-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande exécute trois choses :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>-t babelify</code> indique d&#8217;utiliser une intégration <em>babel</em> (un <em>transform</em>) pour transformer la syntaxe <em>ECMAScript 2015</em> ;</p>
</li>
<li>
<p><code>-e …</code> indique le script d&#8217;entrée à transformer ;</p>
</li>
<li>
<p><code>-o …</code> indique où stocker le script transformé.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il en résultera un fichier nommé <code>script-import-jquery-browserify.js</code> compatible <em>ECMAScript 5</em> et qui inclut désormais le code source de jQuery.<br>
Il ne nous reste plus qu&#8217;à charger le fichier transformé dans notre page web pour voir le résultat :</p>
</div>
<div class="listingblock">
<div class="title">import/import-jquery-browserify.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script src="script-import-jquery-browserify.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_récapitulatif">3.4. Récapitulatif</h3>
<div class="paragraph">
<p>En résumé, nous avons besoin de nous baser sur <em>deux ou trois outils</em> pour écrire un code modulaire et compatible avec n&#8217;importe quel type de syntaxe :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>babel</strong> pour transformer la syntaxe ;</p>
</li>
<li>
<p>des <strong>polyfills</strong> pour harmoniser les fonctionnalités ;</p>
</li>
<li>
<p><strong>browserify</strong> pour l&#8217;intégration avec les modules <em>npm</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ceux-ci ont l&#8217;avantage d&#8217;être <em>faciles</em> à prendre en main, <em>modulaires</em> et <em>évolutifs</em>.
Nous pourrons aussi nous tourner vers d&#8217;autres outils de transformation de code pour explorer d&#8217;autres horizons – et il en existe énormément : <em>webpack</em>, <em>rollup</em>, <em>broccoli</em> etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conception_modulaire">4. Conception modulaire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un autre paradigme change avec la mise à disposition des modules et de l&#8217;outillage à disposition : le code que l&#8217;on écrit dépend surtout d'<em>ECMAScript</em> et de l&#8217;environnement dans lequel on l&#8217;exécute, à savoir Node ou un navigateur web.</p>
</div>
<div class="paragraph">
<p>La section suivante s&#8217;intéresse à l'<strong>évolution de d&#8217;écriture du code</strong>, autrefois dirigée par la <strong>structure du document</strong> HTML vers un monde de <strong>fonctions consommant des données</strong>, transformées pour un type d&#8217;affichage, que ce soit HTML ou autre.</p>
</div>
<div class="paragraph">
<p>Nous illustrerons cette évolution au travers d&#8217;un exemple relativement simple : une balise HTML affichant l&#8217;heure dont nous actualisons le contenu toutes les secondes.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/modules-time.png" alt="modules time" width="85%">
</div>
<div class="title">Figure 2. Résultat de l&#8217;exemple développé dans les sections suivantes.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>jQuery</em></div>
<div class="paragraph">
<p>Les exemples suivants se basent sur l&#8217;utilisation de la librairie <em>jQuery</em>.
Elle facilite la manipulation du <em>DOM</em> tout en gérant les incompatibilités des différents navigateurs web.
Son utilisation est devenue moins dominante du fait d&#8217;une nette amélioration de la qualité de ces derniers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://api.jquery.com/" class="bare">api.jquery.com/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="http://learn.jquery.com/using-jquery-core/" class="bare">learn.jquery.com/using-jquery-core/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_le_syndrome_du_plugin_em_jquery_em">4.1. Le syndrome du plugin <em>jQuery</em></h3>
<div class="paragraph">
<p>Ce que j&#8217;appelle le "syndrome du plugin <em>jQuery</em>", c&#8217;est une combinaison des éléments suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>création de <strong>code métier inutilisable</strong> en dehors de <em>jQuery</em> ;</p>
</li>
<li>
<p><strong>mélange de la présentation</strong> des données et de l&#8217;organisation du code métier ;</p>
</li>
<li>
<p>un code <em>aveugle</em> car <strong>éloigné de la structure HTML</strong> nécessaire à son fonctionnement ;</p>
</li>
<li>
<p><strong>fragilité</strong> du code en cas de changement de la structure HTML associée ;</p>
</li>
<li>
<p>en général, un code <strong>difficilement testable</strong> – difficile de ne pas aboutir à une interface boguée.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voici un exemple de document HTML <em>fragile</em> et <em>mélangeant</em> tous les concepts en même temps.
Il est parfaitement valide mais illustre un ensemble de pratiques courantes que nous allons chercher à <em>désapprendre</em>.</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-plugin.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;time datetime="" data-interval="1000"&gt;---&lt;/time&gt;

  &lt;script src="../../node_modules/jquery/dist/jquery.js"&gt;&lt;/script&gt;
  &lt;script src="jquery-plugin.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que la structure HTML est définie, nous devons désormais écrire le code affichant l&#8217;heure dans un élément HTML toutes les secondes&#160;:</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-plugin.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/* global jQuery */

($ =&gt; {
  $.fn.displaySeconds = function displaySeconds() {
    this.each((i, dateElement) =&gt; {
      setInterval(() =&gt; {                  <i class="conum" data-value="1"></i><b>(1)</b>
        const now = new Date();            <i class="conum" data-value="2"></i><b>(2)</b>
        const seconds = now.getSeconds();

        $(dateElement)                     <i class="conum" data-value="3"></i><b>(3)</b>
          .removeClass(seconds % 2 ? 'pair': 'impair')
          .addClass(seconds % 2 ? 'impair': 'pair')
          .attr('datetime', now.toISOString())
          .text(now.toLocaleTimeString());
      }, $(dateElement).data('interval')); <i class="conum" data-value="4"></i><b>(4)</b>
    });

    return this;
  };

  $(document).ready(() =&gt; {      <i class="conum" data-value="5"></i><b>(5)</b>
    $('time').displaySeconds();  <i class="conum" data-value="6"></i><b>(6)</b>
  });
})(jQuery);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ce bloc de code est exécuté toutes les secondes ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La donnée de <em>temps</em> est obtenue chaque seconde par notre <em>plugin jQuery</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Certaines décisions métier sont mélangées avec l&#8217;affichage de la données <em>temps</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>L&#8217;intervalle est déterminé par la <em>valeur de l&#8217;attribut "data-interval"</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Ce bloc de code est exécuté dès que le document HTML est prêt — toute sa structure HTML est disponible ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Le <em>plugin jQuery</em> est appliqué à toutes les occurrences de <code>&lt;time&gt;</code> dans lequel le <em>plugin</em> est exécuté.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Certains motifs illustrés dans la section <a href="#modules">Importer des modules</a> refont surface :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>variables globales : que faire si <code>jQuery</code> n&#8217;existe pas ?</p>
</li>
<li>
<p>connaissance implicite du document : que faire si une personne tierce remplace la balise <code>&lt;time&gt;</code> par une autre balise ?</p>
</li>
<li>
<p>code JavaScript piloté par le document : que faire si une personne tierce exprime l&#8217;intervalle en secondes et non en millisecondes ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La faute n&#8217;est pas vraiment celle de <em>jQuery</em> mais plutôt la notre — enfin, la <em>mienne</em> <span class="icon"><i class="fa fa-smile-o"></i></span>.
Nous avons <strong>mélangé règles de fonctionnement</strong> (contenu de balise, classe CSS à ajouter/enlever) et données (date courante, parité des secondes, événement de mise à jour <code>setInterval</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_vers_une_approche_em_jquery_em_composite">4.2. Vers une approche <em>jQuery</em> composite</h3>
<div class="paragraph">
<p>Nous allons maintenant reprendre les concepts appris précédemment et conserver le même outil, à savoir <em>jQuery</em>.
Certains outils encouragent de bons <em>motifs de conception</em> et donnent la sensation de résoudre des problèmes.
Apprendre ces motifs et à capitaliser sur les outils que nous connaissons déjà peuvent nous emmener tout aussi loin.</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;time datetime=""&gt;---&lt;/time&gt;

  &lt;script src="jquery-app-browserify.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le changement majeur réside dans la réorganisation du code applicatif&#160;:</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import $ from 'jquery';
import timerFn from './timer.js';                              <i class="conum" data-value="4"></i><b>(4)</b>

const displaySeconds = (tickData, dateElement) =&gt; {            <i class="conum" data-value="5"></i><b>(5)</b>
  const {className, now} = tickData;

  $(dateElement)                                               <i class="conum" data-value="6"></i><b>(6)</b>
    .attr('class', className)
    .attr('datetime', now.toISOString())
    .text(now.toLocaleTimeString());
};

$(document).ready(() =&gt; {
  const dateElements = $('time').get();                        <i class="conum" data-value="1"></i><b>(1)</b>
  const onTick = tickData =&gt; {
    dateElements.forEach(el =&gt; displaySeconds(tickData, el));  <i class="conum" data-value="2"></i><b>(2)</b>
  };

  timerFn({ interval: 1000, onTick });                         <i class="conum" data-value="3"></i><b>(3)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous sélectionnons les éléments de la page à actualiser chaque seconde ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nous définissons quoi faire avec les données transmises chaque seconde ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Nous démarrons un minuteur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Le minuteur est une fonction externe, dont le comportement n&#8217;est pas régi par <em>jQuery</em> ou une autre librairie ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Cette fonction est responsable de l&#8217;affichage de <em>données</em> dans un <em>élément HTML</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Cette fois-ci, nous nous contentons de seulement mettre à jour attributs et contenus – la logique métier a été déplacée dans le module <code>timer.js</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le code a été divisé en deux sections distinctes :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>celui qui décrit la <strong>réaction à une donnée</strong> ;</p>
</li>
<li>
<p><strong>celui qui intègre</strong> le minuteur avec les éléments du <em>DOM</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas réellement besoin de savoir comment fonctionne le minuteur à ce niveau – nous avons juste besoin de pouvoir compter sur les données qu&#8217;il nous fournit.</p>
</div>
<div class="listingblock">
<div class="title">modules/timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const tick = () =&gt; {              <i class="conum" data-value="1"></i><b>(1)</b>
  const now = new Date;

  return {                        <i class="conum" data-value="2"></i><b>(2)</b>
    now,
    className: now.getSeconds() % 2 ? 'impair': 'pair'
  }
};

module.exports = function timer ({ onTick, interval }) {  <i class="conum" data-value="3"></i><b>(3)</b>
  setInterval(() =&gt; onTick(tick()), interval);            <i class="conum" data-value="4"></i><b>(4)</b>

  return tick();                  <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cette fonction (privée) est responsable de décrire le <em>temps présent</em> sous forme d&#8217;une <strong>structure de données</strong> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cette <em>structure de données</em> pourra retourner de nouvelles clés/valeurs sans remettre en cause le fonctionnement du code y ayant recours ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le paramètre <code>onTick</code> est une fonction passée en argument qui sera appelée à chaque nouvel intervalle de temps ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>La responsabilité de <code>timer</code> est de communiquer une nouvelle <em>structure de données</em> à un intervalle de temps donné ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>On retourne immédiatement une structure de données par commodité et de manière synchrone.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour un résultat identique, nous avons désormais séparé notre code en trois <strong>domaines distincts</strong> : le <em>minuteur</em>, l'<em>intégration</em> du minuteur, la <em>représentation</em> du minuteur sous forme HTML.
Cerise sur le gâteau, cette <em>distinction se constate visuellement</em>, au premier coup d&#8217;œil.</p>
</div>
<div class="paragraph">
<p>Tout n&#8217;est pas parfait car nous sommes encore lié à la structure du document HTML.</p>
</div>
</div>
<div class="sect2">
<h3 id="_partager_le_code_métier_avec_node">4.3. Partager le code métier avec Node</h3>
<div class="paragraph">
<p>Cette <em>séparation de principes</em> (<em>separation of concerns</em>) va au-delà du plaisir de l&#8217;esthète.
Nous venons sans le savoir de créer du <strong>code <em>ECMAScript</em> universel</strong>.</p>
</div>
<div class="paragraph">
<p>Pourquoi <em>universel</em> ?
Parce que nous pouvons tout aussi bien l&#8217;inclure et l&#8217;exécuter dans Node que dans un navigateur web :</p>
</div>
<div class="listingblock">
<div class="title">modules/node-timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const timerFn = require('./timer.js');

timerFn({ interval: 1000, onTick: console.log });</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécution du script <code>node-timer.js</code> afficherait quelque chose du genre dans votre terminal :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node examples/modules/node-timer.js
{ now: 2017-02-17T11:07:29.752Z, className: 'impair' }
{ now: 2017-02-17T11:07:30.762Z, className: 'pair' }
{ now: 2017-02-17T11:07:31.768Z, className: 'impair' }
{ now: 2017-02-17T11:07:32.770Z, className: 'pair' }
{ now: 2017-02-17T11:07:33.775Z, className: 'impair' }
{ now: 2017-02-17T11:07:34.779Z, className: 'pair' }
^C</pre>
</div>
</div>
<div class="paragraph">
<p>Chaque seconde, la fonction <code>console.log</code> est appelée et affiche la <em>structure de données</em> de notre minuteur dans la <em>sortie standard</em> du terminal.</p>
</div>
<div class="paragraph">
<p>Nous pourrions dès à présent utiliser le minuteur dans d&#8217;autres applications, côté client, côté serveur et pourquoi pas un jour, le publier sur le <em>registre npm</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_séparation_du_fond_et_de_la_forme_données_rendu_et_interactions">4.4. Séparation du fond et de la forme : données, rendu et interactions</h3>
<div class="paragraph">
<p>Les praticien·ne·s de l&#8217;intégration web nous le dirons souvent : il faut <strong>séparer le fond de la forme</strong>.
Il en est de même dans notre code – et pas que pour le développement <em>frontend</em>.</p>
</div>
<div class="paragraph">
<p>Un code maintenable n&#8217;a pas besoin d&#8217;être complexe.
Un code maintenable a surtout besoin de bien <em>isoler</em> ses périmètres d&#8217;intervention.</p>
</div>
<div class="paragraph">
<p>Les exemples précédents nous ont permis de déceler trois périmètres phares :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>données</strong> : des structures prédictibles, obtenues ou modifiées ;</p>
</li>
<li>
<p><strong>rendu</strong> : la représentation des données en <em>contexte</em>, que ce soit une page HTML, un terminal ou un fichier CSV ;</p>
</li>
<li>
<p><strong>interactions</strong> : des événements déclenchés par les utilisateurs, par des facteurs externes ou des règles métier – ils impactent les <em>données</em> et leur <em>représentation</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="react">4.5. Rapprocher données, rendu et interactions avec <em>React</em></h3>
<div class="paragraph">
<p><em>React</em> a atteint un pic de popularité certain en 2015 et 2016.
Pas seulement parce qu&#8217;il s&#8217;agit d&#8217;un outil bien conçu mais justement parce qu&#8217;il encourage cette pratique de la <strong>représentation des données</strong>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> API React</div>
<div class="paragraph">
<p>Les exemples suivants se basent sur la librairie <em>React</em>.
Sa documentation offre de bons exemples pour se familiariser avec son utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://facebook.github.io/react/" class="bare">facebook.github.io/react/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://facebook.github.io/react/docs/thinking-in-react.html" class="bare">facebook.github.io/react/docs/thinking-in-react.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notre code HTML n&#8217;est qu&#8217;un <strong>résultat</strong> exposant des <strong>surfaces d&#8217;interaction</strong>.
Notre code se structure en <strong>composants</strong>.
Un <em>composant</em> est responsable de deux choses : la <strong>représentation de données</strong> et la <strong>réaction à des événements</strong>.</p>
</div>
<div class="paragraph">
<p>Cela se traduira par un changement de taille : l&#8217;exemple que nous avons fait évoluer ne fait plus mention de balise <code>&lt;time&gt;</code> mais expose une balise dédiée à contenir notre <em>composant minuteur</em> :</p>
</div>
<div class="listingblock">
<div class="title">modules/react-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;div id="app"&gt;&lt;/div&gt;

  &lt;script src="react-app-browserify.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre code applicatif est réduit à son plus strict minimum :</p>
</div>
<div class="listingblock">
<div class="title">modules/react-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import { createElement } from 'react';
import ReactDOM from 'react-dom';
import DateInterval from './date-interval.jsx';

ReactDOM.render(                                  <i class="conum" data-value="1"></i><b>(1)</b>
  createElement(DateInterval, {interval: 1000}),  <i class="conum" data-value="2"></i><b>(2)</b>
  document.querySelector('#app')                  <i class="conum" data-value="3"></i><b>(3)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Méthode responsable du rendu HTML de notre composant <code>TimeInterval</code> dans l&#8217;élément <code>&lt;div id="app"&gt;</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Création de notre composant minuteur avec un intervalle de mise à jour de 1000 millisecondes ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Indication que le rendu du composant sera effectué <em>dans</em> l&#8217;élément <code>&lt;div id="app"&gt;</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cela ressemble fortement au contenu de nos précédentes invocations de <code>$(document).ready()</code> mais sans avoir à se soucier du fonctionnement interne du minuteur.</p>
</div>
<div class="paragraph">
<p>La représentation et le fonctionnement du minuteur sont désormais regroupés dans un seul composant :</p>
</div>
<div class="listingblock">
<div class="title">modules/date-interval.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx">import React, { Component } from 'react';
import timerFn from './timer.js';

export default class DateInterval extends Component {        <i class="conum" data-value="1"></i><b>(1)</b>
  constructor(props) {                                       <i class="conum" data-value="2"></i><b>(2)</b>
    super(props);

    const {interval} = props;
    this.onTick = this.onTick.bind(this);

    this.state = {
      tickData: timerFn({ interval, onTick: this.onTick })   <i class="conum" data-value="3"></i><b>(3)</b>
    };
  }

  onTick (tickData) {
    this.setState({ tickData });                   <i class="conum" data-value="4"></i><b>(4)</b>
  }

  render() {                                       <i class="conum" data-value="5"></i><b>(5)</b>
    const {className, now} = this.state.tickData;  <i class="conum" data-value="6"></i><b>(6)</b>

    return (&lt;time className={className} dateTime={now.toISOString()}&gt;
      {now.toLocaleTimeString()}
    &lt;/time&gt;);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous exportons un composant <em>React</em> grâce à l&#8217;opérateur <em>ECMAScript 2015</em> <code>extends</code> – cf. la <a href="../chapter-02/index.html#primitive-class">section Class du Chapitre 2</a> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le <code>constructor</code> est exécuté quand le composant est rendu dans le document ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La propriété <code>interval</code> nous est fournie dans <code>react-app.js</code> et nous stockons la <em>structure de donnée</em> retournée par le minuteur tout en déclenchant son actualisation toutes les 1000 millisecondes ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>À chaque intervalle, nous mettons à jour la valeur <code>tickData</code> de l&#8217;état interne du composant (<code>this.state</code>) ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>La méthode <code>render()</code> est exécutée quand le composant est inséré dans un document pour la première fois et dès que l&#8217;état interne (<code>this.state</code>) change ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Nous déstructurons la valeur connue de <code>tickData</code> pour effectuer une opération qui nous rappelle les différents appels à <code>.attr('class')</code> et <code>.text()</code> de <em>jQuery</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>React</em> introduit quatre concepts au sein des composants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un <strong>cycle de vie</strong> basé sur des <em>propriétés</em> (<em>props</em>) et un <em>état interne</em> (<em>state</em>) ;</p>
</li>
<li>
<p>des <strong>propriétés immutables</strong> pour le paramétrage initial ;</p>
</li>
<li>
<p>un <strong>état interne mutable</strong> pour contenir les changements et demander une actualisation de leur représentation dans le document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>React</em> détermine les opérations à effectuer dans le document HTML en fonction de la lourdeur des opérations : (re)création complète de <code>&lt;time&gt;</code> dans le nœud parent, simple mise à jour d&#8217;un ou ou plusieurs attributs ou encore déplacement du composant ailleurs dans le document HTML etc.</p>
</div>
<div class="paragraph">
<p>L&#8217;intelligence d&#8217;une librairie comme <em>React</em> est d&#8217;encourager à décrire les données et leur rendu pour se charger des opérations d&#8217;écriture dans le DOM.
Cela permet de créer des composants faciles à isoler, à réutiliser et à tester.</p>
</div>
<div class="paragraph">
<p>Cette approche nous a permis de réutiliser notre minuteur simplement en adaptant son utilisation.
<em>React</em> nous permet de <strong>diriger l&#8217;affichage</strong> du document plutôt que d&#8217;en dépendre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outil</span> React Developer Tools</div>
<div class="paragraph">
<p>Cette extension pour le navigateur Chrome détaille l&#8217;arborescence des composants montés dans le document HTML ainsi qu&#8217;une vue de leurs propriétés respectives.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/react-devtools.png" alt="react devtools" width="85%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi" class="bare">chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="io">5. Des requêtes AJAX au temps-réel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les technologies web offrent un panel de fonctionnalités créatives et versatiles.
Le boom du <em>Web 2.0</em> a coïncidé avec la redécouverte de <code>XMLHttpRequest</code>, une API initialement créée par Microsoft pour <strong>transférer des données entre client et serveur</strong>, de <em>manière non-bloquante</em>.
Cette fonctionnalité a permis de basculer vers un monde de pages dynamiques et rapides à charger.
Des applications web comme Google Maps, Gmail ou la recherche instantanée de Google ont parachevé la popularisation de cette technique.</p>
</div>
<div class="paragraph">
<p>Toutefois son API est peu intuitive et est unidirectionnelle, dirigée <strong>du client vers le serveur</strong>.
Le terme <code>XMLHttpRequest</code> est parfois nommé <code>AJAX</code> ou <code>xhr</code>.</p>
</div>
<div class="paragraph">
<p>Un même exemple côté client sera développé et successivement adapté aux technologies <code>fetch()</code>, <em>EventSource</em> puis <em>WebSocket</em>.
Il nous permettra d&#8217;en faire émerger les principes, leurs cas d&#8217;usage ainsi que leur possible intégration avec Node.<br>
L&#8217;implémentation côté serveur est basée sur un serveur <a href="../chapter-03/index.html#express">Express.js</a> dont l&#8217;usage est expliqué au chapitre 3.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/io-example.png" alt="io example" width="85%">
</div>
<div class="title">Figure 3. Résultat attendu dans les exemples des sections suivantes.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Node, mais pas que.</div>
<div class="paragraph">
<p><code>fetch()</code>, <em>EventSource</em> et <em>WebSocket</em> reposent sur le protocole HTTP/1 et ses extensions.
Il est important de comprendre que leur contrepartie "côté serveur" existe aussi dans d&#8217;autres langages et environnements comme Ruby, Python et PHP.</p>
</div>
<div class="paragraph">
<p>Il se trouve que la nature asynchrone même de Node rend cette intégration relativement aisée et triviale, aussi et en grande partie grâce à l&#8217;écosystème <em>npm</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="io-fetch">5.1. Échange ponctuel de données avec <code>fetch()</code></h3>
<div class="paragraph">
<p><code>fetch()</code> offre une interface très simple pour appeler une ressource HTTP.
Le résultat est retourné sous forme de <em>promesse</em> (voir la <a href="../chapter-02/index.html#primitive-promise">section <em>Promise</em></a> du Chapitre 2).
Cette fonction sert aussi bien à obtenir des ressources avec des requêtes de type <code>GET</code> et <code>HEAD</code> qu&#8217;à en créer et modifier avec des requêtes de type <code>POST</code>, <code>PUT</code>, <code>DELETE</code> et <code>PATCH</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/fetch.html" class="bare">localhost:4000/examples/io/fetch.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <code>fetch()</code> sur <span class="URL"><a href="http://caniuse.com#feat=fetch" class="bare">caniuse.com#feat=fetch</a></span>.</p>
</div>
<div class="paragraph">
<p>Le déroulé d&#8217;exécution d&#8217;un appel à <code>fetch()</code> est le suivant :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>construction de la <strong>requête</strong> (<em>URL</em> ou objet <code>Request</code>, options) ;</p>
</li>
<li>
<p><strong>réception</strong> des entêtes de la <em>réponse</em> (objet <code>Response</code>) ;</p>
</li>
<li>
<p><strong>décodage</strong> de la <em>réponse</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Plusieurs <em>décodeurs de réponse</em> sont fournis nativement : texte (<code>response.text()</code>), JSON (<code>response.json()</code>), ArrayBuffer (<code>response.arrayBuffer()</code>), Blob (<code>response.blob()</code>) et FormData (<code>response.formData()</code>).</p>
</div>
<div class="listingblock">
<div class="title">io/fetch-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const userList = document.querySelector('#user-list');

setInterval(() =&gt; {
  fetch('/new-users')                    <i class="conum" data-value="1"></i><b>(1)</b>
    .then(response =&gt; response.text())   <i class="conum" data-value="2"></i><b>(2)</b>
    .then(data =&gt; {                      <i class="conum" data-value="3"></i><b>(3)</b>
      const li = document.createElement('li');
      li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

      userList.prepend(li);
    })
}, 2000);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exécution de la requête HTTP <em>GET</em> vers <code>/new-users</code> depuis le navigateur web courant ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Décodage progressif de la réponse ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Une fois le décodage terminé, le résultat de la requête HTTP est mis à disposition – ici, sous forme de chaîne de caractères.</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/fetch-frames.png" alt="fetch frames" width="85%">
</div>
<div class="title">Figure 4. Traces réseau d&#8217;appels successifs à <code>fetch()</code> ; chacun résultant en une nouvelle requête HTTP.</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation d&#8217;une ressource HTTP côté serveur s&#8217;effectue simplement en retournant une <em>réponse</em> lors d&#8217;une <em>requête</em> HTTP :</p>
</div>
<div class="listingblock">
<div class="title">io/fetch-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const chance = require('chance').Chance();

module.exports = (app) =&gt; {
  app.get('/new-users', (req, res) =&gt; {
    res.send(chance.name());
  });
};</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Collection d&#8217;exemples</div>
<div class="paragraph">
<p>Le guide communautaire <em>MDN</em> met à disposition une dizaine d&#8217;exemples pour illustrer différents cas d&#8217;utilisation de <code>fetch()</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/mdn/fetch-examples" class="bare">github.com/mdn/fetch-examples</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En <em>résumé</em>, <code>fetch()</code> est idéal pour des demandes ponctuelles de données, du client vers le serveur.
Le module <em>npm</em> <code>node-fetch</code> (<span class="URL"><a href="https://npmjs.com/node-fetch" class="bare">npmjs.com/node-fetch</a></span>) est une implémentation de <code>fetch()</code> pour Node tandis que <code>whatwg-fetch</code> (<span class="URL"><a href="https://npmjs.com/whatwg-fetch" class="bare">npmjs.com/whatwg-fetch</a></span>) s&#8217;adresse uniquement à polyfiller les navigateurs web.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-eventsource">5.2. Approche unidirectionnelle avec <em>EventSource</em></h3>
<div class="paragraph">
<p><em>EventSource</em> est un mécanisme moins connu que <code>fetch()</code> ou <em>WebSocket</em> mais tire ses origines de la technologie <em>Comet</em>.
On peut l&#8217;assimiler à une inversion de <code>fetch()</code> : le client appelle une ressource serveur, maintient une connexion de longue durée et attend un ou plusieurs <em>messages</em> dudit serveur.</p>
</div>
<div class="paragraph">
<p>Chaque connexion est ouverte en faisant appel à la construction d&#8217;un objet <code>EventSource</code>.
Cet objet émet alors plusieurs types d&#8217;événements en fonction des actions :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>open</code> : lorsque le client a effectué une connexion au serveur ;</p>
</li>
<li>
<p><code>message</code> : lorsque le serveur émet des données à destination du client ;</p>
</li>
<li>
<p><code>close</code> : lorsque la connexion est fermée par le serveur ;</p>
</li>
<li>
<p><code>error</code> : lorsque la connexion est accidentellement interrompue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce modèle de connexion permet tout aussi bien d&#8217;avoir un canal de données unique avec chaque utilisateur ou encore d&#8217;émettre les mêmes données en temps réel à destination de tous les usagers.</p>
</div>
<div class="paragraph">
<p>L’exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/eventsource.html" class="bare">localhost:4000/examples/io/eventsource.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <em>EventSource</em> sur <span class="URL"><a href="http://caniuse.com#feat=eventsource" class="bare">caniuse.com#feat=eventsource</a></span>.</p>
</div>
<div class="listingblock">
<div class="title">io/eventsource-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const connection = new EventSource('/new-users');      <i class="conum" data-value="1"></i><b>(1)</b>
const userList = document.querySelector('#user-list');

connection.addEventListener('message', ({data}) =&gt; {   <i class="conum" data-value="2"></i><b>(2)</b>
  const li = document.createElement('li');
  li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

  userList.prepend(li);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous ouvrons une nouvelle connexion <em>Event Source</em> de longue durée depuis le navigateur web courant ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Fonction appelée à chaque fois que le serveur transmet un message au client.</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/eventsource-frames.png" alt="eventsource frames" width="85%">
</div>
<div class="title">Figure 5. Plusieurs messages peuvent être transmis par le biais d&#8217;une seule connexion HTTP avec <em>EventSource</em>.</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation d'<em>EventSource</em> demande un peu d&#8217;efforts côté serveur mais ne nécessite pas de <em>framework</em> particulier.
La complexité réside dans le maintien d&#8217;une transmission de données dédiée à chaque client ainsi qu&#8217;à la libération de la connexion lorsque le client se déconnecte.</p>
</div>
<div class="listingblock">
<div class="title">io/eventsource-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const WebSocket = require('faye-websocket');
const {EventSource} = WebSocket;

const chance = require('chance').Chance();

module.exports = (app) =&gt; {
  app.get('/new-users', (req, res, next) =&gt; {
    if (!EventSource.isEventSource(req)) {      <i class="conum" data-value="1"></i><b>(1)</b>
      return next();
    }

    let es = new EventSource(req, res);         <i class="conum" data-value="2"></i><b>(2)</b>
    const loop = setInterval(() =&gt; {
      es.send(chance.name());                   <i class="conum" data-value="3"></i><b>(3)</b>
    }, 2000);

    es.on('close', () =&gt; {
      clearInterval(loop);
      es = null;
      next();
    });
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Une connexion <em>EventSource</em> s&#8217;effectue (presque) comme une requête HTTP classique – il convient de vérifier qu&#8217;elle s&#8217;annonce en tant que telle ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Création d&#8217;un canal unique entre le client et le serveur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Chaque appel à <code>es.send</code> enverra un nouveau message au client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le serveur est responsable de la gestion des connexions demandées par les différents clients.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser <em>EventSource</em></div>
<div class="paragraph">
<p>Les liens suivants détaillent le protocole <em>EventSource</em>, documentent son API et décrivent des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://html.spec.whatwg.org/#server-sent-events" class="bare">html.spec.whatwg.org/#server-sent-events</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Server-sent_events/Using_server-sent_events" class="bare">developer.mozilla.org/fr/docs/Server-sent_events/Using_server-sent_events</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <em>EventSource</em> est idéal pour maintenir une connexion avec le serveur et souscrire à des mises à jour en continu.
Chaque connexion <em>EventSource</em> devrait concerner qu&#8217;un seul et même type d&#8217;événement.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-websocket">5.3. Échanges en temps-réel avec <em>WebSocket</em></h3>
<div class="paragraph">
<p><em>WebSocket</em> est une technologie web favorisant les échanges bi-directionnels entre client et serveur.</p>
</div>
<div class="paragraph">
<p>À l&#8217;inverse du protocole HTTP/1, tout message envoyé par le client ou par le serveur n&#8217;appelle pas à une réponse de la part du receveur.
Cet élément ainsi que le maintien d&#8217;une connexion permanente expliquent la rapidité du protocole en comparaison avec le modèle requête/réponse.</p>
</div>
<div class="paragraph">
<p>L’exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/websocket.html" class="bare">localhost:4000/examples/io/websocket.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <em>WebSocket</em> sur <span class="URL"><a href="http://caniuse.com#feat=websocket" class="bare">caniuse.com#feat=websocket</a></span>.</p>
</div>
<div class="listingblock">
<div class="title">io/websocket-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">let ws = new WebSocket('ws://localhost:4000/users');    <i class="conum" data-value="1"></i><b>(1)</b>
const userList = document.querySelector('#user-list');
let interval;

ws.addEventListener('open', () =&gt; {
  interval = setInterval(() =&gt; {
    ws.send(JSON.stringify({ action: 'getName' }));     <i class="conum" data-value="2"></i><b>(2)</b>
  }, 2000);
});

ws.addEventListener('message', ({data}) =&gt; {            <i class="conum" data-value="3"></i><b>(3)</b>
  const li = document.createElement('li');
  li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

  userList.prepend(li);
});

ws.addEventListener('close', () =&gt; {
  ws = null;
  clearInterval(interval);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous ouvrons une connexion <em>WebSocket</em> depuis le navigateur web courant ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Émission d&#8217;un message à destination du serveur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Réaction à un message émis par le serveur.</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/websocket-frames.png" alt="websocket frames" width="85%">
</div>
<div class="title">Figure 6. Trame de messages envoyés par le client (sur fond vert) et par le serveur.</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation côté serveur est légèrement plus compliquée qu&#8217;avec <em>EventSource</em> pour la simple et bonne raison que <em>Websocket</em> est une surcouche du protocole <code>ws</code>.
HTTP n&#8217;est utilisé que comme canal de communication pour établir un lien avec le serveur <code>ws</code>.
HTTP sert de tunnel tandis que le dialogue entre client et serveur s&#8217;effectue dans un dialecte compréhensible uniquement de clients <em>WebSocket</em>.</p>
</div>
<div class="paragraph">
<p>Il est nécessaire d&#8217;utiliser un module <em>npm</em> <em>WebSocket</em> comme <em>faye</em> (<span class="URL"><a href="https://npmjs.com/faye-websocket" class="bare">npmjs.com/faye-websocket</a></span>) ou <em>socket.io</em> (<span class="URL"><a href="https://npmjs.com/socket.io" class="bare">npmjs.com/socket.io</a></span>) à moins de vouloir réimplémenter le protocole soi-même.
Le motif de conception est similaire à <em>EventSource</em>, à la différence près qu&#8217;il faut aussi écouter les messages transmis par le client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> HTTP et le statut <code>101 Switching Protocols</code></div>
<div class="paragraph">
<p>Voici ce qui se passe lorsqu&#8217;un client <em>WebSocket</em> se connecte sur <code>ws://example.com</code> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>requête HTTP <code><a href="http://example.com" class="bare">example.com</a></code> standard contenant les entêtes <code>Upgrade: websocket</code> et <code>Connection: Upgrade</code> ;</p>
</li>
<li>
<p>le serveur HTTP répond avec un statut <code>101 Switching Protocols</code> ;</p>
</li>
<li>
<p>le serveur <em>WebSocket</em> prend le relais dans le dialogue client/serveur ;</p>
</li>
<li>
<p>client et serveur communiquent désormais via le protocole <code>ws</code> au sein de la connexion HTTP initiale.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Par extension et de par la nature même du protocole <code>ws</code>, il serait tout à fait possible que <em>et</em> clients <em>et</em> serveur soient des agents Node.
Autrement dit, un client <em>WebSocket</em> n&#8217;a pas nécessairement à être un navigateur web.</p>
</div>
<div class="listingblock">
<div class="title">io/websocket-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const WebSocket = require('faye-websocket');
const chance = require('chance').Chance();

module.exports = (server) =&gt; {
  server.on('upgrade', (req, socket, body, next) =&gt; {  <i class="conum" data-value="1"></i><b>(1)</b>
    if (!WebSocket.isWebSocket(req)) {           <i class="conum" data-value="2"></i><b>(2)</b>
      return next();
    }

    let ws = new WebSocket(req, socket, body);   <i class="conum" data-value="3"></i><b>(3)</b>

    ws.on('message', event =&gt; {                  <i class="conum" data-value="4"></i><b>(4)</b>
      const data = JSON.parse(event.data);

      if (data.action === 'getName') {
        ws.send(chance.name());                  <i class="conum" data-value="5"></i><b>(5)</b>
      }
    });

    ws.on('close', () =&gt; {
      ws = null;
    });
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le serveur HTTP vient de répondre avec un statut <code>101 Switching Protocols</code> et délègue désormais la responsabilité du dialogue client/serveur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nous vérifions que le changement de protocole concerne le protocole <code>ws</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La connexion réseau (<code>socket</code>) est transmise au serveur <em>WebSocket</em> pour amorcer le dialogue client/serveur avec le protocole <code>ws</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Réaction à la réception d&#8217;un message client ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Émission d&#8217;un message à destination d&#8217;un client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Là aussi, le serveur est responsable de la gestion des connexions demandées par les différents clients.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser <em>WebSocket</em></div>
<div class="paragraph">
<p>Les liens suivants détaillent le protocole <em>WebSocket</em>, documentent son API et décrivent des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://html.spec.whatwg.org/#network" class="bare">html.spec.whatwg.org/#network</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/WebSockets/Writing_WebSocket_client_applications" class="bare">developer.mozilla.org/fr/docs/WebSockets/Writing_WebSocket_client_applications</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <em>WebSocket</em> est idéal pour maintenir une connexion en temps-réel et pour relayer plusieurs messages à l&#8217;initiative du serveur serveur et de tout client connecté – qu&#8217;il s&#8217;agisse d&#8217;un navigateur web ou d&#8217;un agent Node.
Chaque connexion <em>WebSocket</em> peut encapsuler plusieurs types de messages.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_développer_au_quotidien">6. Développer au quotidien</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons beaucoup parlé de nouvelles techniques et de modularisation.
Cela peut sembler rebutant, notamment par l&#8217;introduction d&#8217;outils auxquels nous ne sommes pas encore familiers.</p>
</div>
<div class="paragraph">
<p>L&#8217;écosystème Node fournit énormément d&#8217;outils qui devraient nous faire du <strong>gagner du temps</strong>, en nous aidant à exécuter des actions <strong>lorsqu&#8217;un fichier est modifié</strong>, en nous aidant à <strong>organiser notre travail</strong> mais aussi en <strong>actualisant automatiquement notre application web</strong> au fil du développement (fini les appuis répétés sur la touche <kbd>F5</kbd>) ou encore en <strong>optimisant nos fichiers graphiques</strong>.</p>
</div>
<div class="sect2">
<h3 id="watchify">6.1. Reconstruire en continu avec <code>watchify</code></h3>
<div class="paragraph">
<p>L&#8217;utilisation de <a href="#browserify">browserify</a> nous apporte le confort de pouvoir inclure des modules <em>npm</em> dans les navigateurs web.
En revanche, ça nous demande de générer des artéfacts – des <em>bundles</em> – à chaque modification pour consolider ces changements.</p>
</div>
<div class="paragraph">
<p>C&#8217;est à ce moment qu&#8217;intervient le module <em>watchify</em> (<span class="URL"><a href="https://npmjs.com/watchify" class="bare">npmjs.com/watchify</a></span>).
Il fonctionnement <strong>exactement comme <em>browserify</em></strong> mais au lieu de compiler une seule fois, il compilera dès qu&#8217;un changement sera détecté – où que ce soit dans l&#8217;arbre de dépendances du point d&#8217;entrée (paramètre <code>-e</code>, <code>--entrypoint</code>).</p>
</div>
<div class="paragraph">
<p>La commande suivante compilerait le fichier <code>examples/modules/react-app.js</code> une fois et une seule :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/browserify -t babelify -e examples/modules/react-app.js -o examples/modules/react-app-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit de remplacer <code>browserify</code> par <code>watchify</code> – le programme garde la main et indique chaque nouvelle compilation sur une nouvelle ligne :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/watchify -dv -t babelify -e examples/modules/react-app.js -o examples/modules/react-app-browserify.js
1840601 bytes written to examples/modules/react-app-browserify.js (2.58 seconds) at 4:44:28 PM
352482 bytes written to examples/modules/react-app-browserify.js (0.10 seconds) at 4:45:09 PM
1840605 bytes written to examples/modules/react-app-browserify.js (0.25 seconds) at 4:45:15 PM</pre>
</div>
</div>
<div class="paragraph">
<p><em>watchify</em> utilise un mécanisme dit de <strong>compilation incrémentale</strong> : <em>watchify</em> ne recompile pas tout mais uniquement les différences depuis le dernier changement.
C&#8217;est beaucoup plus rapide et tout aussi efficace.</p>
</div>
<div class="paragraph">
<p>Trois arguments sont utiles à <em>watchify</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-v</code> (<code>--verbose</code>) : force la création du fichier compilé au lancement de la commande ;</p>
</li>
<li>
<p><code>-o</code> (<code>--outfile</code>) : spécifie le chemin d&#8217;enregistrement du fichier compilé – il est impossible d&#8217;utiliser la <a href="../chapter-02/index.html#stdio">sortie standard</a> (cf. Chapitre 2) ;</p>
</li>
<li>
<p><code>-d</code> (<code>--debug</code>) : (lire <a href="#browserify-sourcemaps"><em>Source Maps</em></a> dans ce même chapitre).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="livereload">6.2. Changements en temps-réel dans le navigateur</h3>
<div class="paragraph">
<p>Modifier un fichier. Changer de fenêtre. Recharger. Changer de fenêtre. Remodifier un fichier. Changer de fenêtre. Recharger. <em>Là</em> c&#8217;est bon.<br>
La quantité d&#8217;outils à disposition et leurs différentes opinions sur notre manière de travailler nous obligent à prendre des postures de travail qui ne vont <strong>pas nécessairement dans le sens de la productivité</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;intégration de Node avec le système d&#8217;exploitation va nous aider à déclencher des actions lorsqu&#8217;un ou plusieurs fichiers sont modifiés.
Ces modifications peuvent être de notre fait, directement ou par le biais d&#8217;un autre logiciel (un optimiseur d&#8217;images ou la <a href="#node-sass">compilation d&#8217;un fichier <em>Sass</em></a> par exemple).</p>
</div>
<div class="paragraph">
<p>Nous allons explorer <em>deux stratégies</em> d&#8217;actualisation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le <strong>rafraichissement automatique du navigateur</strong> ;</p>
</li>
<li>
<p>le <strong>remplacement de modules à chaud</strong> (<em>Hot Module Replacement</em>, <em>HMR</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>browser-sync</em> est un outil formidable de développement pour <strong>rafraichir automatiquement une page web</strong> si son contenu ou une des ressources associées change.
Il offre également la possibilité de <strong>propager les changements sur plusieurs fenêtres et terminaux</strong> – y compris les clics, <em>scrolls</em> et toute interaction avec des formulaires.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de synchronisation d&#8217;affichage et de contenus entre deux fenêtres avec <em>browser-sync</em>.</div>
<div class="content">
<video src="./videos/browser-sync.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p><em>browser-sync</em> maintient la position du scroll lors d&#8217;un rechargement de contenu.
L&#8217;outil se lance soit de manière autonome, soit en <em>proxy</em> entre l&#8217;utilisateur et tout autre serveur web.
Il ne nécessite pas non plus de <em>plugin</em> ou d&#8217;extension navigateur pour fonctionner, le rendant idéal pour du prototypage, de la recherche utilisateur ou du développement local.</p>
</div>
<div class="listingblock">
<div class="title">Lancement d&#8217;un serveur web autonome avec synchronisation sur le port 4000.</div>
<div class="content">
<pre>$ ./node_modules/.bin/browser-sync start --server --port 4000 .</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;intégration de <em>browser-sync</em> avec le serveur web exposant les exemples de ce chapitre (voir le détail dans le fichier <code>server.js</code>) :</p>
</div>
<div class="listingblock">
<div class="title">livereload/server-sync.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const browserSync = require('browser-sync');

module.exports = (server) =&gt; {             <i class="conum" data-value="1"></i><b>(1)</b>
  return port =&gt; {                         <i class="conum" data-value="2"></i><b>(2)</b>
    const PUBLIC_PORT = 4000;              <i class="conum" data-value="3"></i><b>(3)</b>
    const bs = browserSync.create();

    server.listen(port);                   <i class="conum" data-value="4"></i><b>(4)</b>

    bs.init({                              <i class="conum" data-value="5"></i><b>(5)</b>
      files: ['./examples'],
      port: PUBLIC_PORT,
      open: false,
      logPrefix: 'nodebook',
      proxy: {
        target: `http://localhost:${port}`,<i class="conum" data-value="6"></i><b>(6)</b>
        ws: true,
      }
    });
  };
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On passe un serveur http en argument (obtenu via <code>http.createServer()</code> par exemple) ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ce port sera assigné au serveur web mais ne sera pas voué à être public ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ce port, lui, est celui qui sera public ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Démarrage du serveur web sur le port privé ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialisation de <em>browser-sync</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Interfaçage avec le serveur web créé au point 4.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La synchronisation peut être activée avec tous les exemples du chapitre en suffixant la commande <code>npm start</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ nodebook chapter 4
$ npm start -- --with-sync</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>browser-sync</em></div>
<div class="paragraph">
<p><em>browser-sync</em> est richement documenté et illustré, y compris ses intégrations avec les outils <em>gulp</em> et <em>grunt</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://browsersync.io/" class="bare">browsersync.io/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/browser-sync" class="bare">npmjs.com/browser-sync</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>browser-sync</em> a beau maintenir la position du <em>scroll</em>, il n&#8217;en reste pas moins que <strong>chaque changement remet à zéro</strong> l&#8217;espace mémoire de la page.
C&#8217;est là qu&#8217;entre en jeu le <strong>remplacement des modules à chaud</strong>.</p>
</div>
<div class="paragraph">
<p>Le <strong>remplacement des modules à chaud</strong> (<em>Hot Module Replacement</em> ou <em>HMR</em>) est une technique basée sur le remplacement de fonctions ou d&#8217;objets tout en assurant le maintien de leurs variables ou états internes.
Cette technique a notamment été popularisée par la combinaison de la librairie <em>React</em> et de l&#8217;outil d&#8217;assemblage <em>Webpack</em>.
Il est toutefois possible de procéder à du <em>remplacement à chaud</em> sans <em>React</em> et sans <em>Webpack</em>.</p>
</div>
<div class="paragraph">
<p>Quatre actions sont effectuées :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>un <strong>serveur de remplacement à chaud</strong> est démarré localement ;</p>
</li>
<li>
<p>l&#8217;outil d&#8217;assemblage (<em>browserify</em>, <em>Webpack</em> etc.) <strong>insère du code client</strong> permettant d&#8217;établir un lien entre la page web et le serveur de remplacement à chaud ;</p>
</li>
<li>
<p>l&#8217;outil d&#8217;assemblage <strong>déclare les fichiers modifiés</strong>, transmis par le serveur de remplacement à chaud vers le navigateur web ;</p>
</li>
<li>
<p>le <strong>code client remplace les modules</strong> et maintient leur état interne.</p>
</li>
</ol>
</div>
<div class="videoblock">
<div class="title">Exemple de rechargement à chaud avec des composants <em>React</em>.</div>
<div class="content">
<video src="./videos/react-hmr.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le <em>plugin browserify</em> nommé <em>livereactload</em> est très certainement le plus facile à mettre en place pour remplacer des modules <em>React</em> à la volée.
Il nécessite une ligne de configuration côté <em>browserify</em> et ne nécessite aucun changement de code côté client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>livereactload</em></div>
<div class="paragraph">
<p>Des aides à l&#8217;installation du module <em>livereactload</em> sont disponibles dans son fichier README.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/livereactload" class="bare">npmjs.com/livereactload</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le remplacement à chaud n&#8217;est possible que lorsque nous sommes dans un état de reconstruction en continu, par exemple avec <a href="#watchify">watchify</a>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons constater les effets du remplacement à chaud avec un des exemples de ce chapitre accessible sur <span class="URL"><a href="http://localhost:4000/examples/livereload/react-app-hmr.html" class="bare">localhost:4000/examples/livereload/react-app-hmr.html</a></span>.
La commande <code>npm run watch</code> de ce chapitre démarre un serveur web et reconstruit en continu le fichier <code>./examples/livereload/react-app-hmr.js</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ nodebook chapter 4
$ npm run watch</pre>
</div>
</div>
<div class="paragraph">
<p>Qui n&#8217;est autre qu&#8217;un équivalent de :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ watchify -dv \
  -t babelify \         # <1>
  -p livereactload \    # <2>
  -e ./examples/livereload/react-app-hmr.js \
  -o ./examples/livereload/react-app-hmr-browserify.js</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le <em>transform</em> (<code>-t</code>) modifie le code à la volée ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le <em>plugin</em> (<code>-p</code>) encapsule le fonctionnement de <em>watchify</em> pour effectuer des opérations plus complexes et impossibles à effectuer autrement.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il faudra ensuite modifier l&#8217;un des deux fichiers suivants – en décommentant les lignes concernées par exemple – pour constater les changements dans notre navigateur.</p>
</div>
<div class="listingblock">
<div class="title">livereload/react-app-hmr.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import { createElement } from 'react';
import ReactDOM from 'react-dom';
import ButtonCount from './button-count.jsx';

ReactDOM.render(
  createElement('div', {}, [
    createElement(ButtonCount),
    createElement(ButtonCount),
    // createElement(ButtonCount),
  ]),
  document.querySelector('#app')
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque instance du composant <code>livereload/button-count.jsx</code> gère un état interne indépendant des autres instances de même type.
Nous aurions perdu cet état interne en cas d&#8217;utilisation de <em>browser-sync</em>, sans <em>remplacement à chaud</em> :</p>
</div>
<div class="listingblock">
<div class="title">livereload/button-count.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx">import React, { Component } from 'react';

export default class ButtonCount extends Component {
  constructor(props) {
    super(props);

    this.handleClick = this.handleClick.bind(this);

    this.state = {
      clickCount: 0                                           <i class="conum" data-value="1"></i><b>(1)</b>
    };
  }

  handleClick () {
    this.setState({ clickCount: this.state.clickCount + 1 }); <i class="conum" data-value="2"></i><b>(2)</b>
  }

  render() {
    let style = {};
    // style = {
    //   fontFamily: 'monospace',
    //   fontWeight: 'bold',
    //   textTransform:' uppercase',
    // };

    return (&lt;button style={style} onClick={this.handleClick}&gt;
      Clics : {this.state.clickCount}
    &lt;/button&gt;);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialisation du compteur de clics propre à chaque instance de <code>ButtonCount</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incrémentation du compteur de clics en réaction à un clic sur le composant <code>ButtonCount</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>ud</em> et <em>browserify-hmr</em></div>
<div class="paragraph">
<p>Deux modules sont à disposition pour respectivement déclarer des modules remplaçables et pour démarrer un serveur de remplacement à chaud minimaliste.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/ud" class="bare">npmjs.com/ud</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/browserify-hmr" class="bare">npmjs.com/browserify-hmr</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="node-sass">6.3. Modulariser ses feuilles de style avec <em>Sass</em></h3>
<div class="paragraph">
<p>La modularité et l&#8217;écriture d&#8217;un code isolé facilitent sa réutilisation et préviennent les effets de bord.<br>
Dans le cas des feuilles de style CSS, cela peut aider à éviter de faire <em>déborder</em> la cascade – si l&#8217;on peut dire.</p>
</div>
<div class="paragraph">
<p>Avec le <em>langage Sass</em> (<span class="URL"><a href="http://sass-lang.com" class="bare">sass-lang.com</a></span>), nous pourrions songer à générer des blocs de code selon des <strong>listes</strong> (idéal pour des thèmes de couleurs, des rubriques produits etc.), à concevoir des <strong>composants comme des fonctions</strong> ou à bénéficier de fonctions de <strong>calcul de couleurs</strong> ou d&#8217;unités de mesure.</p>
</div>
<div class="paragraph">
<p>Le langage <em>Sass</em> est originaire du monde Ruby mais il a été depuis rendu accessible nativement à l&#8217;écosystème Node par le biais de <em>node-sass</em> (<span class="URL"><a href="https://npmjs.com/node-sass" class="bare">npmjs.com/node-sass</a></span>)– et par extension, par la librairie C <em>libsass</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lecture</span> CSS maintenables avec Sass et Compass</div>
<div class="paragraph">
<p>Je recommande la lecture de cet ouvrage de référence écrit par <em>Kaelig Deloumeau-Prigent</em> aux éditions <em>Eyrolles</em>.
Il décrit très bien les tenants et aboutissants de Sass ainsi que de bonnes méthodes d&#8217;organisation du code et de maintenabilité au sein d&#8217;une équipe de travail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://editions-eyrolles.com/Livre/9782212136401" class="bare">editions-eyrolles.com/Livre/9782212136401</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>node-sass</em> offre un outil en ligne de commande pour compiler un fichier Sass, plusieurs fichiers Sass ou encore une arborescence de répertoires contenant des fichiers Sass vers des fichiers CSS compréhensibles par les navigateurs web.</p>
</div>
<div class="listingblock">
<div class="title">ui/buttons.scss</div>
<div class="content">
<pre class="highlight"><code class="language-sass" data-lang="sass">$sizes: (                             <i class="conum" data-value="1"></i><b>(1)</b>
  small: .8,
  regular: 1,
  large: 1.2
);

.btn {
  @each $size, $factor in $sizes {    <i class="conum" data-value="2"></i><b>(2)</b>
    &amp;.btn--#{$size} {                 <i class="conum" data-value="3"></i><b>(3)</b>
      font-size: $factor * 1em;       <i class="conum" data-value="4"></i><b>(4)</b>
    }
  }

  &amp;.btn--icon {                       <i class="conum" data-value="5"></i><b>(5)</b>
    svg {
      height: 16px;
      width: 16px;
      margin-right: .5em;
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Définition d&#8217;une <code>Map</code> nommée <code>$sizes</code> (ensemble clé/valeur) décrivant des tailles et leur facteur multiplicateur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Itération et extraction des clés/valeurs de <code>$sizes</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Interpolation d&#8217;une variable pour composer un sélecteur CSS (<code>.btn&#8212;&#8203;small</code>, <code>.btn&#8212;&#8203;regular</code> etc.) ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calcul de la taille de la police de caractères (<code>.8em</code>, <code>1em</code> etc.);</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Composition d&#8217;un sélecteur de classe à partir du sélecteur courant (<code>.btn.btn&#8212;&#8203;icon</code>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La compilation des fichiers s&#8217;effectue très simplement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/node-sass -o ./examples ./examples/buttons.scss</pre>
</div>
</div>
<div class="paragraph">
<p>La compilation générera le fichier CSS <code>button.css</code>, lisible par tout navigateur web :</p>
</div>
<div class="listingblock">
<div class="title">ui/buttons.css</div>
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css">.btn.btn--small {
  font-size: 0.8em; }

.btn.btn--regular {
  font-size: 1em; }

.btn.btn--large {
  font-size: 1.2em; }

.btn.btn--icon svg {
  height: 16px;
  width: 16px;
  margin-right: .5em; }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Oublions les <em>vendor prefix</em></div>
<div class="paragraph">
<p>Les navigateurs évoluent plus vite que le cycle de vie de nos projets.
Certaines propriétés CSS sont abritées derrière des préfixes (<code>-moz</code>, <code>-webkit</code> etc.) avant d&#8217;être standardisées.</p>
</div>
<div class="paragraph">
<p>Ces deux modules nous facilitent la vie en préfixant et réécrivant automatiquement les attributs en fonction de nos exigences de compatibilité navigateurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/autoprefixer" class="bare">npmjs.com/autoprefixer</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/postcss" class="bare">npmjs.com/postcss</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ui-bundling">6.4. Lier composants visuels et feuilles de style</h3>
<div class="paragraph">
<p>Souvenons-nous de la section expliquant le <a href="#react">rapprochement entre données, rendu et interactions avec <em>React</em></a> de ce même chapitre.
Finalement nous avons presque tout rapproché, exception faite de la présentation avec <em>Sass</em> ou CSS.</p>
</div>
<div class="paragraph">
<p>En suivant la logique de notre approche modulaire, nous pourrions imaginer un <em>transform browserify</em> pour compiler et/ou extraire notre code <em>Sass</em> ou CSS depuis nos composants <em>CommonJS</em> ou <em>ECMAScript 2015</em>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est exactement la proposition du module <em>sassify</em>.
Il intègre <em>node-sass</em> en tant que <em>transform browserify</em> et le transforme le code à la volée durant la phase de compilation.
Il se charge lui-même d&#8217;ajouter les styles dans le document HTML ou expose le code CSS compilé via la fonction <code>require()</code>.</p>
</div>
<div class="paragraph">
<p>Une saine stratégie serait de charger des CSS de base dans une feuille de style en tête de <code>&lt;head&gt;</code> puis de laisser les composants graphiques injecter leurs feuilles CSS respectives après coup.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant expose deux composants <em>React</em>, regroupés dans une thématique de composants de boutons HTML.
Une feuille de style est importée à même le module afin de <strong>gérer à un même niveau, présentation, rendu et interactions</strong> :</p>
</div>
<div class="listingblock">
<div class="title">ui/Buttons.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx">import React from 'react';
import './buttons.scss';

const Icon = (props) =&gt; (&lt;svg aria-hidden="true"&gt;
  &lt;use xlinkHref={'symbols.svg#' + props.id} /&gt;
&lt;/svg&gt;);

export const BaseButton = (props) =&gt; (
  &lt;button className={'btn btn--' + props.variant}&gt;{props.children}&lt;/button&gt;
);

export const IconButton = (props) =&gt; (
  &lt;button className="btn btn--icon"&gt;
    &lt;Icon id={props.icon} /&gt;
    {props.children}
  &lt;/button&gt;
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import d&#8217;un fichier <em>Sass</em> qui sera par la suite compilé en CSS par le <em>transform sassify</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sans surprise, le module <em>sassify</em> se charge comme la majorité des <em>transform browserify</em> comme vu dans la section <a href="#browserify">Importer des modules npm pour le web</a> dans ce même chapitre :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/browserify \
  -t sassify \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante injectera automatiquement les feuilles de style compilées dans le document HTML lors de son exécution dans un navigateur web :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/browserify \
  -t [ sassify --auto-inject ] \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> CSS Modules</div>
<div class="paragraph">
<p>Une autre philosophie émergente est de continuer à transformer son code <em>Sass</em> ou CSS en styles en ligne, à leur adjoindre un préfixe unique et à les insérer directement dans le code HTML.<br>
Elle demande moins d&#8217;outillage et s&#8217;applique pleinement à des composants visuels modulaires :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/css-modules" class="bare">npmjs.com/css-modules</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/css-modulesify" class="bare">npmjs.com/css-modulesify</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</h3>
<div class="paragraph">
<p>Node est un outil de choix lorsque l&#8217;on souhaite s&#8217;atteler au développement <em>frontend</em> et ce n&#8217;est pas sans raison.
Outre l&#8217;outillage lié à la réécriture du code – comme <a href="#babel">Babel</a> et <a href="#browserify">browserify</a> évoqués ci-avant – Node regorge de modules <em>npm</em> réduisant les tâches manuelles répétitives et possiblement sujettes à erreur.</p>
</div>
<div class="paragraph">
<p>Nous retrouvons l'<strong>optimisation des ressources graphiques</strong> parmi cet ensemble de tâches rébarbatives.
Quand j&#8217;écris <em>ressources graphiques</em>, j&#8217;entends par là le redimensionnement ou la création de vignettes d&#8217;images, l&#8217;optimisation de leur poids, la fusion de fichiers SVG sous forme de symboles, la création de piles de polices de caractère et même l&#8217;encodage audio/vidéo – via des <em>bindings</em> avec des logiciels spécialisés comme <em>ffmpeg</em> ou <em>lame</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil en ligne de commande <em>imagemin-cli</em> (<span class="URL"><a href="https://npmjs.com/imagemin-cli" class="bare">npmjs.com/imagemin-cli</a></span>) est le module de référence pour optimiser les fichiers graphiques.
Il est basé sur la librairie <em>imagemin</em> (<span class="URL"><a href="https://npmjs.com/imagemin" class="bare">npmjs.com/imagemin</a></span>) et se chargera de réduire le poids de nos images JPEG, PNG mais aussi GIF (animés et statiques) ainsi que le format vectoriel SVG.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./node_modules/.bin/imagemin images/* --out-dir images
8 images minified</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Glossaire</span> Compression destructive et non-destructive</div>
<div class="paragraph">
<p>Il existe deux types de compression : avec et sans perte (<em>lossless</em>).
Elles ont toutes deux des caractéristiques distinctes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>destructive</strong> : poids réduit au maximum, possibles artéfacts visuels, destruction potentielle de couleurs dans le cas d&#8217;images complexes ;</p>
</li>
<li>
<p><strong>sans perte</strong> : poids réduit, les couleurs supprimées ne sont pas perceptibles à l&#8217;œil nu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux privilégier la <em>compression sans perte</em> pour éviter les artéfacts visuels et respecter fidèlement la création d&#8217;origine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le <strong>redimensionnement d&#8217;images</strong> est une autre de ces tâches courantes et récurrentes qui tombe rapidement aux oubliettes de par sa gourmandise en temps.
On voudra par exemple redimensionner des photos depuis des fichiers originaux, générer des <strong>vignettes</strong> ou encore <strong>générer différentes tailles d&#8217;images</strong> adaptées aux différentes dispositions d&#8217;un site web <em>responsive</em>.</p>
</div>
<div class="paragraph">
<p><em>sharp-cli</em> (<span class="URL"><a href="https://npmjs.com/sharp-cli" class="bare">npmjs.com/sharp-cli</a></span>) répond exactement à ce cahier des charges.
Ce module en ligne de commande est basé sur <em>sharp</em> (<span class="URL"><a href="https://npmjs.com/sharp" class="bare">npmjs.com/sharp</a></span>), une librairie Node de modification d&#8217;images écrite en <em>ECMAScript</em> et <em>C++</em>.
<em>sharp</em> nous aidera entre autres à redimensionner, découper, retourner, recentrer, assembler et appliquer des effets graphiques de manière prédictible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./node_modules/.bin/sharp resize 500 \
  --min \
  -i images/*.png \
  --output ./images/thumbs</pre>
</div>
</div>
<div class="paragraph">
<p>La commande précédente illustre une <strong>opération de redimensionnement d&#8217;images</strong> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>d&#8217;une dimension de <strong>500 pixels de largeur</strong> ;</p>
</li>
<li>
<p><strong>minimum</strong> (donc respecte ) – sans cet attribut les images seraient des carrés de 500 pixels de large et de 500 pixels de haut ;</p>
</li>
<li>
<p>ciblant toutes les <strong>images PNG</strong> du répertoire <code>images</code> ;</p>
</li>
<li>
<p>puis <strong>exportées dans le répertoire</strong> <code>images/thumbs</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>./node_modules/.bin/sharp grayscale \
  -i images/*.png \
  --output ./images/square</pre>
</div>
</div>
<div class="paragraph">
<p>À l&#8217;inverse, la commande précédente illustre la conversion en noir et blanc d&#8217;images ainsi que leur export dans un répertoire différent.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface en ligne de commande de <em>sharp-cli</em> ne permet pas de créer d&#8217;opérations composites (redimensionner et convertir en niveaux de gris par exemple).
Il faudra recourir à l&#8217;API Node de <em>sharp</em> et chaîner les opérations en s&#8217;aidant des exemples documentés sur <span class="URL"><a href="http://sharp.dimens.io/" class="bare">sharp.dimens.io/</a></span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> gm</div>
<div class="paragraph">
<p>Le module <em>gm</em> est le module <em>classique</em> de redimensionnement dans l&#8217;écosystème Node.
Il s&#8217;interface avec le programme <em>GraphicsMagick</em> et <em>ImageMagick</em> – et nécessite donc leur présence sur le système d&#8217;exploitation.
Cela rend l&#8217;utilisation de <em>gm</em> légèrement moins triviale que celle de <em>sharp</em> mais la quantité de ressources et la qualité du module en font une bonne alternative à considérer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/gm" class="bare">npmjs.com/gm</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://aheckmann.github.io/gm/" class="bare">aheckmann.github.io/gm/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation d&#8217;un <a href="../chapter-02/index.html#npm-scripts">script npm</a> (cf. Chapitre 2) est idéale pour décrire les différentes actions d&#8217;optimisation.
Les <em>scripts</em> sont alors à invoquer manuellement, sur un <em>crochet git</em> (<em>git hook</em>) ou automatiquement lors du déploiement avec un <a href="../chapter-06/index.html#automated-deploy">service d&#8217;intégration continue</a>, par exemple.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">7. Tester son code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est bien connu que lorsqu&#8217;on produit du code de qualité, écrire des tests est amplement superflu et ne sert qu&#8217;à nous ralentir.</p>
</div>
<div class="paragraph">
<p>La réalité est toute autre et suit un paradigme très simple : <strong>plus il y a de lignes de code, plus il y a de chances de faire des erreurs</strong>.
Cela vaut aussi bien pour du HTML que du CSS ou encore de l'<em>ECMAScript</em>.</p>
</div>
<div class="paragraph">
<p>Cette ultime et dernière section de ce chapitre nous aidera à comprendre quoi et comment tester pour <strong>diminuer le coût de maintenance de nos applications</strong>.</p>
</div>
<div class="sect2">
<h3 id="testing-101">7.1. Que tester ?</h3>
<div class="paragraph">
<p>L&#8217;idée d&#8217;écrire des tests pour améliorer la qualité de son code est attrayante mais quand on en sait pas quoi tester et ni à qui demander pour se lancer, il est évident qu&#8217;on ne va pas s&#8217;y mettre pour s&#8217;assurer que 1+1 valent bien <span class="line-through">3</span> 2.</p>
</div>
<div class="paragraph">
<p>Je pense à ces <em>trois règles</em> lorsque je souhaite écrire des tests :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>qu&#8217;est-ce qui est <strong>public/exporté</strong> ?</p>
</li>
<li>
<p>qu&#8217;est-ce qui crée des <strong>branches dans mon code</strong> ?</p>
</li>
<li>
<p>qu&#8217;est-ce qui <strong>vient du monde extérieur</strong> ?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La syntaxe de modules <em>ECMAScript 2015</em> est idéale pour visualiser les segments de code qui sont exportés par nos différents fichiers.
Élément marquant : ce code est simple et devrait arriver à compter le nombre de mots mais nous n&#8217;avons aucune idée s&#8217;il fera correctement le travail sans l&#8217;exécuter dans une application.</p>
</div>
<div class="listingblock">
<div class="title">test-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const isWord = (word) =&gt; {
  return /^[\w\s\.,\-\?!;+]{2,}$/.test(word) &amp;&amp; Number.isNaN(Number(word));
};

export default function countWords (sentence) { <i class="conum" data-value="1"></i><b>(1)</b>
  return sentence
    .split(' ')
    .filter(isWord)
    .length;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La fonction <code>countWords</code> le seul élément exporté par notre module et devrait donc être le seul sujet de nos tests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une <em>branche</em> est une portion de <strong>code qui s&#8217;exécute de manière ponctuelle</strong>.
Ces sections de code s&#8217;activent ou non selon l&#8217;état d&#8217;une structure de données.
Il faut <strong>prévoir <em>au moins autant</em> de tests que de branches</strong> pour valider les attentes.</p>
</div>
<div class="listingblock">
<div class="title">test-branches.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">export default function isOdd (number) {
  if (typeof number !== 'number' || Number.isNaN(number)) { <i class="conum" data-value="1"></i><b>(1)</b>
    throw new Error('number devrait être un nombre')
  }

  if (number % 2) { <i class="conum" data-value="2"></i><b>(2)</b>
    return true;
  }
  else {            <i class="conum" data-value="3"></i><b>(3)</b>
    return false;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Première branche activée dans <em>deux</em> cas de figure ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Seconde branche ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Troisième branche.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, l'<strong>accès à toute donnée externe</strong> est susceptible de mal fonctionner sans que nous puissions maitriser l&#8217;origine des problèmes.
En revanche l&#8217;écriture de tests nous aidera à <strong>accepter ce cas de figure</strong> et à le signaler à nos applications.</p>
</div>
<div class="listingblock">
<div class="title">test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">export default function getLinkElementContent (linkElement) {
  const {href} = linkElement;           <i class="conum" data-value="1"></i><b>(1)</b>

  return fetch(href)                    <i class="conum" data-value="2"></i><b>(2)</b>
    .then(response =&gt; response.json())  <i class="conum" data-value="3"></i><b>(3)</b>
    .then(pkg =&gt; pkg.dependencies);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>linkElement</code> peut ne pas être un lien hypertexte (<code>document.querySelector</code> retourne <code>null</code>) ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ici tout peut arriver : <code>href</code> n&#8217;est pas une URL valide (balise <code>href</code> vide), serveur indisponible etc ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Et là, le fichier JSON peut être mal mal formé ou la réponse est exprimée dans un autre format que JSON.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous savons désormais à peu près tout ce qu&#8217;il faut <em>flairer</em> pour renforcer nos applications en écrivant quelques tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_s_outiller_pour_écrire_des_assertions">7.2. S&#8217;outiller pour écrire des assertions</h3>
<div class="paragraph">
<p>Avant de nous lancer directement dans la conception et l&#8217;écriture des tests, intéressons-nous à comprendre comment l&#8217;outillage se structure.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l'<strong>assertion</strong><br>
C&#8217;est la <em>vérification</em> d&#8217;une vérité, d&#8217;une attente, du résultat d&#8217;une opération.
Une <em>assertion</em> couvre <em>une branche</em> de code.</p>
</li>
<li>
<p>le <strong>test</strong><br>
C&#8217;est un <em>regroupement d&#8217;assertions</em> couvrant toutes les <em>branches</em> des fonctionnalités <em>publiques</em> de notre code.</p>
</li>
<li>
<p>la <strong>suite de tests</strong><br>
C&#8217;est un <em>ensemble de tests</em> couvrant un aspect logique d&#8217;un code applicatif.
Une application peut comporter plusieurs suites selon sa complexité :</p>
<div class="ulist">
<ul>
<li>
<p>tests <strong>unitaires</strong> pour s&#8217;assurer du fonctionnement de l&#8217;interface de code ;</p>
</li>
<li>
<p>tests <strong>fonctionnels</strong> pour s&#8217;assurer du fonctionnement de scénarios d&#8217;utilisation d&#8217;une application ;</p>
</li>
<li>
<p>tests d'<strong>intégration</strong> pour s&#8217;assurer du fonctionnement d&#8217;une application en relation avec d&#8217;autres applications lui fournissant données et services ;</p>
</li>
</ul>
</div>
</li>
<li>
<p>l'<strong>exécuteur de tests</strong><br>
C&#8217;est le logiciel responsable de créer l&#8217;environnement d&#8217;exécution d&#8217;une <em>suite de tests</em>.
Ils expriment une opinion sur la structuration des tests ainsi que sur des automatismes à fournir pour accélérer l&#8217;écriture des tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;outillage varie selon chacun de ces niveaux.
Certains outils offrent une écriture d&#8217;assertion plus fluide, d&#8217;autres proposent une écriture plus spécifiquement adaptée.</p>
</div>
<div class="paragraph">
<p>Les sections suivantes sont complémentaires.
J&#8217;ai favorisé des approches itératives et modulaires pour faciliter l&#8217;ajout ou le retrait de tout outil de notre outillage :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la librairie <em>chai</em> pour les <em>assertions</em> ;</p>
</li>
<li>
<p>la librairie <em>mocha</em> pour les <em>tests</em> ;</p>
</li>
<li>
<p>la librairie <em>mocha</em> pour la <em>suite de tests</em> exécutable par Node ;</p>
</li>
<li>
<p>l'<em>exécuteur de tests</em> nommé  <em>karma</em> pour faire fonctionner la <em>suite de tests</em> dans les navigateur web.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>chai</em>, <em>mocha</em> et <em>karma</em></div>
<div class="paragraph">
<p>Ces trois librairies disposent d&#8217;une documentation en ligne expliquant leurs options respectives ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://chaijs.com/api/bdd/" class="bare">chaijs.com/api/bdd/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://mochajs.org/" class="bare">mochajs.org/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://karma-runner.github.io/" class="bare">karma-runner.github.io/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;assertion avec la librairie <em>chai</em></div>
<div class="content">
<pre>import {expect} from 'chai';

expect(2+2).to.equal(4);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple de test avec la librairie <em>mocha</em></div>
<div class="content">
<pre>describe('functionName', () =&gt; {
  it('should succeed with parameter cheese', () =&gt; {
    // ...
  });

  it('should throw an error with parameter meat', () =&gt; {
    // ...
  });
});</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exécution de suites de tests avec <em>mocha</em> et <em>karma</em></div>
<div class="content">
<pre>$ mocha tests/**/*.js
$ karma start</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécuteur de tests <em>karma</em> se configure par le biais d&#8217;un fichier <code>karma.conf.js</code>.
Nous en trouverons un à la racine du répertoire des ressources de ce chapitre 4.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tester_ses_composants_react_sans_navigateur_web">7.3. Tester ses composants React sans navigateur web</h3>
<div class="paragraph">
<p>Un des points forts de <a href="#react">React</a> évoqué dans ce chapitre est la <em>description de son rendu</em> à même le composant.
Nous bénéficions ainsi du résultat final (son HTML par exemple) ainsi que d&#8217;un arbre représentant une structure de sous-éléments et de propriétés.</p>
</div>
<div class="paragraph">
<p>Nous disposons de deux stratégies pour tester un composant <em>React</em> afin d&#8217;en tester les différents comportements :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>tester le rendu</strong> en comparant des chaînes de caractères ;</p>
</li>
<li>
<p><strong>tester l&#8217;état</strong> en validant la présence d&#8217;attributs ou le déclenchement de certaines méthodes du composant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La librairie <em>Enzyme</em> (<span class="URL"><a href="https://npmjs.com/enzyme" class="bare">npmjs.com/enzyme</a></span>) s&#8217;occupe très bien des deux, en plus de s&#8217;intégrer avec n&#8217;importe quelle librairie de tests.
Dans tous les cas, elle nous permettra de monter nos composants soit de manière isolée, soit dans un véritable arbre DOM soit en rendu HTML.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>Enzyme</em></div>
<div class="paragraph">
<p>L&#8217;équipe d&#8217;Airbnb offre une documentation exhaustive ainsi que des exemples complets d&#8217;intégration avec des outils comme <em>mocha</em>, <em>webpack</em>, <em>tape</em> ou encore <em>ava</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://airbnb.io/enzyme/" class="bare">airbnb.io/enzyme/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="http://airbnb.io/enzyme/docs/api/" class="bare">airbnb.io/enzyme/docs/api/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons nous baser sur le composant créé dans la section <a href="#react">rapprocher données, rendu et interactions avec React</a> pour s&#8217;assurer de son comportement <em>avant même de l&#8217;inclure</em> dans notre application.</p>
</div>
<div class="listingblock">
<div class="title">tests/date-interval.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import { createElement } from 'react';
import { expect } from 'chai';
import { shallow } from 'enzyme';
import DateInterval from '../modules/date-interval.jsx';    <i class="conum" data-value="1"></i><b>(1)</b>

describe('&lt;DateInterval /&gt;', () =&gt; {
  it('should render a time element', () =&gt; {                <i class="conum" data-value="2"></i><b>(2)</b>
    const component = shallow(createElement(DateInterval)); <i class="conum" data-value="3"></i><b>(3)</b>

    expect(component.find('time')).to.have.length(1);       <i class="conum" data-value="4"></i><b>(4)</b>
  });

  it('should populate props.tickData with now+className properties', () =&gt; {
    const component = shallow(createElement(DateInterval)); <i class="conum" data-value="5"></i><b>(5)</b>
    const {tickData} = component.state();                   <i class="conum" data-value="6"></i><b>(6)</b>

    expect(tickData.now.getTime()).to.be.closeTo(Date.now(), 3);  <i class="conum" data-value="7"></i><b>(7)</b>
    expect(tickData.className).to.be.oneOf(['pair', 'impair']);   <i class="conum" data-value="8"></i><b>(8)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import du module <code>DateInterval</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Création d&#8217;un <em>test</em> destiné à vérifier la nature de la balise HTML à générer ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Création du composant isolé (<em>shallow</em>) – aucun élément DOM ne sera créé ni inséré dans le document ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>On écrit une <em>assertion</em> garantissant que l&#8217;on retourne un élément <code>&lt;time&gt;</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Création d&#8217;un second composant isolé dont l&#8217;état est indépendant du premier ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Récupération de l&#8217;état (<em>state</em>) du composant ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Assertion vérifiant que la date utilisée par le composant est proche de la date courante (à quelques millisecondes près);</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Assertion vérifiant qu&#8217;une propriété de l&#8217;état ne peut être qu&#8217;une des deux valeurs parmi <code>pair</code> et <code>impair</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En complément à ceci, la librairie <em>chai-enzyme</em> (<span class="URL"><a href="https://npmjs.com/chai-enzyme" class="bare">npmjs.com/chai-enzyme</a></span>) étend le vocabulaire de <em>chai</em> pour ajouter des assertions de composants.
C&#8217;est une question de goût plus qu&#8217;une nécessité.<br>
L&#8217;exemple suivant reprend le composant créé dans la section <a href="#livereload">changements en temps-réel dans le navigateur</a> et illustre une assertion suite à un clic sur le bouton :</p>
</div>
<div class="listingblock">
<div class="title">tests/button-count.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import React from 'react';
import chai, { expect } from 'chai';
import chaiEnzyme from 'chai-enzyme';
import { shallow } from 'enzyme';
import ButtonCount from '../livereload/button-count.jsx';

chai.use(chaiEnzyme());

describe('&lt;ButtonCount /&gt;', () =&gt; {
  it('should increment state on click', () =&gt; {       <i class="conum" data-value="1"></i><b>(1)</b>
    const component = shallow(&lt;ButtonCount /&gt;);
    component.simulate('click');                      <i class="conum" data-value="2"></i><b>(2)</b>

    expect(component).to.have.state('clickCount', 1); <i class="conum" data-value="3"></i><b>(3)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le libellé du test décrit le résultat attendu dans les assertions ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Simulation du clic sur le composant ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>L&#8217;état interne a bien été changé et correspond à la valeur attendue.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le fichier <code>package.json</code> des ressources du chapitre 4 contient une tâche exécutant les tests exécutables dans un environnement Node uniquement.
Elle se lance de la manière suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm run test:node</pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/mocha-react.png" alt="mocha react" width="80%">
</div>
<div class="title">Figure 7. Extrait de la sortie de la commande <code>npm run test:node</code></div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>jest</em></div>
<div class="paragraph">
<p><em>jest</em> est un exécuteur de tests moderne et rapide particulièrement adapté au test de composants côté serveur.
Au moment d&#8217;écrire cet ouvrage, il n&#8217;était pas encore possible de l&#8217;exécuter dans un navigateur web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/jest" class="bare">npmjs.com/jest</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://facebook.github.io/jest/" class="bare">facebook.github.io/jest/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est intéressant de retenir que les tests navigateurs ne sont pas indispensables pour s&#8217;assurer du bon fonctionnement de nos composants.
Des librairies comme <em>React</em> sont déjà solidement testées.
Cela nous laisse l&#8217;opportunité de nous concentrer uniquement sur notre logique métier.</p>
</div>
<div class="paragraph">
<p>Les tests navigateurs sont en revanche utiles pour tester la compatibilité navigateurs, que ce soit au niveau de la syntaxe <em>ECMAScript</em> ou du rendu CSS.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tester_code_et_composants_dans_les_navigateurs_web">7.4. Tester code et composants dans les navigateurs web</h3>
<div class="paragraph">
<p>C&#8217;est bien beau de tester uniquement l&#8217;interface de composants <em>React</em> (ou autre technologie) mais comment faire lorsqu&#8217;on a besoin de tester avec un vrai DOM ou dans plusieurs navigateurs web ?</p>
</div>
<div class="paragraph">
<p>On a besoin de tester dans un ou plusieurs navigateurs web pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>s&#8217;assurer de la <strong>compatibilité de notre code</strong> avec les variations d&#8217;implémentation de navigateurs web ;</p>
</li>
<li>
<p>valider notre choix de <em>polyfills</em> ;</p>
</li>
<li>
<p><strong>tester fidèlement</strong> contre des APIs de navigateurs ou du DOM (comme <em>Web Audio</em>, <em>Service Workers</em> etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Autrement dit, nous avons besoin d&#8217;un <strong>exécuteur de tests</strong> qui les fasse fonctionner dans l&#8217;environnement d&#8217;un navigateur web.
Idéalement, nous voulons que cet <em>exécuteur de tests</em> n&#8217;influent pas sur l&#8217;outillage employé pour écrire nos tests et donc nous permette d&#8217;utiliser <em>mocha</em> et <em>chai</em> comme dans la section précédente.</p>
</div>
<div class="paragraph">
<p><em>karma</em> (<span class="URL"><a href="https://npmjs.com/karma" class="bare">npmjs.com/karma</a></span>) est l&#8217;outil phare de l&#8217;écosystème Node dédié aux tests dans les navigateurs web.
Il a été créé en 2012 pour faciliter l&#8217;exécution des suites de tests de la librairie <em>Angular</em> et s&#8217;exécute en <strong>ligne de commande</strong>, assez simplement.</p>
</div>
<div class="paragraph">
<p>Les fonctionnalités de <em>karma</em> s&#8217;étendent à l&#8217;aide de modules <em>npm</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>intégrations</strong> avec des <em>suites de tests</em> ;</p>
</li>
<li>
<p><strong>lanceurs</strong> de navigateurs web ;</p>
</li>
<li>
<p><strong>préprocesseurs</strong> pour transformer des fichiers, les servir et/ou les inclure dans l&#8217;environnement de tests.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em>.</div>
<div class="content">
<video src="./videos/karma-browsers.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le pilotage de <em>karma</em> se fait via un fichier de configuration <code>karma.conf.js</code>.
Il est possible de surcharger ultérieurement cette configuration avec des arguments de la ligne de commande.</p>
</div>
<div class="listingblock">
<div class="title">Initialisation automatique d&#8217;un fichier de configuration <code>karma.conf.js</code></div>
<div class="content">
<pre>$ ./node_modules/.bin/karma init</pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> fonctionne avec des navigateurs installés sur notre machine de développement tout comme avec des services distants comme <em>SauceLabs</em> ou <em>BrowserStack</em> (voir <a href="#ci">intégration continue et compatibilité navigateurs</a>).
Les navigateurs doivent déjà être disponibles sur la machine de test (Firefox et Chrome par exemple) et nous devons en parallèle installer les <strong>lanceurs</strong> (<code>karma-firefox-launcher</code> et <code>karma-chrome-launcher</code> respectivement).</p>
</div>
<div class="paragraph">
<p>Les navigateurs lancés par défaut lors des tests sont listés dans l&#8217;option <code>browsers</code> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L82</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browsers: ['Chrome'],</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> se charge d'<strong>inclure les fichiers JavaScript</strong> ou de <strong>servir des fichiers statiques</strong> en fonction de <em>motifs</em> de chemins.
Ces fichiers peuvent être locaux (de préférence) ou distants et même être de types différents comme JSON ou HTML :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L17-23</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">files: [
  //'https://cdn.polyfill.io/v2/polyfill.min.js',           <i class="conum" data-value="1"></i><b>(1)</b>
  'examples/tests-browser/**/*.js',                         <i class="conum" data-value="2"></i><b>(2)</b>
  'examples/tests/**/*.js',
  'examples/tests-browser/**/*.html',                       <i class="conum" data-value="3"></i><b>(3)</b>
  { pattern: 'package.json', served: true, included: false }<i class="conum" data-value="4"></i><b>(4)</b>
],</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Il suffirait de décommenter cette ligne pour inclure les <a href="#polyfills"><em>polyfills</em> de navigateurs web</a> sans toucher à notre code ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inclusion des fichiers de tests spécifiques aux navigateurs web ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inclusion de fichiers HTML, sans effet à moins ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Mise à disposition du fichier <code>package.json</code>, accessible via une requête HTTP vers <code>/base/package.json</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Des <em>intégrations</em> doivent être déclarés pour augmenter les fonctionnalités de base de <em>karma</em>.
Les fonctionnalités de base de <em>karma</em> se résument à charger des fichiers <em>ECMAScript</em> dans une balise <code>&lt;script&gt;</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;extrait de configuration suivant illustre le chargement des <em>plugins</em> pour <em>browserify</em> (modules <em>CommonJS</em> et transpilation), <em>mocha</em> (<em>suites de tests</em>) et <em>fixture</em> (données représentant des cas d&#8217;utilisation) – respectivement les modules <em>npm</em> <code>karma-browserify</code>, <code>karma-mocha</code> et <code>karma-fixture</code> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L13</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">frameworks: ['browserify', 'mocha', 'fixture'],</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois encore des <em>motifs de chemins</em> sont utilisés pour indiquer aux <em>plugins</em> leur responsabilité de prise en charge.</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L33-37</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">preprocessors: {
  'examples/tests/**/*.js': ['browserify'],                 <i class="conum" data-value="1"></i><b>(1)</b>
  'examples/tests-browser/**/*.js': ['browserify'],
  'examples/tests-browser/**/*.html': ['html2js'],          <i class="conum" data-value="2"></i><b>(2)</b>
},</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ces fichiers seront transpilés par <em>browserify</em> avant d&#8217;être chargés dans les tests de navigateurs web ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ces fichiers seront pris en charge par le <em>préprocesseur</em> nommé <em>html2js</em>, utilisé par <code>karma-fixture</code> pour transformer du HTML en arbre DOM.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous avons vu un exemple de code reposant sur un élément du DOM dans la section <a href="#testing-101">que tester ?</a> de ce chapitre.
Nous allons nous intéresser à une manière possible de tester la fonction exportée <code>getLinkElementContent</code> en se basant sur un <strong>véritable appel HTTP</strong> et un <strong>véritable élément du DOM</strong>, créé à partir du fichier de <em>fixture</em> suivant :</p>
</div>
<div class="listingblock">
<div class="title">tests-browser/fixtures/link-package.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;a href="/base/package.json"&gt;Test&lt;/a&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce fichier de <em>fixture</em> est chargé dans le DOM par le <em>plugin</em> <code>karma-fixture</code> pour prouver que l&#8217;on peut récupérer les dépendances exposées par le fichier <code>package.json</code> des ressources de ce chapitre :</p>
</div>
<div class="listingblock">
<div class="title">tests-browser/test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">import { expect } from 'chai';
import getLinkElementContent from '../test-outside-world.js';

describe('getLinkElementContent', () =&gt; {
  before(() =&gt; fixture.setBase('examples/tests-browser/fixtures')); <i class="conum" data-value="1"></i><b>(1)</b>

  it('follows an HTML link to a package.json and get its dependencies', () =&gt; {
    const [link] = fixture.load('link-package.html');               <i class="conum" data-value="2"></i><b>(2)</b>

    return getLinkElementContent(link).then(deps =&gt; {               <i class="conum" data-value="3"></i><b>(3)</b>
      expect(deps).to.contain.all.keys('babel', 'react', 'enzyme'); <i class="conum" data-value="4"></i><b>(4)</b>
    });
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>before()</code> indique à <em>mocha</em> d&#8217;exécuter ce bloc de code avant tout <em>test</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Appel du <em>plugin</em> de <em>fixture</em> pour obtenir l&#8217;élément du DOM nécessaire à la fonction <code>getLinkElementContent</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Appel réel de la fonction <code>getLinkElementContent</code>, résolu comme une <a href="../chapter-02/index.html#primitive-promise">promesse</a> et dont nous testons le résultat à la ligne suivante ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><em>Assertion</em> vérifiant que le résultat contient bien des clés de dépendances <em>npm</em> attendues – nous avons bien récupéré le bon fichier et le bon contenu !</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;invocation de <em>karma</em> se fait en invoquant <code>./node_modules/.bin/karma start</code>.
Par mesure de simplicité, cette commande a été abstraite en tant que <a href="../chapter-02/index.html#npm-scripts">script <em>npm</em></a> :</p>
</div>
<div class="listingblock">
<div class="title">Exécution ponctuelle de <em>karma</em>.</div>
<div class="content">
<pre>$ npm run test:browser</pre>
</div>
</div>
<div class="paragraph">
<p>Les tests peuvent être relancés en continu – dès qu&#8217;un fichier change – en désactivant l&#8217;exécution unique (<em>single run</em>).
C&#8217;est idéal lorsque les tests sont écrits en parallèle de l&#8217;implémentation du code ou que des ajustements fréquents ont lieu en phase de développement :</p>
</div>
<div class="listingblock">
<div class="title">Exécution continue de <em>karma</em>.</div>
<div class="content">
<pre>$ npm run test:browser -- --no-single-run</pre>
</div>
</div>
<div class="paragraph">
<p>Comme tout process de longue durée, il s&#8217;interrompt à l&#8217;aide de la combinaison de touches <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="paragraph">
<p>Nous en savons désormais suffisamment pour <strong>tester dans les conditions des navigateurs web</strong> avec du <strong>code modulaire et réutilisable</strong>.</p>
</div>
<div class="paragraph">
<p>La question qui se pose désormais est la suivante : <strong>comment faire pour tester plusieurs versions d&#8217;un même navigateur</strong>, pour tester sur un système d&#8217;exploitation que l&#8217;on n&#8217;a pas ou encore plusieurs <strong>terminaux mobiles</strong> de type <em>smartphone</em> ou tablette.</p>
</div>
</div>
<div class="sect2">
<h3 id="ci">7.5. Intégration continue et compatibilité navigateurs</h3>
<div class="paragraph">
<p>Plusieurs cas de figure se posent en complément de la section précédente :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la <strong>difficulté d&#8217;accès</strong> à certaines combinaisons <em>navigateur web</em> + <em>système d&#8217;exploitation</em> ;</p>
</li>
<li>
<p>l&#8217;envie d'<strong>automatiser les tests</strong> de navigateurs web.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En étant sous <em>Windows</em>, il nous sera difficile de tester <em>Safari pour macOS</em>.
Inversement, en étant sous <em>macOS</em> il nous sera difficile de tester <em>Internet Explorer pour Windows XP</em> ou <em>Edge pour Windows 10</em>.
Que dire d&#8217;anciennes versions de navigateurs Android dont la rapidité de développement et donc la compatibilité est bien en deçà des versions de Chrome pour ordinateur ou mobile.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em> et <em>BrowserStack</em>.</div>
<div class="content">
<video src="./videos/karma-browserstack.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>L&#8217;écosystème de modules <em>npm</em> liés à <em>karma</em> s&#8217;est déjà penché sur la question.
C&#8217;est le cas notamment du produit <em>BrowserStack</em> qui offre une intégration pour déléguer l&#8217;exécution des tests sur leur plate-forme commerciale.
Il s&#8217;agit du module <code>karma-browserstack-launcher</code> (<span class="URL"><a href="https://npmjs.com/karma-browserstack-launcher" class="bare">npmjs.com/karma-browserstack-launcher</a></span>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>BrowserStack</em></div>
<div class="paragraph">
<p>La documentation de <em>BrowserStack</em> décrit les différents systèmes d&#8217;exploitation à disposition ainsi que les navigateurs web compatibles, pour PC, Mac, iOS et Android.
L&#8217;intégration avec Node est également documentée au cas où vous souhaiteriez effectuer des tests sans passer par <em>karma</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.browserstack.com/automate/node" class="bare">www.browserstack.com/automate/node</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://www.browserstack.com/list-of-browsers-and-platforms" class="bare">www.browserstack.com/list-of-browsers-and-platforms</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> n&#8217;est pas un navigateur en soi mais offre un accès à une multitude de navigateurs.
Il faut donc créer de nouvelles configurations de navigateurs dans la propriété de configuration <code>customLaunchers</code>.
L&#8217;extrait de configuration suivant illustre la création d&#8217;un navigateur <em>Safari</em> pour <em>iPhone 4S</em> sous <em>iOS 5.1</em> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L84-91</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">customLaunchers: {
  iphone4: {
    base: 'BrowserStack',
    device: 'iPhone 4S',
    os: 'ios',
    os_version: '5.1'
  },
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <em>BrowserStack</em> nécessite un compte et l&#8217;obtention d&#8217;une clé d&#8217;API afin d&#8217;utiliser leur service.
Notre <em>npm d&#8217;utilisateur</em> et la <em>clé d&#8217;API</em> doivent être renseignés en tant que <strong>variables d&#8217;environnement</strong> pour établir une connexion au service et démarrer notre bon vieil iPhone 4 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ export BROWSER_STACK_USERNAME=…
$ export BROWSER_STACK_ACCESS_KEY=…
$ npm run test:browser -- --browsers iphone4</pre>
</div>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> peut être configuré plus finement selon vos besoins.
Le réglage suivant s&#8217;assure de faire transiter les données HTTP (scripts, HTML etc.) via la connexion sécurisée entre notre ordinateur et <em>BrowserStack</em>.
C&#8217;est un réglage utile en cas de <strong>proxy exigeant</strong> ou de <strong>réglages de connexion à Internet</strong> bien spécifiques.</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L52-54</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browserStack: {
  forcelocal: true,
},</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>Sauce Labs</em></div>
<div class="paragraph">
<p><em>Sauce Labs</em> est un concurrent de <em>BrowserStack</em> et offre des fonctionnalités similaires.
Il est gratuit pour les projets <em>open source</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://saucelabs.com" class="bare">saucelabs.com</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Indépendamment de <em>BrowserStack</em>, l'<strong>intégration continue</strong> est un mécanisme permettant l'<strong>exécution automatique</strong> des tests, de manière <strong>reproductible</strong> et dans un <strong>environnement systématiquement propre</strong> – sans trace d&#8217;exécution d&#8217;un précédent test.</p>
</div>
<div class="paragraph">
<p>Cela a deux avantages indéniables :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exécuter les <strong>tests pour tout changement de code</strong>, peu importe qui en est l&#8217;auteur ;</p>
</li>
<li>
<p>s&#8217;assurer de l'<strong>exécution systématique des tests</strong> ;</p>
</li>
<li>
<p><strong>mettre en commun</strong> la logique d&#8217;exécution de tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On évite ainsi les <em>oublis</em> tout en enlevant le coût de mise en place de l&#8217;infrastructure de tests chez des personnes contribuant de manière occasionnelle.
Cerise sur le gâteau, on prévient en partie les régressions – changement qui casse le fonctionnement attendu d&#8217;une fonctionnalité.</p>
</div>
<div class="paragraph">
<p>Le service <em>Travis CI</em> (<span class="URL"><a href="https://travis-ci.org" class="bare">travis-ci.org</a></span>) est un service d&#8217;intégration continue (<em>Continuous Integration</em>, <em>CI</em>) parmi d&#8217;autres mais qui a été rendu populaire pour son intégration avec <em>GitHub</em>.
Il est gratuit pour les projets <em>open source</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Installer le programme <code>travis</code></div>
<div class="paragraph">
<p>Le service <em>Travis CI</em> met à disposition un programme en ligne de commande écrit en Ruby.
Ce programme offre divers utilitaires comme le suivi des derniers jobs ainsi que la possibilité de crypter des secrets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ gem install travis --no-doc --no-ri
$ travis login
$ travis help</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un service d&#8217;intégration continue est configuré pour définir ce qui est exécuté <em>avant</em>, <em>pendant</em> et <em>après</em> les tests.
Il a donc l&#8217;avantage de faciliter l&#8217;automatisation des tests de navigateurs web à même la <em>machine virtuelle</em> (<em>Virtual Machine</em>, <em>VM</em>) de test ou bien vers des plates-formes comme <em>BrowserStack</em>.
Son mécanisme de <strong>variables d&#8217;environnement cryptées</strong> nous évitera de donner accès à notre compte au premier venu.</p>
</div>
<div class="paragraph">
<p>Un fichier de configuration minimal au format YAML est nécessaire.
Des services comme <em>GitHub</em> facilitent la connexion avec <em>Travis CI</em> et déclenchent automatiquement l&#8217;exécution des tests à chaque commit ou <em>pull request</em>.</p>
</div>
<div class="listingblock">
<div class="title">.travis.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">sudo: false

language: node_js       # <1>
node_js: v6             # <2>

addons:
  firefox: latest       # <3>

script: xvfb-run npm run test:browser -- --browsers Firefox # <4>

env:
  BROWSER_STACK_USERNAME:
    - secure: …         # <5>
  BROWSER_STACK_ACCESS_KEY:
    - secure: …         # <5></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuration de la <em>VM</em> pour utiliser <em>Node</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuration de la <em>VM</em> pour utiliser la version la plus récente de Node v6 ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Installation de la dernière version stable de <em>Firefox</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>xvfb-run</code> est un programme Linux émulant le rendu d&#8217;une carte graphique vers un écran d&#8217;affichage – il nous aide à lancer Firefox alors que nous n&#8217;avons pas d&#8217;écran ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Les codes d&#8217;accès à <em>BrowserStack</em> sont cryptés à l&#8217;aide du programme Ruby <code>travis</code> via la commande <code>travis encrypt</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>Travis CI</em></div>
<div class="paragraph">
<p>Des services comme <em>Travis CI</em> sont puissants et amplement configurable pour de nombreux besoins, y compris la connexion à des bases de données Postgres ou MariaDB.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs/" class="bare">docs.travis-ci.com/user/languages/javascript-with-nodejs/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/" class="bare">docs.travis-ci.com/user/gui-and-headless-browsers/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/firefox/" class="bare">docs.travis-ci.com/user/firefox/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">8. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous sommes désormais en mesure d'<strong>exécuter des tests unitaires</strong> impliquant des <strong>navigateurs web</strong> sur notre machine, sur des <strong>services distants</strong> mais également de manière automatique avec des services d'<strong>intégration continue</strong> comme <em>Travis CI</em>.</p>
</div>
<div class="paragraph">
<p>Le recours aux modules <em>npm</em> combinés aux modules <em>ECMAScript</em> facilite le <strong>design et la maintenance de code testable et réutilisable</strong>.</p>
</div>
<div class="paragraph">
<p>Ces pratiques de modularisation – jusqu&#8217;au rendu intermédiaire de <em>React</em> – encouragent une <strong>rigueur ayant un impact positif</strong> sur la qualité de notre code et notre confiance à le déployer en production.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-09-06 14:02:03 UTC
</div>
</div>
</body>
</html>