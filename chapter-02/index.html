<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Premiers pas avec Node.js</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style type="text/css">.interactive--javascript code[data-lang]:before {
  content: 'make interactive';
  display: block;
  color: #00c72b;
  font-weight: bold;
  cursor: pointer;
}

.interactive iframe {
  display: none;
}
.interactive.status--loaded iframe {
  display: block;
}

.interactive.status--loading {
  opacity: .5;
}
</style><script src="https://embed.runkit.com/" defer async></script><script>(function(){
        function makeListingInteractive(element){
  if (element.classList.contains('interactive--installed')) {
    return;
  }

  const code = element.querySelector('code');
  const source = code
    .textContent
    .replace(/\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    element: element,
    source: source,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);
    }
  });
}
function installEvents() {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}

        document.addEventListener('DOMContentLoaded', installEvents);
      })();</script>
</head>
<body class="book">
<div id="header">
<h1>Premiers pas avec Node.js</h1>
<div class="details">
<span id="revdate">2017-09-06</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>On aura beau discuter de Node et de son architecture, rien ne vaut quelques lignes de code pour mesurer ce à quoi nous avons affaire.</p>
</div>
<div class="paragraph">
<p>Ce chapitre contient tout ce qu&#8217;il faut savoir pour installer Node et développer son premier programme avec de bons <em>design patterns</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Installer Node.js</p>
</li>
<li>
<p>Comprendre le vocabulaire JavaScript à disposition</p>
</li>
<li>
<p>Écrire son premier programme Node.js</p>
</li>
<li>
<p>Utiliser des modules tiers</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Il est fortement recommandé d&#8217;utiliser un interpréteur de commandes (terminal ou <em>shell</em>). Les systèmes d&#8217;exploitation modernes en proposent un, y compris les versions récentes de Windows.</p>
</div>
<div class="paragraph">
<p>Si vous n&#8217;utilisez pas encore de terminal, voici une liste de recommandations non exhaustive pour vous aider :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>macOS</strong> : iTerm2, Terminal.app ;</p>
</li>
<li>
<p><strong>Linux</strong> : GNOME Shell, Terminator ;</p>
</li>
<li>
<p><strong>Windows</strong> : PowerShell, Console.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/terminal.png" alt="terminal" width="85%">
</div>
<div class="title">Figure 1. Terminal iTerm2 sous macOS.</div>
</div>
</blockquote>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre se réfère aux versions de <strong>Node v6</strong> et <strong>npm v4</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Utilisation des exemples</div>
<div class="paragraph">
<p>Les exemples légendés avec un <em>nom de fichier</em> sont disponibles dans le module <em>npm</em> dédié à cet ouvrage.
Ils sont fonctionnels et destinés à être exécutés sur votre ordinateur :</p>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exécution du bloc de code légendé par <code>currency-main.js</code>.</div>
<div class="content">
<pre>$ npm install --global nodebook@latest
$ nodebook chapter 2
$ node ./examples/currency-main.js</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#_préparer_son_environnement">1. Préparer son environnement</a>
<ul class="sectlevel2">
<li><a href="#_pour_les_différents_systèmes_d_exploitation">1.1. Pour les différents systèmes d&#8217;exploitation</a>
<ul class="sectlevel3">
<li><a href="#_linux">1.1.1. Linux</a></li>
<li><a href="#install-ubuntu">1.1.2. La famille Debian et Ubuntu</a></li>
<li><a href="#install-macos">1.1.3. macOS</a></li>
<li><a href="#_windows">1.1.4. Windows</a></li>
<li><a href="#install-rpi">1.1.5. Raspberry Pi</a></li>
</ul>
</li>
<li><a href="#nvm">1.2. Node Version Manager</a></li>
<li><a href="#install-docker">1.3. Docker</a></li>
<li><a href="#_compiler_depuis_les_sources">1.4. Compiler depuis les sources</a></li>
<li><a href="#ide">1.5. Outils de développement</a>
<ul class="sectlevel3">
<li><a href="#atom">1.5.1. Atom</a></li>
<li><a href="#vs-code">1.5.2. Visual Studio Code</a></li>
<li><a href="#webstorm">1.5.3. WebStorm</a></li>
<li><a href="#vs-ide">1.5.4. Visual Studio IDE</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#unix-legacy">2. L&#8217;héritage UNIX</a>
<ul class="sectlevel2">
<li><a href="#process-env">2.1. Variables d&#8217;environnement</a></li>
<li><a href="#_la_variable_code_path_code">2.2. La variable <code>$PATH</code></a></li>
<li><a href="#_processus">2.3. Processus</a></li>
<li><a href="#_interpréteur">2.4. Interpréteur</a></li>
<li><a href="#_arguments_de_processus_code_argv_code">2.5. Arguments de processus (<code>argv</code>)</a></li>
<li><a href="#_streams_et_redirections">2.6. Streams et redirections</a></li>
</ul>
</li>
<li><a href="#invoke">3. Invoquer Node.js</a>
<ul class="sectlevel2">
<li><a href="#node-repl">3.1. REPL</a></li>
<li><a href="#node-exec">3.2. Exécution de script</a></li>
<li><a href="#node-sh">3.3. Script shell</a>
<ul class="sectlevel3">
<li><a href="#npm-scripts">3.3.1. Scripts npm</a></li>
</ul>
</li>
<li><a href="#_arguments_d_invocation">3.4. Arguments d&#8217;invocation</a></li>
<li><a href="#_plantage_applicatif">3.5. Plantage applicatif</a></li>
</ul>
</li>
<li><a href="#_node_javascript_et_ecmascript">4. Node, JavaScript et ECMAScript</a>
<ul class="sectlevel2">
<li><a href="#_standard_ecma_262_edition_5">4.1. Standard ECMA-262 Edition 5</a></li>
<li><a href="#_standard_ecma_262_edition_2015_2016_etc">4.2. Standard ECMA-262 Edition 2015, 2016 etc.</a></li>
<li><a href="#primitives">4.3. Rappel des primitives ECMAScript</a>
<ul class="sectlevel3">
<li><a href="#_string">4.3.1. String</a></li>
<li><a href="#primitive-boolean">4.3.2. Boolean</a></li>
<li><a href="#_number">4.3.3. Number</a></li>
<li><a href="#primitive-function">4.3.4. Function</a></li>
<li><a href="#primitive-array">4.3.5. Array</a></li>
<li><a href="#primitive-object">4.3.6. Object</a></li>
<li><a href="#_date">4.3.7. Date</a></li>
<li><a href="#primitive-destructuring">4.3.8. Décomposition</a></li>
<li><a href="#primitive-rest">4.3.9. Paramètres du reste</a></li>
<li><a href="#primitive-map-set">4.3.10. Map et Set</a></li>
<li><a href="#primitive-class">4.3.11. Class</a></li>
<li><a href="#primitive-promise">4.3.12. Promise</a></li>
<li><a href="#primitive-async-await">4.3.13. async/await</a></li>
<li><a href="#primitive-regexp">4.3.14. RegExp</a></li>
<li><a href="#primitive-json">4.3.15. JSON</a></li>
</ul>
</li>
<li><a href="#globals">4.4. Variables globales dans Node.js</a>
<ul class="sectlevel3">
<li><a href="#_console">4.4.1. console</a></li>
<li><a href="#api-process">4.4.2. process</a></li>
<li><a href="#_module">4.4.3. module</a></li>
<li><a href="#api-require">4.4.4. require</a></li>
<li><a href="#_filename_et_dirname">4.4.5. __filename et __dirname</a></li>
<li><a href="#_settimeout_setinterval_et_setimmediate">4.4.6. setTimeout, setInterval et setImmediate</a></li>
<li><a href="#">4.4.7. _</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_design_patterns">5. Design patterns</a>
<ul class="sectlevel2">
<li><a href="#_code_synchrone_et_asynchrone">5.1. Code synchrone et asynchrone</a></li>
<li><a href="#_code_bloquant_et_non_bloquant">5.2. Code bloquant et non-bloquant</a></li>
<li><a href="#_index_js">5.3. index.js</a></li>
<li><a href="#_globbing">5.4. Globbing</a></li>
<li><a href="#_injection_de_module">5.5. Injection de module</a></li>
<li><a href="#pattern-callback">5.6. Callback</a></li>
<li><a href="#_event">5.7. Event</a></li>
<li><a href="#pattern-promise">5.8. Promesses</a></li>
<li><a href="#streams">5.9. Streams</a></li>
</ul>
</li>
<li><a href="#_bien_utiliser_npm_au_quotidien">6. Bien utiliser npm au quotidien</a>
<ul class="sectlevel2">
<li><a href="#_npm">6.1. npm</a></li>
<li><a href="#_initialiser_un_projet_node">6.2. Initialiser un projet Node</a></li>
<li><a href="#_installer_une_application_node">6.3. Installer une application Node</a></li>
<li><a href="#_installer_un_module_em_npm_em">6.4. Installer un module <em>npm</em></a></li>
<li><a href="#_comprendre_em_npm_em_et_son_organisation_du_répertoire_em_node_modules_em">6.5. Comprendre <em>npm</em> et son organisation du répertoire <em>node_modules</em></a></li>
<li><a href="#_trouver_son_bonheur_dans_le_em_registre_npm_em">6.6. Trouver son bonheur dans le <em>registre npm</em></a></li>
<li><a href="#_exécuter_les_tests">6.7. Exécuter les tests</a></li>
<li><a href="#npm-outdated">6.8. Vérifier et mettre à jour les dépendances</a></li>
</ul>
</li>
<li><a href="#_conclusion">7. Conclusion</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_préparer_son_environnement">1. Préparer son environnement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Installer Node n&#8217;est pas très compliqué.
Il existe cependant plusieurs mécanismes d&#8217;installation.
Ces mécanismes vont du téléchargement d&#8217;un installeur à une compilation manuelle <em>via</em> un terminal.</p>
</div>
<div class="paragraph">
<p>Voici mes recommandations pour savoir quelle solution d&#8217;installation choisir :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>néophyte ou pressé(e)</strong> : installeur du site nodejs.org, paquet fourni par le système d&#8217;exploitation ;</p>
</li>
<li>
<p><strong>vous commencez à maîtriser</strong> : Node Version Manager ;</p>
</li>
<li>
<p><strong>à l&#8217;aise avec un terminal</strong> : Node Version Manager ;</p>
</li>
<li>
<p><strong>envie ou besoin de mettre en production</strong> : Node Version Manager ;</p>
</li>
<li>
<p><strong>besoin très spécifique et pointu</strong> : compiler depuis les sources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;utilisation et les fonctionnalités de <em>nvm</em> sont détaillées <a href="#nvm">ci-après</a>.</p>
</div>
<div class="paragraph">
<p>Une fois l&#8217;étape de l&#8217;installation terminée, la suite du livre ne fera plus de distinction entre les différents systèmes d&#8217;exploitation : c&#8217;est Node qui se chargera des abstractions !</p>
</div>
<div class="sect2">
<h3 id="_pour_les_différents_systèmes_d_exploitation">1.1. Pour les différents systèmes d&#8217;exploitation</h3>
<div class="paragraph">
<p>Certains systèmes d&#8217;exploitation fournissent leur propre mouture de Node.
Les procédures les plus courantes sont décrites ci-après.</p>
</div>
<div class="paragraph">
<p>Une liste complète des systèmes supportés est maintenue à jour à cette adresse : <span class="URL"><a href="https://nodejs.org/en/download/package-manager/" class="bare">nodejs.org/en/download/package-manager/</a></span>.</p>
</div>
<div class="paragraph">
<p>Si malgré tout votre système n&#8217;y était pas listé, le mieux reste encore d'<strong>utiliser un binaire</strong>, de <strong>compiler depuis les sources</strong> ou de demander à votre <strong>moteur de recherche</strong> favori !</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">URL</span> Téléchargements officiels</div>
<div class="paragraph">
<p>Les installeurs, les binaires et les sources de Node sont disponibles sur le site officiel de Node.<br>
Téléchargez l&#8217;installeur adapté, ouvrez un terminal et sautez quelques pages pour plonger dans l&#8217;utilisation de Node.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/download/" class="bare">nodejs.org/download/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_linux">1.1.1. Linux</h4>
<div class="paragraph">
<p>Node est disponible dans les dépôts officiels des systèmes suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Gentoo</strong> : <code>emerge nodejs</code></p>
</li>
<li>
<p><strong>Ubuntu &gt;= 12.04</strong>, <strong>Debian &gt;= jessie</strong>, <strong>Mint</strong> : <a href="#install-ubuntu">voir ci-après</a></p>
</li>
<li>
<p><strong>Fedora &gt;= 18</strong> : <code>sudo yum install nodejs npm</code></p>
</li>
<li>
<p><strong>Red Hat Enterprise</strong> et <strong>CentOS</strong> : <code>sudo yum install nodejs npm --enablerepo=epel</code></p>
</li>
<li>
<p><strong>Arch Linux</strong> : <code>pacman -S nodejs</code></p>
</li>
<li>
<p><strong>FreeBSD</strong>, <strong>OpenBSD</strong> : <code>pkg install node</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si votre système d&#8217;exploitation ne dispose pas de paquet pour Node, essayez dans l&#8217;ordre :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#nvm">Node Version Manager</a> (voir ci-après) ;</p>
</li>
<li>
<p>le téléchargement du binaire Node sur son site officiel ;</p>
</li>
<li>
<p>la compilation manuelle de Node.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="install-ubuntu">1.1.2. La famille Debian et Ubuntu</h4>
<div class="paragraph">
<p>Le paquet officiel <code>nodejs</code> fourni dans les dépôts <code>apt</code> est à éviter pour deux raisons :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>le client <em>npm</em> n&#8217;est pas installé par défaut ;</p>
</li>
<li>
<p>le paquet n&#8217;est ni à jour ni bien maintenu.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La société <em>NodeSource</em> (<span class="URL"><a href="https://nodesource.com/" class="bare">nodesource.com/</a></span>) maintient des binaires ainsi que des dépôts pour différentes distributions Linux.<br>
L&#8217;installation d&#8217;une version à jour Node sous Debian, Ubuntu et consors devient aussi simple que les deux commandes suivantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
sudo apt-get install -y nodejs</pre>
</div>
</div>
<div class="paragraph">
<p>D&#8217;autres informations et architectures sont détaillées sur le dépôt GitHub des distributions <em>NodeSource</em> : <span class="URL"><a href="https://github.com/nodesource/distributions" class="bare">github.com/nodesource/distributions</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="install-macos">1.1.3. macOS</h4>
<div class="paragraph">
<p><em>macOS</em> ne dispose pas de gestionnaire de paquet par défaut.
Quelques projets populaires permettent toutefois d&#8217;y remédier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>homebrew</strong> : <code>brew install node</code></p>
</li>
<li>
<p><strong>MacPorts</strong> : <code>port install nodejs</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si vous n&#8217;utilisez aucun de ces gestionnaires de paquet, vous pouvez essayez :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#nvm">Node Version Manager</a> (voir ci-après) ;</p>
</li>
<li>
<p>le téléchargement du binaire Node sur son site officiel ;</p>
</li>
<li>
<p>la compilation manuelle de Node.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_windows">1.1.4. Windows</h4>
<div class="paragraph">
<p>Le moyen le plus simple d&#8217;installer Node sous Windows est de <strong>télécharger l&#8217;installeur officiel</strong> depuis la page de téléchargements de Node.</p>
</div>
<div class="paragraph">
<p>Toutefois si vous utilisez déjà un gestionnaire de paquet, voici quelques recommandations :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>scoop.sh</strong> : <code>scoop install nodejs</code></p>
</li>
<li>
<p><strong>Chocolatey</strong> : <code>choco install nodejs</code></p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/node-on-windows.png" alt="node on windows" width="85%">
</div>
</div>
<div class="paragraph">
<p>Un raccourci pour lancer un terminal préparé pour Node et les commandes <em>npm</em> sera mis à disposition dans le <em>menu Windows</em> (voir capture ci-contre).</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Versions supportées de Windows</div>
<div class="paragraph">
<p>Windows XP, Windows Vista et les versions antérieures à celles-ci ne sont pas supportées.</p>
</div>
<div class="paragraph">
<p>Il est déconseillé d&#8217;utiliser une version plus ancienne de Node pour contourner ce comportement.
Il en va de la <strong>sécurité de vos applications</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="install-rpi">1.1.5. Raspberry Pi</h4>
<div class="paragraph">
<p>Node a effectué des changements dans son architecture dans sa version 0.8.
Ces changements ont permis d&#8217;éviter la compilation systématique sur des architectures processeur autre que l&#8217;Intel x86.</p>
</div>
<div class="paragraph">
<p>Des binaires et installeurs sont de ce fait disponibles pour Raspberry Pi, à base de processeur <em>ARM</em>, entre autres.</p>
</div>
<div class="paragraph">
<p>Des binaires et instructions sont disponibles sur le site officiel de Node, pour ARMv6, ARMv7 et ARMv8 : <span class="URL"><a href="https://nodejs.org/en/download/" class="bare">nodejs.org/en/download/</a></span>.</p>
</div>
<div class="listingblock">
<div class="title">Installation de Node v6 sur Raspberry Pi Model 3 ARMv8</div>
<div class="content">
<pre>curl -SLO https://nodejs.org/dist/v6.9.4/node-v6.9.4-linux-arm64.tar.xz
tar -xJf "node-v6.9.4-linux-arm64.tar.xz" -C /usr/local --strip-components=1
ln -s /usr/local/bin/node /usr/local/bin/nodejs</pre>
</div>
</div>
<div class="paragraph">
<p>Un paquet <code>deb</code> est également proposé pour les utilisateurs du système d&#8217;exploitation <em>Raspbian</em>.
Les instructions sont identiques à celles décrites dans la section précédente relative à <a href="#install-ubuntu">la famille Debian et Ubuntu</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="nvm">1.2. Node Version Manager</h3>
<div class="paragraph">
<p><em>Node Version Manager</em> est un logiciel permettant de gérer plusieurs versions de Node en même temps, sur une même machine.
Il est communément abrégé en <em>nvm</em>.</p>
</div>
<div class="paragraph">
<p><em>nvm</em> est l&#8217;équivalent de <em>rvm</em> dans le monde Ruby, de <em>phpenv</em> dans le monde PHP ou encore de <em>virtualenv</em> pour Python.</p>
</div>
<div class="listingblock">
<div class="title">Installation de <em>nvm</em> et de Node v6 sur un environnement Linux.</div>
<div class="content">
<pre>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh | bash
nvm install v6
nvm alias default v6  <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La version par défaut est désormais la dernière version stable de Node v6.</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/nvm-terminal.png" alt="nvm terminal" width="85%">
</div>
<div class="title">Figure 2. Liste des versions installées de Node.</div>
</div>
<div class="paragraph">
<p>Les instructions d&#8217;installation à jour se trouvent sur <span class="URL"><a href="https://github.com/creationix/nvm" class="bare">github.com/creationix/nvm</a></span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>n</em></div>
<div class="paragraph">
<p><em>n</em> est une alternative à <em>nvm</em> écrite en… JavaScript.
Elle a l&#8217;avantage d&#8217;être compatible avec tous les systèmes d&#8217;exploitation compatibles avec le Shell Unix <em>Bash</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.npmjs.com/n" class="bare">www.npmjs.com/n</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> Et pour Windows ?</div>
<div class="paragraph">
<p><em>nvm</em> ne fonctionne pas sur les ordinateurs équipés de Windows.
Il existe trois autres alternatives : <em>nvm-windows</em>, <em>_nvmw</em> et <em>nodist</em>.</p>
</div>
<div class="paragraph">
<p><em>nvmw</em> nécessite d&#8217;avoir Git et Python tandis que <em>nodist</em> se base uniquement sur Node.
Dans les deux cas, leur installation est très simple.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/coreybutler/nvm-windows" class="bare">github.com/coreybutler/nvm-windows</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://github.com/hakobera/nvmw" class="bare">github.com/hakobera/nvmw</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://github.com/marcelklehr/nodist" class="bare">github.com/marcelklehr/nodist</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="install-docker">1.3. Docker</h3>
<div class="paragraph">
<p><em>Docker</em> est un outil d&#8217;isolation de processus système qui a le vent en poupe depuis 2014.
Sa qualité principale est d&#8217;isoler les dépendances logicielles du système qui exécute le-dit processus.
Une image Docker aura la même recette d&#8217;installation même si celle-ci est exécutée sous Linux, macOS ou encore Windows.</p>
</div>
<div class="paragraph">
<p>Lancer un interpréteur Node <em>sans polluer</em> le système hôte revient à exécuter l&#8217;image suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run -ti --rm node:6-slim</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;intégralité des versions et architectures supportées est disponible sur le <em>Docker Hub</em> : <span class="URL"><a href="https://hub.docker.com/_/node/" class="bare">hub.docker.com/_/node/</a></span></p>
</div>
<div class="paragraph">
<p>Nous nous repencherons sur Docker dans la section  <a href="../chapter-06/index.html#immutable-deploy">section <em>Déploiement immutable</em></a> du Chapitre 6.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_depuis_les_sources">1.4. Compiler depuis les sources</h3>
<div class="paragraph">
<p>Certaines situations exigeront que vous compiliez Node.
Ce sera le cas si vous cherchez à tirer parti au maximum des instructions de votre CPU ou si aucun binaire n&#8217;est disponible pour votre plate-forme.</p>
</div>
<div class="paragraph">
<p>La compilation manuelle requiert la présence de <em>GCC</em> 4.2+, de <em>Python</em> 2.6+ et de <em>GNU Make</em> 3.81+.<br>
La procédure de compilation ressemble fortement à ceci :</p>
</div>
<div class="listingblock">
<div class="title">Étapes de compilation de Node</div>
<div class="content">
<pre>curl -sS \
  https://nodejs.org/dist/v6.9.4/node-v6.9.4.tar.gz \
  | tar -zxf -
cd node-v6.9.4
./configure &amp;&amp; make &amp;&amp; make install</pre>
</div>
</div>
<div class="paragraph">
<p>Les instructions pouvant varier fortement d&#8217;un système d&#8217;exploitation à l&#8217;autre, consultez les dépendances et instructions complètes à cette adresse <span class="URL"><a href="https://github.com/nodejs/node/wiki/installation" class="bare">github.com/nodejs/node/wiki/installation</a></span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="ide">1.5. Outils de développement</h3>
<div class="paragraph">
<p>Programmer pour Node revient dans la majorité des cas à écrire du JavaScript.
Donc même si un éditeur de texte suffit, il est intéressant de connaître l&#8217;offre en outillage autour de Node et du développement front-end.</p>
</div>
<div class="paragraph">
<p>Les logiciels présentés dans les pages suivantes couvrent un large spectre de besoins : écriture du code, coloration syntaxique, inspection dynamique, débogage, productivité et intégration à l&#8217;écosystème Node.</p>
</div>
<div class="paragraph">
<p>Ceci a pour but de vous aider à piocher au plus près de vos goûts, à défaut de continuer à utiliser votre logiciel habituel.</p>
</div>
<div class="sect3">
<h4 id="atom">1.5.1. Atom</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/atom.png" alt="atom" width="85%">
</div>
</div>
<div class="paragraph">
<p><em>Atom</em> est un éditeur de code open-source, multilingue et multi plate-forme dont le développement a été initié par la société <em>GitHub</em>.
Le logiciel est basé sur <em>Electron</em>, un environnent d&#8217;exécution d&#8217;applications de bureau reposant sur Node et HTML5.</p>
</div>
<div class="paragraph">
<p><em>Atom</em> offre un écosystème de paquets pour étendre les fonctionnalités de l&#8217;éditeur à la carte.
L&#8217;expérience de développement sous Node en est ainsi facilitée grâce à des paquets dédiés à l&#8217;auto-complétion, un débogueur intégré mais aussi une vérification syntaxique sur mesure.<br>
Une sélection de paquets vous attend dans l'<a href="../appendix-a.html#atom">annexe A</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://atom.io/" class="bare">atom.io/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://atom.io/packages/" class="bare">atom.io/packages/</a></span></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="vs-code">1.5.2. Visual Studio Code</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/visual-studio-code.png" alt="visual studio code" width="85%">
</div>
</div>
<div class="paragraph">
<p><em>Visual Studio Code</em> est un éditeur de code open-source, multilingue et multi plate-forme dont le développement a été initié par la société <em>Microsoft</em>.
Le logiciel est basé sur <em>Electron</em>, un environnent d&#8217;exécution d&#8217;applications de bureau reposant sur Node et HTML5.</p>
</div>
<div class="paragraph">
<p>Un de ses atouts principaux réside dans son système <em>IntelliSense</em>.
Il se sert du contexte disponible pour offrir une auto-complétion et des bulles d&#8217;aide pertinentes.
C&#8217;est un éditeur parfaitement adapté au développement d&#8217;applications Node grâce à des fonctionnalités natives comme l&#8217;exécution, le débogage, la gestion de tâches et le versionnement – du code et des modules <em>npm</em>.</p>
</div>
<div class="paragraph">
<p><em>Visual Studio Code</em> offre également un écosystème de paquets pour étendre les fonctionnalités de l&#8217;éditeur à la carte.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://code.visualstudio.com/" class="bare">code.visualstudio.com/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://marketplace.visualstudio.com/VSCode" class="bare">marketplace.visualstudio.com/VSCode</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://code.visualstudio.com/Docs/runtimes/nodejs" class="bare">code.visualstudio.com/Docs/runtimes/nodejs</a></span></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="webstorm">1.5.3. WebStorm</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/webstorm.png" alt="webstorm" width="85%">
</div>
</div>
<div class="paragraph">
<p><em>WebStorm</em> est un environnement de développement (<em>IDE</em>) dédié au développement Web HTML5, JavaScript et Node.<br>
Le logiciel est commercialisé par la société <em>JetBrains</em>, principalement connue pour ses <em>IDE</em> <em>Pycharm</em> (pour Python), <em>PhpStorm</em> (pour PHP) et <em>IntelliJ IDEA</em> (pour Java).</p>
</div>
<div class="paragraph">
<p><em>WebStorm</em> est compatible Windows, Linux et macOS.
Ses forces résident dans sa relative légèreté, une auto-complétion intelligente prenant en compte la résolution des modules CommonJS et AMD, une intégration des outils populaires dans l&#8217;écosystème Node (npm, eslint, Mocha, Karma, Bower etc.) ainsi qu&#8217;un débogage avancé.</p>
</div>
<div class="paragraph">
<p>Le téléchargement de <em>WebStorm</em> inclut une période d&#8217;essai de 30 jours.</p>
</div>
<div class="paragraph">
<p><span class="URL"><a href="https://www.jetbrains.com/webstorm/" class="bare">www.jetbrains.com/webstorm/</a></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Licence open source.</div>
<div class="paragraph">
<p>Vous pouvez demander à bénéficier d&#8217;une licence gratuite sous réserve d&#8217;une contribution active à un ou plusieurs projets open source.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.jetbrains.com/buy/opensource/" class="bare">www.jetbrains.com/buy/opensource/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="vs-ide">1.5.4. Visual Studio IDE</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/visual-studio.png" alt="visual studio" width="85%">
</div>
</div>
<div class="paragraph">
<p><em>Visual Studio</em> est un environnement de développement <em>(IDE)</em> édité par  <em>Microsoft</em>.
Historiquement dédié au développement sur Windows (Visual Basic, Visual C++), il gère aujourd&#8217;hui bien plus de langages (dont C#, HTML, CSS, JavaScript, ASP.Net).
Il est surtout extensible, ce qui permet, entre autres, de lui apporter le support de <em>Python</em> ou encore Node.</p>
</div>
<div class="paragraph">
<p><em>Visual Studio</em> est uniquement compatible Windows et existe en plusieurs éditions dont la <em>Community Edition</em>.
Elle est gratuite et permet aussi l&#8217;ajout d&#8217;extensions.</p>
</div>
<div class="paragraph">
<p>Afin de bénéficier de l&#8217;intégration complète de l&#8217;écosystème Node, il est nécessaire d&#8217;installer l&#8217;extensions <em>Node.js Tools for Visual Studio</em> (aussi nommée <em>NTVS</em>).
Elle est gratuite, open source et disponible sur GitHub.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.visualstudio.com/vs/" class="bare">www.visualstudio.com/vs/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://www.visualstudio.com/vs/node-js/" class="bare">www.visualstudio.com/vs/node-js/</a></span></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unix-legacy">2. L&#8217;héritage UNIX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Node peut paraître étrange selon notre propre familiarité avec la programmation système, avec les environnements UNIX (et dont découle GNU/Linux) et certains de leurs concepts.</p>
</div>
<div class="paragraph">
<p>Node étant une plate-forme utilisant JavaScript pour discuter avec une machine virtuelle connectée au système d&#8217;exploitation, il est intéressant de se remémorer des aspects un peu plus bas niveau.</p>
</div>
<div class="sect2">
<h3 id="process-env">2.1. Variables d&#8217;environnement</h3>
<div class="paragraph">
<p>Lorsqu&#8217;un système d&#8217;exploitation est en état de marche, différents programmes fonctionnent pour fournir différents services : transmission du son, affichage vidéo, coordination des processus et de leurs ressources etc.</p>
</div>
<div class="paragraph">
<p>Ces programmes utilisent des espaces mémoire exclusifs, d&#8217;autres des espaces mémoire partagés.
Un de ces espaces partagés contient des <strong>variables</strong> décrivant l'<em>environnement</em> dans lequel l&#8217;ensemble des programmes évoluent.
Ces variables peuvent être utilisées par chacun de ces programmes.</p>
</div>
<div class="paragraph">
<p>Il est possible de les lister en utilisant la commande <code>env</code> :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/unix-env.png" alt="unix env" width="85%">
</div>
</div>
<div class="paragraph">
<p>Il nous est également possible d&#8217;en créer de nouvelles avec un syntaxe de <code>CLÉ=VALEUR</code>.
L&#8217;exemple suivant illustre la création d&#8217;une telle variable, son affichage puis son affichage en faisant appel à un autre programme, en l&#8217;occurence Node :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ TEST=1
$ echo $TEST
$ node -p 'process.env.TEST'</pre>
</div>
</div>
<div class="paragraph">
<p>Nous nous heurtons à la portée des variables, locale à la session de notre terminal mais pas à l&#8217;interpréteur Node.
La <em>portée</em> est réduite à notre session uniquement.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant assigne une valeur à une variable d&#8217;environnement au niveau de l'<em>exécution d&#8217;un programme</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ TEST=1 node -p 'process.env.TEST'
$ echo $TEST</pre>
</div>
</div>
<div class="paragraph">
<p>La valeur <code>1</code> est affichée dans le processus Node mais pas dans notre session.
La <em>portée</em> est réduite à l&#8217;invocation uniquement.</p>
</div>
<div class="paragraph">
<p>Un opérateur permet de propager une variable, de l'<em>exporter</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ export TEST=1
$ node -p 'process.env.TEST'</pre>
</div>
</div>
<div class="paragraph">
<p>Cet exemple nous a permis de définir une variable en dehors d&#8217;une invocation et de la rendre utilisable dans un autre processus.</p>
</div>
<div class="paragraph">
<p><code>env</code> affiche toutes les variables <em>exportées</em>.
<code>local</code> ou <code>set</code> affichent toutes les variables <em>locales</em> et <em>exportées</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_variable_code_path_code">2.2. La variable <code>$PATH</code></h3>
<div class="paragraph">
<p>La variable d&#8217;environnement <code>$PATH</code> est importante.
C&#8217;est son contenu qui régit où le système d&#8217;exploitation va chercher quel programme exécuter lorsque son nom est invoqué dans un terminal.</p>
</div>
<div class="paragraph">
<p>Prenons par exemple cette commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node --version</pre>
</div>
</div>
<div class="paragraph">
<p>Où se trouve <code>node</code> sur notre système ?
Une autre commande nous permet de le savoir :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ which node
/usr/bin/node</pre>
</div>
</div>
<div class="paragraph">
<p>La valeur de <code>$PATH</code> est une liste de chemins séparés par le symbole <code>:</code>, par exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</pre>
</div>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;on demande l&#8217;exécution d&#8217;un programme – <code>node</code> par exemple – le système d&#8217;exploitation balaie chacun des répertoires du <code>$PATH</code> à la recherche d&#8217;un fichier exécutable nommé <code>node</code>.
L&#8217;algorithme est le suivant :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>node</code> trouvé dans <code>/usr/local/bin</code> ? Non ;</p>
</li>
<li>
<p><code>node</code> trouvé dans <code>/usr/bin</code> ? Oui.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La recherche s&#8217;arrête là, le chemin du programme est retourné et ledit programme est alors exécuté.</p>
</div>
<div class="paragraph">
<p>Certaines sections du livre feront mention à cette variable <code>$PATH</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_processus">2.3. Processus</h3>
<div class="paragraph">
<p>Un processus est un ensemble comprenant un <em>programme</em>, les <em>variables</em> actives et la <em>mémoire</em> allouée.
Chaque processus est identifié de manière unique avec un identifiant (<code>pid</code> – <em>process identifier</em>)</p>
</div>
<div class="paragraph">
<p>Un même programme peut être exécuté plusieurs fois en parallèle, à quelques exceptions près.
Chaque exécution se déroule dans un espace de mémoire isolé de tout autre exécution du même programme.<br>
Une exception notable est le cas des <em>sous-process</em> (<em>child process</em>) où certaines ressources peuvent être partagées.</p>
</div>
<div class="paragraph">
<p>Dans les architectures processeur classiques (les <code>x86</code> notamment), un processus fonctionne sur un seul processeur (<em>CPU</em>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_interpréteur">2.4. Interpréteur</h3>
<div class="paragraph">
<p>Quand un programme est exécuté, le système d&#8217;exploitation fait face à deux options :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>le fichier est un <em>binaire</em> compilé pour une architecture <em>CPU</em> compatible ;</p>
</li>
<li>
<p>le fichier est un <em>script exécutable</em> (code source lisible à l&#8217;œil nu), auquel cas il doit recourir à un <em>interpréteur</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On peut avoir recourt à un interpréteur directement en faisant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bash mon-script.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Ou bien en débutant <code>mon-script.sh</code> par <code>#!/usr/bin/env bash</code> pour sélectionner l&#8217;interpréteur <code>bash</code> (généralement disponible en tant que <code>/bin/bash</code>) puis en exécutant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ chmod +x mon-script.sh
$ ./mon-script.sh</pre>
</div>
</div>
<div class="paragraph">
<p>On peut ainsi décider quel interpréteur sera employé pour comprendre le script, le transformer en langage machine et l&#8217;exécuter à la volée.</p>
</div>
</div>
<div class="sect2">
<h3 id="_arguments_de_processus_code_argv_code">2.5. Arguments de processus (<code>argv</code>)</h3>
<div class="paragraph">
<p>Exécuter un programme peut parfois nécessiter un paramétrage contextuel et indépendant de la valeur des variables d&#8217;environnement.
On lui passe ainsi des <em>paramètres</em> ou <em>arguments</em> qui lui sont spécifiques.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ FOO_VAL='bar'
$ ./argv.sh --foo=$FOO_VAL toto</pre>
</div>
</div>
<div class="paragraph">
<p>Ces arguments de processus sont disponibles de manière brute, itérable sous forme de liste :</p>
</div>
<div class="listingblock">
<div class="title">argv.sh</div>
<div class="content">
<pre class="highlight"><code>#!/usr/bin/env bash

echo $@ <i class="conum" data-value="1"></i><b>(1)</b>

for ARG in $@; do
  echo "Argument $ARG"; <i class="conum" data-value="2"></i><b>(2)</b>
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>--foo=bar toto</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche tour à tour <code>--foo=bar</code> puis <code>toto</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans Node, vous retrouverez ces arguments dans la variable <a href="#api-process">process.argv</a>, détaillée par ailleurs dans ce même chapitre.</p>
</div>
</div>
<div class="sect2">
<h3 id="_streams_et_redirections">2.6. Streams et redirections</h3>
<div class="paragraph">
<p>La dernière pierre angulaire des concepts UNIX est la présence des <em>flux de données</em> (<em>streams</em>) et de <em>redirection de flux</em> (<em>pipes</em>).
L&#8217;idée est de pouvoir créer des programmes <em>solides</em>, résistant au temps et interopérables entre eux – peu importe leur interpréteur.</p>
</div>
<div class="paragraph">
<p>Un programme peut être amené à produire un <strong>flux de données</strong> et à le <strong>rediriger</strong> vers un emplacement, que ce soit un <em>fichier</em> (avec <code>&gt;</code>), un <em>terminal</em> d&#8217;affichage ou un <em>autre programme</em> (avec <code>|</code>) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ date                    <i class="conum" data-value="1"></i><b>(1)</b>
$ date &gt; date.txt         <i class="conum" data-value="2"></i><b>(2)</b>
$ date | grep -Eo "\d{4}" <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Redirection implicite vers le <em>terminal</em> – affiche la date du jour ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Redirection vers un <em>fichier</em> – rien n&#8217;est affiché.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Redirection vers un <em>programme</em> puis vers le <em>terminal</em> – affiche l&#8217;année courante.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un programme peut ainsi être spécialisé dans l'<em>affichage</em> des processus, un autre dans le <em>filtrage</em> puis un autre dans l'<em>extraction</em> de valeurs.
Cette pratique poussée de la modularité encourage la <strong>combinaison</strong> plutôt que le <strong>tout-en-un</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;affichage de données d&#8217;une session utilisateur, dans l&#8217;optique d&#8217;obtenir le nom du terminal (<code>TTY</code>) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ w
10:33  up 5 days, 18:48, 5 users, load averages: 1.36 1.62 1.75
USER     TTY      FROM              LOGIN@  IDLE WHAT
oncletom console  -                Fri15   5days -</pre>
</div>
</div>
<div class="paragraph">
<p>Nous isolons la troisième ligne :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ w | head -n 3 | tail -n 1 <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En vrai, nous isolons les trois premières lignes avec <code>head</code> pour n&#8217;en garder que la dernière avec <code>tail</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Et finalement la valeur contenue dans la deuxième colonne avec <code>awk</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ w | head -n 3 | tail -n 1 | awk '{ print $2 }'</pre>
</div>
</div>
<div class="paragraph">
<p>Vous pourrez en savoir plus sur le sujet dans la section <a href="#streams">streams</a> de ce même chapitre.</p>
</div>
<div class="paragraph">
<p>Maintenant que nous avons vu tous ces concepts, reposons-nous le cerveau en parlant JavaScript.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="invoke">3. Invoquer Node.js</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est bien beau de parler d&#8217;histoire, d&#8217;architecture et d&#8217;interpréteur mais concrètement, comment exécuter du code écrit pour Node ?</p>
</div>
<div class="paragraph">
<p>La plate-forme Node fournit un exécutable système : <code>node</code>. C&#8217;est lui qui digèrera votre code, préparé à l&#8217;avance ou non :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>node</code> invoquera le <em>REPL</em>, un interpréteur interactif ;</p>
</li>
<li>
<p><code>node votre-script.js</code> invoquera le dit script.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="node-repl">3.1. REPL</h3>
<div class="paragraph">
<p>Un <em>REPL</em> est un interpréteur interactif exécuté dans votre terminal.
Une fois invoqué, toutes les instructions écrites dans le terminal seront interprétées dès que vous presserez la touche <kbd>ENTRÉE</kbd></p>
</div>
<div class="paragraph">
<p>L&#8217;intérêt principal d&#8217;utiliser le <em>REPL</em> est de prototyper rapidement du code ; code que l&#8217;on pourra éventuellement sauvegarder en tapant <span class="keyseq"><kbd>.</kbd>+<kbd>S</kbd>+<kbd>A</kbd>+<kbd>V</kbd>+<kbd>E</kbd>+<kbd>ENTRÉE</kbd></span>.</p>
</div>
<div class="paragraph">
<p>Autre exemple : vous écrivez un programme qui nécessite que l&#8217;utilisateur saisisse lui-même du code à faire interpréter par Node.
On pourrait penser à un programme en ligne de commande éducatif ou encore à une interface web qui commanderait un <em>REPL</em> distant.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/node-repl.png" alt="node repl" width="85%">
</div>
</div>
<div class="paragraph">
<p>Le <em>REPL</em> lui-même est écrit en ECMAScript.
Il est disponible dans le module Node natif <code>repl</code> dont la documentation est disponible à l&#8217;adresse suivante : <span class="URL"><a href="https://nodejs.org/api/repl.html" class="bare">nodejs.org/api/repl.html</a></span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="node-exec">3.2. Exécution de script</h3>
<div class="paragraph">
<p>L&#8217;exécution d&#8217;un script est très certainement l&#8217;invocation la plus classique de Node.</p>
</div>
<div class="paragraph">
<p>Node tente de charger et d&#8217;exécuter le fichier mentionné en argument de l&#8217;exécutable <code>node</code>.
Le processus Node reste actif tant que l'<em>Event Loop</em> a des instructions à traiter dans le futur.</p>
</div>
<div class="paragraph">
<p>Un certain nombre d&#8217;options sont acceptées par l&#8217;exécutable et modifient son comportement en conséquent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>node debug votre-script.js</code> : active le mode débogage ;</p>
</li>
<li>
<p><code>NODE_ENV=production node votre-script.js</code> : transmet une variable d&#8217;environnement au processus et est accessible sous la forme <code>process.env.NODE_ENV</code>.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/node-exec.png" alt="node exec" width="85%">
</div>
</div>
<div class="paragraph">
<p>Pour connaître l&#8217;ensemble des options disponibles de l&#8217;exécutable Node, tapez <code>node --help</code> dans votre terminal.
Plusieurs options pourraient vous intéresser :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-e</code> (ou <code>--eval</code>) : évalue du code ;</p>
</li>
<li>
<p><code>-p</code> (ou <code>--print</code>) : évalue et affiche le code ;</p>
</li>
<li>
<p><code>-r</code> (ou <code>--require</code>) : inclue un module ;</p>
</li>
<li>
<p><code>--harmony</code> (ou tout sous-ensemble de type <code>--harmony-xx</code>) : active des fonctionnalités expérimentales ;</p>
</li>
<li>
<p><code>--v8-options</code> : passe des options à la <a href="../chapter-01.html#v8">VM V8</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;option <code>-p</code> est idéale pour évaluer du code en une ligne et visualier un résultat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node -p 'Date()';
Tue Jan 24 2017 12:42:02 GMT+0100 (CET)

$ FIRST_NAME='Thomas' node -p '`Bonjour ${process.env.FIRST_NAME}`'
Bonjour Thomas</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="node-sh">3.3. Script shell</h3>
<div class="paragraph">
<p>Une autre alternative est de créer un fichier exécutable et de spécifier Node en tant qu&#8217;interpréteur.
C&#8217;est une opération utile pour rendre un programme accessible s&#8217;il est situé dans le <code>$PATH</code> système ou pour rendre un programme accessible lors de l&#8217;installation globale d&#8217;un <em>paquet npm</em>, entre autres.</p>
</div>
<div class="paragraph">
<p>Pour qu&#8217;un fichier soit rendu exécutable, nous devons nous assurer de deux choses :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>du <em>mode exécutable</em> du fichier ;</p>
</li>
<li>
<p>de la présence de l&#8217;entête <em>shebang</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il faut pour cela respectivement :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ajouter le marqueur <code>x</code> avec le programme <code>chmod</code> ;</p>
</li>
<li>
<p>démarrer le fichier par <code>#!&lt;chemin vers l&#8217;interpréteur node&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Voici le contenu d&#8217;un fichier (non suffixé avec l&#8217;extension <code>.js</code>) qui affiche les arguments passé à ce dit-script :</p>
</div>
<div class="listingblock">
<div class="title">print-args</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">#!/usr/bin/env node <i class="conum" data-value="1"></i><b>(1)</b>

'use strict';

const [,, ...args] = process.argv;  <i class="conum" data-value="2"></i><b>(2)</b>

console.log(args);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Demande au programme <code>/usr/bin/env</code> de retourner le chemin vers l&#8217;exécutable système <code>node</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Plus d&#8217;informations sur cette syntaxe dans la section <a href="#primitive-destructuring">décomposition</a> de ce même chapitre.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le bloc suivant rend le fichier exécutable et l&#8217;exécute avec des arguments :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ chmod +x print-args
$ ./print-args Affiche moi
[ 'Affiche', 'moi' ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="npm-scripts">3.3.1. Scripts npm</h4>
<div class="paragraph">
<p>L&#8217;utilisation de <em>scripts npm</em> permet d&#8217;invoquer Node de manière légèrement différente tout en masquant la complexité des scripts au niveau du fichier <code>package.json</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;invocation d&#8217;un <em>script npm</em> peut se faire de deux manières :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>npm &lt;script-natif&gt;</code> pour les scripts natifs à <em>npm</em> (<code>start</code>, <code>publish</code>, <code>test</code> etc.) ;</p>
</li>
<li>
<p><code>npm run &lt;script&gt;</code> pour les scripts additionnels définis par l&#8217;utilisateur.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm start
# équivalent de `npm run start`</pre>
</div>
</div>
<div class="paragraph">
<p>Cette action exécute la commande contenue dans la section <code>scripts.start</code> du fichier <code>package.json</code> :</p>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code>{
  "name": "nodebook",
  ...
  "scripts": {
    "start": "node server.js"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;avantage de cette approche est double :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>uniformisation du <em>workflow</em> au sein de tous les projets ;</p>
</li>
<li>
<p>npm modifie la <strong>variable système <code>$PATH</code></strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce dernier point est important.
Cela signifie que l&#8217;exécution d&#8217;un <em>script npm</em> rend disponible les exécutables contenus dans le répertoire <code>./node_modules/.bin</code> (voir l&#8217;encadré <em>Répertoires et exécutables</em> de la section <a href="#install">Installation</a>).</p>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
  "name": "nodebook",
  ...
  "scripts": {
    "test": "eslint ." <i class="conum" data-value="1"></i><b>(1)</b>
  },
  "devDependencies": {
    "eslint": "^3.0.0"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Équivaut donc à <code>./node_modules/.bin/eslint ./src</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arguments_d_invocation">3.4. Arguments d&#8217;invocation</h3>
<div class="paragraph">
<p>Les arguments correspondent à un tableau de chaînes exposé par la propriété <code>argv</code> de la <a href="#api-process">variable globale <code>process</code></a>.</p>
</div>
<div class="paragraph">
<p>Cette approche est recommandée pour <strong>créer du code générique</strong> et le <strong>personnaliser avec des arguments</strong>.
Le script suivant illustre leur lecture par l&#8217;interpréteur Node :</p>
</div>
<div class="listingblock">
<div class="title">config/argv.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

console.log(process.argv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce script peut être invoqué de la manière suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node argv.js -y 2014 2012 --title 'fromage baguette' <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>["-y", "2014", "2012", "--title", "fromage baguette"]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Des librairies sont disponibles pour <strong>transformer les arguments en objets JavaScript</strong>, configurer des valeurs par défaut, de valider les valeurs, de les rendre obligatoire et même de générer automatiquement une aide à l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Nous aborderons ces techniques avancées dans le <a href="../chapter-05/index.html">Chapitre 5</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plantage_applicatif">3.5. Plantage applicatif</h3>
<div class="paragraph">
<p>Un programme Node s&#8217;arrête en général pour deux raisons :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>la <strong>pile d&#8217;exécution est terminée</strong> et il n&#8217;y a plus rien à exécuter ;</p>
</li>
<li>
<p>une <strong>erreur s&#8217;est produite</strong> et n&#8217;a pas été capturée.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>C&#8217;est souvent le cas lorsqu&#8217;une erreur se produit dans un endroit imprévu de notre code, lorsqu&#8217;une variable inexistante est appelée dans une branche de notre code appelée de manière asynchrone etc.</p>
</div>
<div class="paragraph">
<p>C&#8217;est une <strong>bonne chose</strong> que le programme s&#8217;arrête car cela nous permet de repérer l&#8217;erreur, de lire la trace et d&#8217;éventuellement patcher notre programme pour éviter cette même erreur dans le futur.</p>
</div>
<div class="paragraph">
<p>Quand un programme s&#8217;arrête de manière imprévue, le <code>process</code> émet un événement <code>uncaughtException</code>.
Il existe des cas où il est intéressant de l&#8217;écouter, notamment si la route d&#8217;un serveur cause une erreur et que l&#8217;on souhaite maintenir le service disponible malgré tout.</p>
</div>
<div class="paragraph">
<p>Dans ce cas, il convient d&#8217;écouter cet événement et de déterminer quelle est la meilleure action à suivre :</p>
</div>
<div class="listingblock">
<div class="title">server-crash.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const http = require('http');
const {parse} = require('url');

const server = http.createServer((req, res) =&gt; {
  // eslint-disable-next-line
  const {query} = parse(reb.url, true); <i class="conum" data-value="1"></i><b>(1)</b>

  res.end();
});

server.listen(4001);
process.on('uncaughtException', err =&gt; console.error(err)); <i class="conum" data-value="2"></i><b>(2)</b>

setTimeout(() =&gt; http.get('http://localhost:4001/'), 1000); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En cas de réception d&#8217;une requête HTTP sur le port <code>4001</code>, nous allons parser l&#8217;URL appélée — sauf qu&#8217;une <em>typo</em> s&#8217;est glissée (<code>reb</code> au lieu de <code>req</code>) et provoquera une exception ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cette exception remontera jusqu&#8217;au niveau du <code>process</code> qui déclenchera l&#8217;événement <code>uncaughtException</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Une seconde après voir lancé le script, une requête HTTP est envoyée au serveur, entrainant l&#8217;exécution du <em>point 1</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Encore une fois, <strong>il vaut mieux qu&#8217;un programme plante</strong> plutôt que de le protéger faiblement avec <code>uncaughtException</code>.</p>
</div>
<div class="paragraph">
<p>Il se peut qu&#8217;aucun code ne capture une erreur dans une <a href="#primitive-promise">promesse</a>.
C&#8217;est notamment le cas s&#8217;il n&#8217;y a aucun appel à <code>.catch()</code> après un <code>.then()</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;événement du <code>process</code> <code>unhandledRejection</code> est alors émis, sans pour autant faire planter le programme.
Ce comportement est toutefois amené à être modifié dans Node v8.
Il conviendrait alors de gérer le plantage d&#8217;un programme avec l&#8217;événement <code>uncaughtException</code> de la même manière que vous le feriez avec <code>uncaughtException</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_node_javascript_et_ecmascript">4. Node, JavaScript et ECMAScript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous l&#8217;avons vu dans le premier chapitre, Node utilise JavaScript comme principal langage de développement.
Mais contrairement à Ruby, Python ou PHP dont le numéro de version annonce les fonctionnalités exploitables, qu&#8217;en est-il de Node et de JavaScript ?</p>
</div>
<div class="paragraph">
<p>Il faut se tourner du côté de <em>V8</em> pour savoir ce que la machine virtuelle est capable de comprendre.
Et comme chaque version de Node est associée à une version spécifique de <em>V8</em>, il suffit d&#8217;aller regarder les notes de version de V8 pour l&#8217;apprendre.</p>
</div>
<div class="paragraph">
<p>De manière générale, <em>V8</em> implémente les spécifications approuvées ou en passe d&#8217;être approuvées par le comité gérant l&#8217;évolution du langage JavaScript : le <strong>TC39</strong>.</p>
</div>
<div class="paragraph">
<p>Enfin si vous n&#8217;avez pas envie de retourner la moitié du web pour savoir si <em>V8</em>, donc Node, supporte telle ou telle fonctionnalité, partez du principe que <strong>le JavaScript supporté par Chrome ou Opera correspond au JavaScript supporté par Node</strong>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">FAQ</span> JavaScript ou ECMAScript ?</div>
<div class="paragraph">
<p>On peut lire régulièrement les termes <em>JavaScript</em> et <em>ECMAScript</em> comme s&#8217;il s&#8217;agissait de la même chose, y compris dans cet ouvrage.
<strong>JavaScript et ECMAScript sont la même chose</strong>.</p>
</div>
<div class="paragraph">
<p>JavaScript a été inventé en 1995 par Brendan Eich alors qu&#8217;il était employé de la société <em>Netscape Communications</em>.
Microsoft lui emboîte le pas en incluant JavaScript dans son logiciel Internet Explorer, alors en version 3.
Pour des raisons de droits de marque, il y est dénommé <em>JScript</em>.</p>
</div>
<div class="paragraph">
<p>La spécification est ensuite validée par l&#8217;organisme <em>Ecma International</em> en juin 1997 sous le nom d'<em>ECMAScript</em>, standard ECMA-262.</p>
</div>
<div class="paragraph">
<p>L&#8217;utilisation du terme <em>JavaScript</em> est resté dans le vocabulaire courant. Mais c&#8217;est bien d'<em>ECMAScript</em> dont on parle, vraiment.</p>
</div>
<div class="paragraph">
<p>Adobe Flash utilise un dérivé d&#8217;ECMAScript, ActionScript et bien des machines virtuelles sont capables d&#8217;interpréter partiellement ou intégralement ECMAScript : Rhino en Java, Konq, BESEN en Object Pascal ou encore Esprima en… ECMAScript.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La suite de l&#8217;ouvrage emploie principalement le terme <em>ECMAScript</em>.</p>
</div>
<div class="sect2">
<h3 id="_standard_ecma_262_edition_5">4.1. Standard ECMA-262 Edition 5</h3>
<div class="paragraph">
<p>ECMAScript a été standardisé dans sa version 5 en décembre 2009.
Il s&#8217;agit de la version d&#8217;ECMAScript supportée depuis les débuts de Node.
La révision 5.1 de juin 2011 est une correction mineure de la spécification.</p>
</div>
<div class="paragraph">
<p>Il s&#8217;agit d&#8217;une évolution majeure, dix ans après sa précédente édition, ECMAScript 3.</p>
</div>
<div class="paragraph">
<p>ECMAScript 5 introduit le mode strict limitant fortement les effets de bord indésirables, de nouvelles fonctionnalités pour <code>Object</code> et <code>Array</code>, le support natif de <em>JSON</em> et <code>Function.prototype.bind</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://kangax.github.io/compat-table/es5/" class="bare">kangax.github.io/compat-table/es5/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://www.ecma-international.org/ecma-262/5.1/" class="bare">www.ecma-international.org/ecma-262/5.1/</a></span></p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/compat-table.png" alt="compat table" width="85%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_standard_ecma_262_edition_2015_2016_etc">4.2. Standard ECMA-262 Edition 2015, 2016 etc.</h3>
<div class="paragraph">
<p>La spécification <strong>ECMAScript 2015</strong> (<em>ES2015</em>) a été publiée en juin 2015 et succède à <strong>ECMAScript 5</strong>.<br>
La spécification <em>ES2015</em> a successivement été appelée <em>ECMAScript Harmony</em>, <em>ECMAScript 6</em>, puis <em>ECMAScript 2015</em>.</p>
</div>
<div class="paragraph">
<p>La page Web suivante référence l&#8217;état de l&#8217;implémentation d&#8217;ECMAScript 2015 ainsi que des versions ultérieures sur différentes plates-formes, dont Node :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://kangax.github.io/compat-table/es6/" class="bare">kangax.github.io/compat-table/es6/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://www.ecma-international.org/ecma-262/6.0/" class="bare">www.ecma-international.org/ecma-262/6.0/</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un autre site web se focalise uniquement sur les avancées de l&#8217;implémentation des versions <strong>ECMAScript</strong> pour Node : <span class="URL"><a href="http://node.green/" class="bare">node.green/</a></span>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/compat-table-node.png" alt="compat table node" width="85%">
</div>
</div>
<div class="paragraph">
<p>Certaines fonctionnalités sont disponibles uniquement en utilisant une option de démarrage spécifique, par exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node --harmony script.js                <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Active toutes les fonctionnalités préliminaires.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une page explicative (en anglais) sur le site <code>nodejs.org</code> contient des indications à jour sur la compatibilité générale avec <em>_ECMAScript 2015</em> : <span class="URL"><a href="https://nodejs.org/en/docs/es6/" class="bare">nodejs.org/en/docs/es6/</a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="primitives">4.3. Rappel des primitives ECMAScript</h3>
<div class="paragraph">
<p>Un des conforts apporté par l&#8217;utilisation d&#8217;ECMAScript dans Node est qu&#8217;il n&#8217;y a pas à se soucier de la compatibilité navigateur : vous pouvez utiliser le meilleur de JavaScript !</p>
</div>
<div class="paragraph">
<p>Ce résumé des primitives et fonctionnalités principales d'<em>ECMAScript</em> a pour but de vous apprendre ou de vous rappeler des fonctionnalités du langage disponibles dans Node v6.</p>
</div>
<div class="sect3">
<h4 id="_string">4.3.1. String</h4>
<div class="paragraph">
<p>Chaque élément d&#8217;une chaîne de caractères est encodé au format UTF-16 et peut donc contenir 16 bits de données.</p>
</div>
<div class="paragraph">
<p>L&#8217;opérateur <code>typeof</code> permet d&#8217;identifier une chaîne :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">typeof 'Eyrolles'; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'string'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut connaître la longueur d&#8217;une chaîne via son attribut <code>length</code>.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'I ♥ JavaScript'.length; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>14</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut nettoyer les espaces englobant une chaîne avec la méthode <code>trim</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'  w w w  '.trim(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'w w w'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut connaître la position d&#8217;un ou plusieurs caractères via la méthode <code>indexOf</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'I ♥ JavaScript'.indexOf('JavaScript'); <i class="conum" data-value="1"></i><b>(1)</b>
'I ♥ JavaScript'.indexOf('I'); <i class="conum" data-value="2"></i><b>(2)</b>
'I ♥ JavaScript'.indexOf('?'); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>4</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>0</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>-1</code>, aucune occurrence n&#8217;ayant été trouvée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut collecter les occurrences correspondantes à un masque de caractères via la méthode <code>match</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'I ♥ JavaScript'.match('♥'); <i class="conum" data-value="1"></i><b>(1)</b>
'I ♥ JavaScript'.match(/\wa/g); <i class="conum" data-value="2"></i><b>(2)</b>
'I ♥ JavaScript'.match('!'); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>['♥']</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>['Ja', 'va']</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>null</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut remplacer les occurrences correspondantes à un masque de caractères via la méthode <code>replace</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'I ♥ JavaScript'.replace('♥', 'love'); <i class="conum" data-value="1"></i><b>(1)</b>
'I ♥ JavaScript'.replace(/[A-Z]/g, (char) =&gt; char.toLowerCase()); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'I love JavaScript'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'i ♥ javascript'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les <em>template literals</em> servent à composer des chaînes de caractères multilignes et/ou contenant des expressions ECMAScript :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primivite-template-literals.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const lang = 'JavaScript';
const { basename } = require('path');

console.log(`I ♥ ${lang}.
Cet exemple se trouve dans le fichier "${basename(__filename)}"`); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'I ♥ JavaScript.\nCet exemple se trouve dans le fichier "primitives/template-literals.js"'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les <em>template literals</em> peuvent se préfixer d&#8217;un nom de fonction.
Ce mécanisme nommé <em>tagged template literals</em> sert de filtre pour interpréter et interpoler le contenu de chaque <em>template</em> (élément contenu dans <code>${}</code>). Vous pouvez écrire vos propres fonctions mais aussi utiliser des modules <em>npm</em>.<br>
L&#8217;exemple suivant illustre une sécurisation de contenu tiers à l&#8217;aide de la fonction <code>safeHtml</code> fournie par le module <code>common-tags</code> (<span class="URL"><a href="https://npmjs.com/common-tags" class="bare">npmjs.com/common-tags</a></span>) :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primivite-template-literal-tags.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { safeHtml } = require('common-tags');
const text = '&lt;script&gt;alert(document.cookie)&lt;/script&gt;';

console.log(`&lt;div class="user-content"&gt;
  ${text}
&lt;/div&gt;`); <i class="conum" data-value="1"></i><b>(1)</b>

console.log(safeHtml`&lt;div class="user-content"&gt;
  ${text}
&lt;/div&gt;`); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>&lt;div class="user-content"&gt;\n&lt;script&gt;alert(document.cookie)&lt;/script&gt;\n&lt;/div&gt;</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>&lt;div class="user-content"&gt;\n&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;\n&lt;/div&gt;</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-boolean">4.3.2. Boolean</h4>
<div class="paragraph">
<p>Un booléen est une donnée de type logique qui peut être <em>vraie</em> ou <em>fausse</em> en prenant respectivement la valeur <code>true</code> ou <code>false</code>.
C&#8217;est un type de choix pour effectuer des <em>assertions</em> et vérifier des <em>conditions</em>.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/bool.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const counter = 3;

console.log(counter);               <i class="conum" data-value="1"></i><b>(1)</b>
console.log(counter &gt; 0);           <i class="conum" data-value="2"></i><b>(2)</b>
console.log(counter &lt; 0);           <i class="conum" data-value="3"></i><b>(3)</b>
console.log(counter === 3);         <i class="conum" data-value="4"></i><b>(4)</b>
console.log(counter &amp;&amp; counter &gt; 0);<i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>3</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>true</code> car la condition est vérifiée ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>false</code> car la condition n&#8217;est pas vérifiée ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>true</code> car <code>3</code> <em>équivaut strictement</em> à <code>3</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Affiche <code>true</code> car la condition est vérifiée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une donnée peut être convertie en un booléen à l&#8217;aide de la fonction <code>Boolean</code>.
Toute valeur non-nulle convertie en booléen retournera <code>true</code>.
On dit alors que cette valeur est <code>truthy</code>.
À l&#8217;inverse, une valeur nulle, vide ou indéfinie sera dite <code>falsy</code> – <code>null</code>, <code>0</code>, <code>''</code>, <code>undefined</code>, <code>false</code> et <code>NaN</code>.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/bool-truthy-falsy.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const counter = 3;

console.log(Boolean(''));       <i class="conum" data-value="1"></i><b>(1)</b>
console.log(Boolean(counter));  <i class="conum" data-value="2"></i><b>(2)</b>

if (counter) {                  <i class="conum" data-value="3"></i><b>(3)</b>
  console.log('if (counter) équivaut à if (Boolean(counter))');
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>false</code> car il s&#8217;agit d&#8217;une <em>chaîne vide</em> convertie en booléen ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>true</code> car il s&#8217;agit d&#8217;un <em>nombre différent de 0</em> converti en booléen ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>counter</code> vaut <code>3</code> donc la <em>condition est vérifiée</em> – elle est <em>truthy</em> – et exécutera la ligne d&#8217;après.</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Méfiance</span> Double égalité vs. triple égalité</div>
<div class="paragraph">
<p>Il est recommandé d&#8217;utiliser l&#8217;opérateur de <em>triple égalité</em> pour s&#8217;assurer que deux éléments sont <strong>de même type et de même valeur</strong>.
Les cas de figure où la <em>double égalité</em> évite les effets de bord indésirables sont peu nombreux…</p>
</div>
<div class="listingblock">
<div class="content">
<pre>console.log('' == 0);   <i class="conum" data-value="1"></i><b>(1)</b>
console.log('' === 0);  <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>true</code> car les deux valeurs sont <em>falsy</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>false</code> car les deux valeurs ne sont pas <em>strictement identiques</em> (même type et même valeur).</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_number">4.3.3. Number</h4>
<div class="paragraph">
<p>Tous les nombres en ECMAScript sont des flottants (double précision) respectant le standard <a href="https://fr.wikipedia.org/wiki/IEEE_754"><em>IEEE 754</em></a>.
Un nombre peut donc contenir 64 bits de données, comme en Python et PHP, entre autres.</p>
</div>
<div class="paragraph">
<p>L&#8217;opérateur <code>typeof</code> permet d&#8217;identifier un nombre :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">typeof 42;    <i class="conum" data-value="1"></i><b>(1)</b>
typeof 13.37; <i class="conum" data-value="1"></i><b>(1)</b>
typeof NaN;   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'number'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne également <code>'number'</code>, ce qui est souvent source de confusion.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut effectuer des opérations mathématiques grâce aux opérateurs <code>+</code> (addition), <code>-</code> (soustraction), <code>*</code> (multiplication), <code>/</code> (division) et <code>%</code> (modulo).</p>
</div>
<div class="paragraph">
<p>L&#8217;exception dont il faut se méfier est l&#8217;addition, car le signe <code>+</code> est également l&#8217;opérateur de concaténation de chaîne.<br>
Dès qu&#8217;une chaîne est détectée, l&#8217;opération d&#8217;addition est remplacée par une concaténation.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">1 + 2;    <i class="conum" data-value="1"></i><b>(1)</b>
'1' + 2;  <i class="conum" data-value="2"></i><b>(2)</b>
1 + '2';  <i class="conum" data-value="2"></i><b>(2)</b>
undefined + 2; <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>3</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'12'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>NaN</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les fonctions <code>parseInt</code> et <code>parseFloat</code> permettent de respectivement de convertir en nombre entier et nombre flottant :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">typeof 2.10 === 'number';
typeof '2.10' === 'string';

parseInt('2.10', 10); <i class="conum" data-value="1"></i><b>(1)</b>
parseFloat('2.10');   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>2</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>2.10</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">FAQ</span> Le second argument de parseInt</div>
<div class="paragraph">
<p>Le second argument de la fonction <code>parseInt</code> indique dans quelle base la valeur est représentée dans la chaîne. La base décimale (10) est la plus souvent utilisée, mais il est également possible de convertir une chaîne représentant un nombre binaire (base 2) ou hexadécimal (base 16).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La méthode <code>isNaN</code> permet d&#8217;être sûr de ne pas manipuler un nombre indésirable :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Number.isNaN(undefined + 1);  <i class="conum" data-value="1"></i><b>(1)</b>
Number.isNaN(2.10);           <i class="conum" data-value="2"></i><b>(2)</b>
Number.isNaN(undefined);      <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>true</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>false</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il également possible de choisir le nombre de décimales après la virgule avec la méthode <code>toFixed</code>.<br>
Attention toutefois, la valeur retournée est de type <code>String</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">10.0101.toFixed(2);   <i class="conum" data-value="1"></i><b>(1)</b>
10.0101.toFixed(0);   <i class="conum" data-value="2"></i><b>(2)</b>
parseInt(10.0101, 10);<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'10.01'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'10'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>10</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-function">4.3.4. Function</h4>
<div class="paragraph">
<p>Les fonctions permettent d&#8217;isoler des portions de code et de les rendre réutilisables via l&#8217;utilisation de paramètres.</p>
</div>
<div class="paragraph">
<p>Vous pouvez les déclarer via une expression ou une déclaration assignée à une variable.
La déclaration d&#8217;une fonction est soumise à la portée du contexte dans lequel le bloc de code est placé.
Une fonction peut être créée de trois manières :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>nommée</strong> <code>function nomDeLaFonction(){ &#8230;&#8203; }</code> ;</p>
</li>
<li>
<p><strong>anonyme</strong> <code>function (){ &#8230;&#8203; }</code></p>
</li>
<li>
<p><strong>fléchée</strong> <code>() &#8658; { &#8230;&#8203; }</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Les fonctions anonymes sont fréquemment employées en tant que <em>callbacks</em> ou dans des contextes itératifs (tels <code>Array.map</code> etc.)</p>
</div>
<div class="paragraph">
<p>Il est important de noter que la déclaration d&#8217;une fonction et son exécution sont deux choses différentes.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/function.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

function isEqualTo (value, compareWith) {
  return compareWith.some(v =&gt; v === value);  <i class="conum" data-value="1"></i><b>(1)</b>
}

const isNotNullOrUndefined = function (value) {
  return !isEqualTo(value, [null, undefined]);
};

function filterSparseArray (array) {
  return array.filter(isNotNullOrUndefined);  <i class="conum" data-value="2"></i><b>(2)</b>
}

(() =&gt; {                              <i class="conum" data-value="3"></i><b>(3)</b>
  // eslint-disable-next-line no-sparse-arrays
  const values = [,3,,,1];

  console.log(typeof Date);               <i class="conum" data-value="4"></i><b>(4)</b>
  console.log(isNotNullOrUndefined(null));<i class="conum" data-value="5"></i><b>(5)</b>
  console.log(filterSparseArray(values)); <i class="conum" data-value="6"></i><b>(6)</b>
})();

// eslint-disable-next-line no-undef
console.log(values);                      <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Utilisation d&#8217;une fonction fléchée (<em>arrow function</em>) en tant que fonction anonyme de <em>callback</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Utilisation d&#8217;une fonction nommée comme <em>callback</em> de la méthode <code>Array.map</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Illustration d&#8217;une <em>Immediatly Invocked Function Expression</em>, aka <em>IIFE</em> aka <em>fonction immédiatement exécutée</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retourne <code>'function'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retourne <code>false</code> — la valeur étant nulle ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Retourne <code>[ 3, 1 ]</code> — un tableau filtré des valeurs nulles ou égales à <code>undefined</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Lève une exception car la constante <code>values</code> n&#8217;est pas définie dans ce <em>scope</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le code contenu dans le bloc déclaratif d&#8217;une fonction crée une <em>portée</em> (ou <em>scope</em>) qui est invisible au contexte parent de l&#8217;exécution de cette fonction.
Il s&#8217;agit d&#8217;une excellente manière d&#8217;isoler des variables, notamment pour éviter des effets de bord indésirables liés à l&#8217;état d&#8217;exécution de vos scripts.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple précédent illustre un tel cas de portée en contenant la constante <code>values</code> dans l'<em>IIFE</em> : le contexte parent n&#8217;a aucune connaissance de son existence — et c&#8217;est tant mieux.</p>
</div>
<div class="paragraph">
<p>Une syntaxe abrégée est disponible via les fonctions fléchées :</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Tableau d&#8217;équivalence de syntaxe</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8658; x*2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(x){ return x*2 }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8658; { x }</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(x){ x }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8658; ({ x })</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(x){ return { x }; }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(x, y) &#8658; ({ x: y })</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(x, y){ return { x: y }; }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(x, y) &#8658; x+y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function (x, y){ return x+y }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8658; { const y = 2; return x*y }</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function(x){ const y = 2; return x*y }</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Il est possible de composer des fonctions à partir d&#8217;autres fonctions en utilisant la méthode <code>bind</code>.
Ce <em>pattern</em> est extrêmement puissant car il permet de modifier le contexte d&#8217;exécution de ladite fonction.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/function-bind.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const FR = {
  capitalCity: 'Paris',
  currency: 'EUR'
};

const UK = {
  capitalCity: 'London',
  currency: 'GBP'
};

const formatCurrency = function (amount){
  return `${amount} ${this.currency}`;
};

const priceInEUR = formatCurrency.bind(FR);
const priceInGBP = formatCurrency.bind(UK);

console.log(priceInEUR(100));  <i class="conum" data-value="1"></i><b>(1)</b>
console.log(priceInGBP(100));  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'100 EUR'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'100 GBP'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>bind</code> est également capable de créer une nouvelle fonction à laquelle vous auriez appliqué partiellement des arguments :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/function-partials.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const helloSomething = (text) =&gt; {
  console.log('Hello ' + text);
};

const helloWorld = helloSomething.bind(null, 'World');
const helloParis = helloSomething.bind(null, 'Paris');

helloWorld();           <i class="conum" data-value="1"></i><b>(1)</b>
helloParis();           <i class="conum" data-value="2"></i><b>(2)</b>
helloSomething('Paris');<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>'Hello World'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>'Hello Paris'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce procédé est particulièrement utile pour rendre des fonctions génériques et composer des dérivées, notamment dans le cas de pagination.</p>
</div>
<div class="paragraph">
<p>Les méthodes <code>call</code> et <code>apply</code> reposent sur le même principe mais à la différence de <code>bind</code>, elles exécutent immédiatement la fonction.
Le seul élément différenciant correspond à la syntaxe d&#8217;application des arguments :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/function-call-apply.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const wrap = (prefix, suffix, text) =&gt; prefix + text + suffix;

console.log(wrap.call(null, '&lt;', '&gt;', 'title'));     <i class="conum" data-value="1"></i><b>(1)</b>
console.log(wrap.apply(null, ['&lt;', '&gt;', 'title']));  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'&lt;title&gt;'</code> dans les deux cas.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-array">4.3.5. Array</h4>
<div class="paragraph">
<p>L&#8217;opérateur <code>typeof</code> ne permet pas d&#8217;identifier un tableau. Il faut pour cela privilégier la méthode <code>isArray</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">typeof [];        <i class="conum" data-value="1"></i><b>(1)</b>
Array.isArray([]);<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'object'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est possible de connaître la longueur d&#8217;un tableau en utilisant la propriété <code>length</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[1, 2, 3].length; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>3</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La méthode <code>join</code> permet de concaténer tous les éléments d&#8217;un tableau avec le séparateur de votre choix :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[1, 2, 3].join(', ') + '… soleil';  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'1, 2, 3… soleil'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>À l&#8217;inverse, la méthode <code>from</code> prend en charge la création de tableau à partir d'<em>itérables</em> ou de structures similaires à des tableaux, comme <code>arguments</code> ou <code>NodeList</code> (dans un navigateur).</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primivite-array-from.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

function logArguments() {
  console.log(Array.from(arguments));
}

const logIterable = (...args) =&gt; {
  console.log(Array.from(args));
}

console.log(Array.from('camembert')); <i class="conum" data-value="1"></i><b>(1)</b>
logArguments(1, 'b', 3, 'd');         <i class="conum" data-value="2"></i><b>(2)</b>
logIterable(1, 'b', 3, 'd');          <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>[ 'c', 'a', 'm', 'e', 'm', 'b', 'e', 'r', 't' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>[ 1, 'b', 3, 'd' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>[ 1, 'b', 3, 'd' ]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En complément, la méthode <code>concat</code> permet de concaténer d&#8217;autres éléments :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const a = [1, 2];

console.log(a.concat(3));		<i class="conum" data-value="1"></i><b>(1)</b>
console.log(a.concat([3, 4]));		<i class="conum" data-value="2"></i><b>(2)</b>
console.log(a.concat([3, 4], [4, 5]));	<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>[ 1, 2, 3 ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>[ 1, 2, 3, 4 ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>[ 1, 2, 3, 4, 4, 5 ]</code> — cf. <a href="#primitive-map-set">Map et Set</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La fonction de tri via la méthode <code>sort</code> se base sur des comparaisons positives, négatives ou neutres pour retourner un nouveau tableau, réindexé :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[1, 3, 2].sort((a, b) =&gt; a - b);  <i class="conum" data-value="1"></i><b>(1)</b>
[1, 3, 2].sort((a, b) =&gt; b - a);  <i class="conum" data-value="2"></i><b>(2)</b>

['A', 'b', 'c', 'a'].sort((a, b) =&gt; a.localeCompare(b))); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>[1, 2, 3]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>[3, 2, 1]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>['a', 'A', 'b', 'c']</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les méthodes suivantes sont des nouveautés d&#8217;ECMAScript 5.
Elles facilitent énormément les itérations sur les tableaux tout en ajoutant une orientation fonctionnelle, utile pour la lisibilité du code.</p>
</div>
<div class="paragraph">
<p>La méthode <code>map</code> permet de retourner un nouveau tableau avec des valeurs modifiées :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/array-map.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const newArray = ['a', ' B', 'c '].map(value =&gt; {
  return value.trim().toUpperCase();
});

console.log(newArray); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>['A', 'B', 'C']</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La méthode <code>filter</code> quant à elle retourne un nouveau tableau ne contenant que les éléments retournant un <a href="#primitive-boolean">booléen <em>truthy</em></a> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/array-filter.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const values = [1, 'a', 120, undefined, 0];

console.log(values.filter(value =&gt; value &lt; 10)); <i class="conum" data-value="1"></i><b>(1)</b>
console.log(values.filter(value =&gt; value));      <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>[1, 0]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>[1, 'a', 120]</code> ;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De manière similaire, les méthodes <code>some</code> et <code>every</code> retournent un booléen si <em>au moins une itération</em> et <em>toutes les itérations</em> ont renvoyé une <em>valeur positive</em> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/array-some.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const values = [1, 'a', 120, undefined, 4];
const isUndefined = (value) =&gt; value === undefined;

console.log(values.some(isUndefined));                 <i class="conum" data-value="1"></i><b>(1)</b>
console.log(values.every(isUndefined));                <i class="conum" data-value="2"></i><b>(2)</b>
console.log([undefined, undefined].every(isUndefined));<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Renvoie <code>true</code> puisqu&#8217;au moins une valeur équivaut à <code>undefined</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Renvoie <code>false</code> puisque toutes les valeurs n&#8217;équivalent pas à <code>undefined</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Renvoie <code>true</code> puisque toutes les valeurs sont égales à <code>undefined</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ECMAScript 2015 introduit les méthodes <code>find</code> et <code>findIndex</code>, respectivement pour retourner une valeur et son index selon une fonction prédicat :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/array-find.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const DATA = ['am', 'stram', 'gram'];
const FIND = 'stram';			<i class="conum" data-value="1"></i><b>(1)</b>
let found;

// Avant ES2015
DATA.some((value) =&gt; {
  if (value === FIND) {
    found = value;
    return true;
  }
});

console.log(found);			  <i class="conum" data-value="2"></i><b>(2)</b>

// Depuis ES2015
found = DATA.find(value =&gt; value === FIND);

console.log(found);			  <i class="conum" data-value="2"></i><b>(2)</b>

const foundIndex = DATA.findIndex(value =&gt; value === FIND);

console.log(foundIndex);	<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Valeur que l&#8217;on recherche ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>stram</code> (valeur recherchée) ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>1</code> (index de la valeur recherchée).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La méthode <code>reduce</code> a un comportement similaire à <code>sort</code> mais fonctionne de manière accumulative :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/array-reduce.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

let result;
const pairs = [[1, 2], [3, 4], [5, 6]];

result = pairs.reduce((acc, pair) =&gt; acc + pair[0] + pair[1], 0);
console.log(result);    <i class="conum" data-value="1"></i><b>(1)</b>

result = pairs.reduce((acc, pair) =&gt; {
  acc[0] += pair[0];
  acc[1] += pair[1];
  return acc;
}, [0, 0]);
console.log(result);    <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>21</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>[9, 12]</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">FAQ</span> Tableau non contigu.</div>
<div class="paragraph">
<p>Il se peut que des valeurs soient manquantes dans un tableau.
On dit alors que les valeurs ne sont pas contiguës.</p>
</div>
<div class="paragraph">
<p>Cela affecte les fonctions itératives et peut se révéler problématique si vous cherchez à conserver cette absence de valeurs :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const a = [1,, 3, undefined, null];
const print = (value) =&gt; console.log(value);

a.length;         <i class="conum" data-value="1"></i><b>(1)</b>
a.forEach(print); <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>5</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche 4 valeurs : <code>1</code>, <code>3</code>, <code>undefined</code> puis <code>null</code>.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-object">4.3.6. Object</h4>
<div class="paragraph">
<p>Dans ECMAScript, tout est objet. C&#8217;est le <em>prototype</em> qui détermine le comportement dudit objet.
Les objets peuvent être créés de manière littérale, avec la fonction <code>Object.create</code> ou via un constructeur.<br>
À la différence d&#8217;un <code>Array</code>, il est possible de nommer une clé par une chaîne de caractères – statique ou dynamique – ou avec un <a href="#primitive-symbol">symbole</a>.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const litteral = { literally: 'lateral' };
const litteralCopy = litteral;
const objectCreated = Object.create(litteral);

console.log(litteral.literally);        <i class="conum" data-value="1"></i><b>(1)</b>
console.log(objectCreated.literally);   <i class="conum" data-value="2"></i><b>(2)</b>
console.log(litteral === litteralCopy); <i class="conum" data-value="3"></i><b>(3)</b>
console.log(litteral === objectCreated);<i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'lateral'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne également <code>'lateral'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>true</code>, les deux objets étant la même instance ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retourne <code>false</code>, les deux objets étant deux instances différentes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;opérateur <code>typeof</code> permet d&#8217;identifier la primitive d&#8217;une variable — au sens d&#8217;ECMAScript, pas au sens logique de votre application, c&#8217;est à dire le prototype d&#8217;un objet.</p>
</div>
<div class="paragraph">
<p>L&#8217;opérateur <code>instanceof</code> ou la méthode <code>getPrototypeOf</code> permettent justement de comparer les appartenances logiques.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object-typeof-instanceof.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

function PseudoBookClass(title) {
  this.title = title.trim();
}

const nodeBook = new PseudoBookClass('Node.js universel');

console.log(typeof PseudoBookClass);              <i class="conum" data-value="1"></i><b>(1)</b>
console.log(typeof nodeBook);                     <i class="conum" data-value="2"></i><b>(2)</b>

console.log(nodeBook instanceof PseudoBookClass); <i class="conum" data-value="3"></i><b>(3)</b>
console.log(Object.getPrototypeOf(nodeBook));     <i class="conum" data-value="4"></i><b>(4)</b>
console.log(Object.getPrototypeOf(nodeBook).constructor.name);  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>function</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>object</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>true</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>[object Object]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Affiche <code>PseudoBookClass</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Object.keys</code> extrait les propriétés énumérables d&#8217;un objet, à la différence de <code>Object.getOwnPropertyNames()</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object-keys.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const busStop = {
  name: 'Vassal Road',
  services: ['36', 'N136', '185']
};

Object.defineProperty(busStop, 'internal_code', {
  value: '4811',
  enumerable: false
});

console.log(Object.keys(busStop));                <i class="conum" data-value="1"></i><b>(1)</b>
console.log(Object.getOwnPropertyNames(busStop)); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>[ 'name', 'services' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>[ 'name', 'services', 'internal_code' ]</code>.</td>
</tr>
</table>
</div>
<div id="primitive-object-getset" class="paragraph">
<p><code>Object.defineProperty</code> permet de régler finement d&#8217;autres spécificités d&#8217;un objet, dont des <strong>accesseurs</strong> (<em>getters</em>) et des <strong>mutateurs</strong> (<em>setters</em>).
Ces attributs spéciaux nous autorisent la création de <em>propriétés calculées</em>, de <em>propriétés en lecture seule</em> ou de <em>maitriser l&#8217;écriture d&#8217;une propriété</em> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object-getters.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const book = {
  title: 'Node.js – bonnes pratiques de programmation modulaire',
};

Object.defineProperties(book, {                  <i class="conum" data-value="1"></i><b>(1)</b>
  date_published: {
    set: function(date) {                        <i class="conum" data-value="2"></i><b>(2)</b>
      if (isNaN(Date.parse(date))) {
        throw new Error('Invalid date given: ' + date);
      }
      else {
        this._published_at = new Date(date);   <i class="conum" data-value="3"></i><b>(3)</b>
      }
    },
    get: function() {                            <i class="conum" data-value="4"></i><b>(4)</b>
      return this._published_at;
    }
  }
});

book.date_published = '2017-05-01';              <i class="conum" data-value="5"></i><b>(5)</b>
console.log(book.date_published instanceof Date);<i class="conum" data-value="6"></i><b>(6)</b>
book.date_published = '2017-05-0';               <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nous définissons de nouvelles propriétés pour l&#8217;objet <code>book</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Définition d&#8217;un <em>mutateur</em> pour la propriété <code>date_published</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La valeur <code>date</code> est convertie en objet et stockée dans la propriété <code>_published_at</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Définition d&#8217;un <em>accesseur</em> pour la propriété <code>date_published</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Appel du <em>mutateur</em> qui, en interne, convertit la chaîne de caractères en objet <code>Date</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Appel de l'<em>accesseur</em> et affiche <code>true</code> car il s&#8217;agit bien d&#8217;une instance de <code>Date</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Lance une exception car la chaîne assignée n&#8217;est pas une date valide.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Trois choses sont à souligner dans cet exemple.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, notre définition de <em>mutateur</em> ajoute de la sécurité.
Sa valeur est <em>garantie</em> et nous savons que <code>book.date_published</code> sera systématiquement une date.</p>
</div>
<div class="paragraph">
<p>Inconvénient, nous n&#8217;avons d&#8217;autre choix que de stocker la date dans une autre propriété, ici <code>book._published_at</code>.
Et rien ne nous empêche de la modifier directement et d&#8217;invalider une partie de notre raisonnement…<br>
Il nous faudrait trouver un moyen de stocker la valeur du _mutateur_ et de l'<em>accesseur</em> de manière <em>privée</em>.</p>
</div>
<div class="paragraph">
<p>Enfin, les propriétés sont assignées <em>uniquement</em> à l&#8217;objet <code>book</code>. Si nous voulions les généraliser à plusieurs instances d&#8217;objets se ressemblant, nous les définirions alors dans une <a href="#primitive-class">classe</a>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons définir des <em>accesseurs</em> et des <em>mutateurs</em> avec une notation raccourcie, ayant exactement le même effet.
Reprenons l&#8217;exemple précédent :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object-getters-shorthand.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const book = {
  title: 'Node.js – bonnes pratiques de programmation modulaire',
  set date_published(date) {                  <i class="conum" data-value="1"></i><b>(1)</b>
    if (isNaN(Date.parse(date))) {
      throw new Error('Invalid date given: ' + date);
    }
    else {
      this._published_at = new Date(date);
    }
  },
  get date_published () {
    return this._published_at;
  },
  get year_published () {                     <i class="conum" data-value="2"></i><b>(2)</b>
    return this.date_published.getFullYear();
  }
};

book.date_published = '2017-05-01';
book.year_published = '2014';                 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Définition <em>raccourcie</em> du <em>mutateur</em> pour la propriété <code>date_published</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Définition <em>raccourcie</em> de l'<em>accesseur</em> pour la propriété <code>year_published</code> – notez qu&#8217;on ne définit pas de <em>mutateur</em> pour cette même propriété ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Lance une <em>exception</em> car la propriété <code>year_published</code> est définie en tant qu'<em>accesseur</em> uniquement ; on ne peut donc pas lui <em>assigner</em> de valeur.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Object.assign</code> étend des structures existantes et la définition de valeurs par défaut.
Les clés et valeurs sont copiées de gauche à droite avant d&#8217;être assignées dans le premier paramètre :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/object-assign.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const DEFAULTS = {
  concurrency: 10,
  timeout: 'https',
  tags: []
};

const userOptions = {
  url: 'https://oncletom.io/node.js',
  tags: ['img', 'h1']
};

const testOptions = {
  url: null,
  env: 'test'
};

const mergedOptions = Object.assign({}, DEFAULTS, userOptions); <i class="conum" data-value="1"></i><b>(1)</b>
Object.assign(testOptions, userOptions);

console.log(DEFAULTS);                <i class="conum" data-value="2"></i><b>(2)</b>
console.log(mergedOptions.tags);      <i class="conum" data-value="3"></i><b>(3)</b>
console.log(Object.keys(testOptions));<i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Les clés et valeurs de <code>DEFAULT</code> et celles de <code>userOptions</code> sont copiées dans un objet vide puis retournées dans <code>mergedOptions</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>{ concurrency: 10, timeout: 'https', tags: [] }</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>[ 'img', 'h1' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>[ 'url', 'env', 'tags' ]</code> — l&#8217;objet <code>testOptions</code> est donc modifié.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_date">4.3.7. Date</h4>
<div class="paragraph">
<p>L&#8217;opérateur <code>typeof</code> ne permet pas d&#8217;identifier une date. Il convient d&#8217;utiliser <code>instanceof</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">typeof (new Date('2014-03-24'));  <i class="conum" data-value="1"></i><b>(1)</b>
(new Date('2014-03-24 13:37')) instanceof Date; <i class="conum" data-value="2"></i><b>(2)</b>
typeof Date.parse('2014-03-24 13:37');          <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'object'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>true</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>'number'</code>, car il s&#8217;agit d&#8217;une date exprimée en millisecondes depuis le 1er janvier 1970 (temps <em>EPOCH</em>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il également possible d&#8217;obtenir la date actuelle exprimée en millisecondes avec <code>Date.now</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Date.parse(new Date()); <i class="conum" data-value="1"></i><b>(1)</b>
Date.now();             <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>1397381941000</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>1397381941031</code>, équivalent à la syntaxe précédente donc, la précision à la milliseconde près en plus.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-destructuring">4.3.8. Décomposition</h4>
<div class="paragraph">
<p>L&#8217;affectation par <em>décomposition</em> (<em>destructuring</em>) est une manière élégante et intuitive de piocher dans un <a href="#primitives/array">tableau</a> ou dans un <a href="#primitives/object">objet</a>.
La décomposition n&#8217;altère pas le contenu des variables décomposées.</p>
</div>
<div class="paragraph">
<p>Les valeurs d&#8217;un tableau sont décomposées dans l&#8217;ordre tandis que l&#8217;opérateur <em>spread</em> (<code>&#8230;&#8203;</code>) permet d&#8217;assigner le <em>reste</em> des valeurs dans une seule et même variable ou constante :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/destructuring-array.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const cities = ['Bordeaux', 'Toulouse', 'Montpellier', 'Aix-en-Provence'];

const [chocolatineCity, ...trueSouth] = cities;  <i class="conum" data-value="1"></i><b>(1)</b>

console.log(chocolatineCity);<i class="conum" data-value="2"></i><b>(2)</b>
console.log(trueSouth);      <i class="conum" data-value="3"></i><b>(3)</b>
console.log(cities);         <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Décompose la première valeur du tableau et assigne <em>le reste</em> dans une autre constante ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>Bordeaux</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>[ 'Toulouse', 'Montpellier', 'Aix-en-Provence' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>[ 'Bordeaux', 'Toulouse', 'Montpellier', 'Aix-en-Provence' ]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est également possible de <em>sauter</em> des valeurs en ne nommant pas <em>autant</em> de variables ou de constantes lors de la décomposition :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/destructuring-spread.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const count = ['un', 'zapzap', 'deux', 'trois', 'quatre'];
const [first, ,...end] = count;  <i class="conum" data-value="1"></i><b>(1)</b>

console.log(first);  <i class="conum" data-value="2"></i><b>(2)</b>
console.log(end);    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assigne la première valeur dans la constante <code>first</code>, saute la seconde et assigne le reste des valeurs dans <code>end</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>un</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>[ 'deux', 'trois', 'quatre' ]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le même mécanisme existe pour les <a href="#primitives/object">objets</a>, y compris dans des arguments de fonction :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/destructuring-object.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

/* eslint-disable no-sparse-arrays */

const { join } = require('path');  <i class="conum" data-value="1"></i><b>(1)</b>
const config = {
  debug: true,
};

const { debug: configDebug } = config;
const { isProd, name = 'Demo' } = config;
const logConfigDebug = ({ debug }) =&gt; {           <i class="conum" data-value="2"></i><b>(2)</b>
  console.log(debug);
};

console.log(join('folder', 'filename.txt'));      <i class="conum" data-value="3"></i><b>(3)</b>
console.log(configDebug); <i class="conum" data-value="4"></i><b>(4)</b>
console.log(isProd);      <i class="conum" data-value="5"></i><b>(5)</b>
console.log(name);        <i class="conum" data-value="6"></i><b>(6)</b>
logConfigDebug(config, 'zero', 'un', 'deux');     <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Destructure la fonction <code>join</code> directement depuis le <code>require</code> de module ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Destructure la valeur <code>debug</code> du premier argument;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>folder/filename.txt</code> – <code>folder\filename.txt</code> sous Windows ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>true</code> car la clé <code>debug</code> a été décomposée en <code>configDebug</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Affiche <code>undefined</code> – cette valeur n&#8217;existe pas dans l&#8217;objet <code>config</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Affiche <code>Demo</code> – cette valeur est complétée par défaut dans l&#8217;assignation ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Affiche <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Comme indiqué en début de section, il est possible de nommer les clés de manière dynamique mais aussi d&#8217;utiliser une syntaxe raccourcie d&#8217;assignation de valeur :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitive-object-advanced.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const companies = ['SNCF', 'Reinfe'];
const sncf = companies[0];

const companyDetails = {
  [sncf]: {                        <i class="conum" data-value="1"></i><b>(1)</b>
    country: 'France',
  },
};

companyDetails[ companies[1] ] = { <i class="conum" data-value="2"></i><b>(2)</b>
  country: 'Spain'
};

console.log(companyDetails);             <i class="conum" data-value="3"></i><b>(3)</b>
console.log({ sncf, foo: 'bar' });       <i class="conum" data-value="4"></i><b>(4)</b>
console.log({ sncf: sncf, foo: 'bar' }); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Utilise la valeur d&#8217;une variable comme nom de clé ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Syntaxe alternative possible, utile lorsqu&#8217;un objet existe déjà ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>{ SNCF: { country: 'France' }, Reinfe: { country: 'Spain' } }</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Utilise la syntaxe d&#8217;assignation raccourcie, donc assigne la valeur de <code>sncf</code> à la clé <code>sncf</code> — affiche <code>{ sncf: 'SNCF', foo: 'bar' }</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><em>Idem</em> mais sans la syntaxe d&#8217;assignation raccourcie.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-rest">4.3.9. Paramètres du reste</h4>
<div class="paragraph">
<p>Les <em>paramètres du reste</em> (<em>rest parameters</em>) utilisent une syntaxe identique à la <em>décomposition</em> mais opèrent au niveau des arguments de fonctions :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/rest.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const returnNameAndArgs = (name, ...args) =&gt; {
  return { name, args };
};

const a = { name: 'Cabécou'};
const b = { name: 'Chaource' };

const { name, args:cheeses } = returnNameAndArgs('Fromages', a, b);  <i class="conum" data-value="1"></i><b>(1)</b>

console.log(name);    <i class="conum" data-value="2"></i><b>(2)</b>
console.log(cheeses); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assigne la constante décomposée <code>args</code> en tant que constante <code>cheeses</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>Fromages</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>[ { name: 'Cabécou' }, { name: 'Chaource' } ]</code> –</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En bref, ils sont l&#8217;équivalent de l&#8217;ancienne variable <em>magique</em> <code>arguments</code> mais avec une meilleure finesse quant aux paramètres concernés.
Les éléments retournés par les <em>paramètres du reste</em> ont aussi l&#8217;avantage d&#8217;être un véritable objet de <a href="#primitives/array">tableau</a> – <code>arguments</code> est <em>itérable</em> mais n&#8217;est pas un tableau et ne bénéficie donc pas des méthodes de compréhension telles que <code>forEach</code>, <code>map</code>, etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="primitive-map-set">4.3.10. Map et Set</h4>
<div class="paragraph">
<p>Deux nouvelles interfaces d&#8217;itération sont disponibles depuis <em>ECMAScript 2015</em> : <em>Map</em> et <em>Set</em>.
Elles font penser respectivement à <code>Object</code> et <code>Array</code> mais diffèrent de ces primitives sur les points suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>elles garantissent l'<strong>unicité par référence</strong> des valeurs ;</p>
</li>
<li>
<p>elles garantissent l'<strong>ordre</strong> des valeurs ;</p>
</li>
<li>
<p>elles exposent la <strong>même interface</strong> de navigation et de manipulation ;</p>
</li>
<li>
<p>elles peuvent être créées à partir d&#8217;un <em>itérable</em> ou d&#8217;un tableau (de valeurs ou de clés+valeurs).</p>
</li>
</ul>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitive-set.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const primes = new Set([11, 13]);  <i class="conum" data-value="1"></i><b>(1)</b>
const primesArray = Array.from(primes);
console.log(primesArray);          <i class="conum" data-value="2"></i><b>(2)</b>

const example = new Set();
example.add(2);
example.add(3);
example.add([5, 7]);
example.add([5, 7]);               <i class="conum" data-value="3"></i><b>(3)</b>
example.add(primes);               <i class="conum" data-value="4"></i><b>(4)</b>
example.add(primesArray);
example.add(primesArray);          <i class="conum" data-value="5"></i><b>(5)</b>

console.log(example);              <i class="conum" data-value="6"></i><b>(6)</b>
console.log([...example]);         <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Construit un <code>Set</code> depuis un <code>Array</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reconstruit un <code>Array</code> à partir des valeurs du <code>Set</code> et affiche <code>[ 11, 13 ]</code>;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ce tableau sera ajouté car s&#8217;il est identique au précédent, il s&#8217;agit d&#8217;un objet différent, donc d&#8217;une référence d&#8217;objet différente ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>On peut ajouter un <code>Set</code> en tant que valeur de <code>Set</code> si on le souhaite ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>À l&#8217;inverse du point 3, l&#8217;ajout multiple d&#8217;une référence à un même objet (ici, <code>primesArray</code>) ne fonctionnera pas ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Affiche <code>Set { 2, 3, [ 5, 7 ], [ 5, 7 ], Set { 11, 13 }, [ 11, 13 ] }</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Utilise la <a href="#primitive-destructuring">décomposition</a> pour extraire les valeurs du <code>Set</code> et affiche <code>[ 2, 3, [ 5, 7 ], [ 5, 7 ], Set { 11, 13 }, [ 11, 13 ] ]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Map</code> offre quelques avantages à l&#8217;utilisation d&#8217;un <code>Object</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les clés peuvent être de n&#8217;importe quel type (y compris une référence à un autre objet ou tableau ECMAScript) ;</p>
</li>
<li>
<p><code>.size</code> retourne le nombre de clés de la <em>Map</em> ;</p>
</li>
<li>
<p>l&#8217;itération est très simple avec <code>for..of</code>, <code>forEach</code> ou même en utilisant la <a href="#primitive-destructuring">décomposition</a>.</p>
</li>
</ul>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitive-map.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const store = new Map();
const primes = new Set([2, 3, 5]);
const config = {
  debug: true,
};

store.set('config', config);
store.set(primes, { count: primes.size });  <i class="conum" data-value="1"></i><b>(1)</b>

store.forEach((value, key) =&gt; console.log(key, value));  <i class="conum" data-value="2"></i><b>(2)</b>

for (let [key, value] of store) {
  console.log(key, value);  <i class="conum" data-value="3"></i><b>(3)</b>
}

console.log(store.size);    <i class="conum" data-value="4"></i><b>(4)</b>
console.log(...store);      <i class="conum" data-value="5"></i><b>(5)</b>

store.clear();
console.log(...store);      <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assigne un objet en référence de <code>Map</code> vers un objet de type <code>Set</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parcourt chaque enregistrement de <code>Map</code> et en affiche sa clé et sa valeur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>Ditto</em> mais avec l&#8217;expression <code>for..of</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>2</code> car notre <code>Map</code> comporte 2 enregistrements ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Affiche les enregistrements de la <code>Map</code> sous forme de paires <code>[clé, valeur]</code>;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Affiche <code>&#160;</code> (<em>rien</em>) car la <code>Map</code> a été vidée à la ligne précédente.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Toutefois <em>Map</em> et <em>Set</em> ont quelques inconvénients :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>absence des méthodes de compréhension de tableau (<code>map</code>, <code>reduce</code> etc.) ;</p>
</li>
<li>
<p>pas de conversion native en JSON.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>À vous de choisir entre <code>Object</code> et <code>Map</code> ou entre <code>Array</code> et <code>Set</code> en fonction de la rigueur de vos besoins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Pour en savoir plus</div>
<div class="paragraph">
<p>La documentation complète de <code>Map</code> et de <code>Set</code> est disponible en français sur la ressource communautaire MDN :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Map" class="bare">developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Map</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Set" class="bare">developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Set</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-class">4.3.11. Class</h4>
<div class="paragraph">
<p>ECMAScript 2015 ajoute au langage des sucres syntaxiques facilitant la création et maintenance d&#8217;objets métier.
Nous bénéficions d&#8217;une véritable notion de constructeur, de méthodes statiques et même d&#8217;extension de prototype — on pourrait parler d&#8217;héritage mais nous n&#8217;avons pas envie d&#8217;aller dans cette direction, pas vrai ?</p>
</div>
<div class="paragraph">
<p>Tout ce que nous attachions auparavant à une <em>fonction</em>, nous nous référons désormais à une <em>classe</em> à proprement parler.<br>
En voici un exemple de définition :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">class-view.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

class View {
  constructor(config) {
    this.config = Object.assign({}, config);
  }

  render() {
    throw new Error('Extend the View class to render content.');
  }

  static removeDuplicates(char, content) {
    return content.replace(new RegExp(`[${char}]{2,}`), char);
  }
}

module.exports = View;</code></pre>
</div>
</div>
<div class="paragraph">
<p>La définition de la classe <code>View</code> comporte trois fonctions :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>constructor</code> : le constructeur invoqué à chaque nouvelle instantiation via l&#8217;opérateur <code>new</code> ;</p>
</li>
<li>
<p><code>render</code> : une méthode partagée par toutes les instances de <code>View</code> — équivalent à <code>View.prototype.render = function () { &#8230;&#8203; }</code> ;</p>
</li>
<li>
<p><code>removeDuplicates</code> : une méthode statique, utilisable indépendamment des instances de <code>View</code> — équivalent à <code>View.removeDuplicates = () &#8658; ({ &#8230;&#8203; })</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre le comportement de la classe <code>View</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/class-constructor.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const View = require('../class-view.js');

const htmlView = new View({ blacklist: ['object', 'iframe']});

console.log(typeof htmlView);                         <i class="conum" data-value="1"></i><b>(1)</b>
console.log(htmlView instanceof View);                <i class="conum" data-value="2"></i><b>(2)</b>
console.log(htmlView.config);                         <i class="conum" data-value="3"></i><b>(3)</b>
console.log(View.removeDuplicates('.', 'Node...js')); <i class="conum" data-value="4"></i><b>(4)</b>

try {
  htmlView.render({ title: 'Node.js' });
}
catch (err) {
  console.error(err);                                 <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>object</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>true</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>{ blacklist: [ 'object', 'iframe' ] }</code> — l&#8217;objet de configuration initial ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>Node.js</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Affiche une exception personnalisée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous l&#8217;avons vu précédemment au niveau des <a href="#primitive-object">objets</a>, ECMAScript permet de définir des accesseurs.<br>
L&#8217;exemple suivant illustre leur définition au sein d&#8217;une classe :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/class-accessors.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

class Book {
  constructor(title) {
    this.title = title;
    this.GS1;
    this.ISBN;
  }

  get EAN13() {
    return this.GS1 + '-' + this.ISBN;
  }

  set EAN13(value) {
    const EAN13 = value.split('-');

    this.GS1 = EAN13[0];
    this.ISBN = EAN13[1];
  }
}

const cssBook = new Book('CSS maintenables');
cssBook.EAN13 = '978-2212136401';

console.log(cssBook.GS1);  <i class="conum" data-value="1"></i><b>(1)</b>
console.log(cssBook.ISBN); <i class="conum" data-value="2"></i><b>(2)</b>
console.log(cssBook.EAN13);<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'978'</code>;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'2212136401'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>'978-2212136401'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La logique des accesseurs est ainsi partagée entre <em>tous les objets</em> étant des instances de <code>Book</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre deux classes héritant de notre classe <code>View</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/class-extends.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const View = require('../class-view');

class HTMLView extends View {
  constructor (options) {
    super(Object.assign({ doctype: 'html'}, options));

    this.doctype = this.config.doctype;
  }

  render (data) {
    return `&lt;!DOCTYPE ${this.doctype}&gt;
&lt;html&gt;
  &lt;title&gt;${data.title}&lt;/title&gt;
  &lt;body&gt;
    &lt;h1&gt;${data.title}&lt;/h1&gt;

    &lt;main&gt;${data.content}&lt;/main&gt;
  &lt;/body&gt;
&lt;/html&gt;`;
  }
}

class TextView extends View {
  render (data){
    const underline = '#'.repeat(data.title.length + 2);

    return `# ${data.title}
${underline}

${data.content.trim()}`
  }
}

const viewData = {title: 'Node.js', content: ' Hello World! '};

console.log((new HTMLView()).render(viewData));   <i class="conum" data-value="1"></i><b>(1)</b>
console.log((new TextView()).render(viewData));   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne une chaîne de HTML après avoir interpolé les variables avec leur valeur respective ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne la chaîne de texte <code># Node.js\n#########\n\nHello World!</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HTMLView</code> surcharge le constructeur tandis que <code>TextView</code> se contente du comportement par défaut défini par le constructeur de <code>View</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;appel à la fonction <code>super</code> revient à <em>appeler le constructeur de la classe que l&#8217;on étend</em>.
Ne pas l&#8217;appeler revient à ne pas exécuter le constructeur de la classe parent.</p>
</div>
<div class="paragraph">
<p>S&#8217;il est désormais plus sûr d&#8217;utiliser l&#8217;extension de chaîne prototypale, <strong>il ne faut pas abandonner la composition</strong> pour autant.</p>
</div>
<div class="paragraph">
<p>Il est en effet bien plus simple de réutiliser (et de tester) des fonctions agnostiques de contexte — agnostiques du <code>this</code> — que de maintenir de grosses classes héritant sur plusieurs niveaux.</p>
</div>
</div>
<div class="sect3">
<h4 id="primitive-promise">4.3.12. Promise</h4>
<div class="paragraph">
<p>L&#8217;organisation du code autour des <em>callbacks</em> est difficile et ce, que ce soit en terme de maintenance, de gestion des erreurs ou de propagation d&#8217;information.</p>
</div>
<div class="paragraph">
<p>Un motif a émergé en réponse à cette complexité grandissante : les <strong>promesses</strong>.
<strong>Il s&#8217;agit d&#8217;une primitive à maitriser</strong> et disponible <em>nativement</em> à la fois dans Node et les navigateurs modernes.</p>
</div>
<div class="paragraph">
<p>Historiquement, de nombreuses librairies ont proposé leur propre implémentation de promesses mais avec le défaut de ne pas être interopérables entre elles.
La spécification <em>Promise/A+</em> a émergé pour établir un standard de compatibilité.
ECMAScript 2015 introduit nativement cette API, la rendant alors disponible pour le web et pour Node, avec ou sans <em>polyfill</em>.</p>
</div>
<div class="paragraph">
<p>Les cas d&#8217;utilisation des promesses sont multiples :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exécuter une continuité d&#8217;actions asynchrones ;</p>
</li>
<li>
<p>paralléliser des actions asynchrones et exécuter des instructions lorsqu&#8217;une ou plusieurs de ces actions sont terminées ;</p>
</li>
<li>
<p>simplifier la gestion des erreurs à n&#8217;importe quelle étape du processus asynchrone.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Définition</span> Promesse</div>
<div class="paragraph">
<p>Une promesse est <strong>un objet retourné immédiatement</strong> et qui exécute une fonction de résolution <strong>une seule et <em>unique</em> fois dans le futur</strong>.
Cette résolution peut être soit <em>positive</em> soit <em>négative</em>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est un peu comme envoyer un <em>courrier suivi</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le bureau de poste vous remet une preuve de dépôt (la promesse) ;</p>
</li>
<li>
<p>les services postaux acheminent l&#8217;accusé de réception lorsque le destinataire a reçu le courrier et signé l&#8217;avis de délivrance (<em>résolution positive</em>) ;</p>
</li>
<li>
<p>les services postaux émettent un accusé de non-délivrance si le destinataire n&#8217;a pas signé ni récupéré son courrier dans un délai imparti (<em>résolution négative</em>).</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une <code>Promise</code> consiste à appeler un <em>constructeur</em> implémentant le <em>pattern</em> <em>Executor</em>.
Le constructeur transmet les fonctions d&#8217;exécution permettant de <em>résoudre</em> la promesse, <em>positivement</em> en appelant <code>resolve</code> ou <em>négativement</em>, en appelant <code>reject</code>.<br>
<code>resolve</code> et <code>reject</code> transmettent les valeurs passées en argument à vos <em>callbacks</em> souscrivant respectivement à <code>then</code> et <code>catch</code>.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/promise.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const p = new Promise((resolve, reject) =&gt; resolve('deux'));

p.then(label =&gt; {
    console.log(label);                 <i class="conum" data-value="2"></i><b>(2)</b>

    return label.toUpperCase();
  })
  .then(LABEL =&gt; console.log(LABEL))    <i class="conum" data-value="3"></i><b>(3)</b>
  .then(LABEL =&gt; console.log(LABEL))    <i class="conum" data-value="4"></i><b>(4)</b>

console.log('un');                      <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>un</code> car la promesse est résolue de manière asynchrone, donc après l&#8217;exécution de cette ligne synchrone ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>deux</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>DEUX</code> car la promesse précédente résoud la valeur <em>DEUX</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>undefined</code> car la promesse précédent ne résoud <em>rien</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre une encapsulation de la fonction <code>fs.readFile</code> de Node en tant que promesse :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/readfile.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');

const readFilePromise = (file) =&gt; {
  return new Promise((resolve, reject) =&gt; {
    fs.readFile(file, (err, buffer) =&gt; {          <i class="conum" data-value="1"></i><b>(1)</b>
      if (err) {
        return reject(err);                       <i class="conum" data-value="2"></i><b>(2)</b>
      }

      resolve(JSON.parse(buffer));                <i class="conum" data-value="3"></i><b>(3)</b>
    });
  });
};

module.exports = readFilePromise;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La promesse englobe l&#8217;exécution asynchrone — toute exception levée revient à implicitement appeler <code>reject</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Résout négativement la promesse en passant le contenu de la dite erreur ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Résout positivement la promesse — si le <em>parsing</em> échoue, la promesse sera rejetée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une instance de <code>Promise</code> expose plusieurs méthodes pour propager le statut de son exécution.
Les plus couramment employées sont <code>then</code> et <code>catch</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>then(onSuccess[, onError])</code> : fonction acceptant un <em>callback</em> de résolution et un <em>callback</em> de rejet facultatif ;</p>
</li>
<li>
<p><code>catch(onError)</code> : fonction acceptant un <em>callback</em> de rejet.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Illustrons désormais la consommation d&#8217;une promesse en se basant sur le code précédent :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/promise-readfile.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const readFilePromise = require('./readfile-promise');

const file = join(__dirname, '..', '..', 'package.json');

const logError = (err) =&gt; console.error(err);

readFilePromise(file)                                 <i class="conum" data-value="1"></i><b>(1)</b>
  .then(pkg =&gt; Object.keys(pkg.dependencies).length)  <i class="conum" data-value="2"></i><b>(2)</b>
  .then(count =&gt; console.log(count))                  <i class="conum" data-value="3"></i><b>(3)</b>
  .catch(logError);                                   <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Création d&#8217;une <code>Promise</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Consommation du résultat et propagation d&#8217;une nouvelle promesse retournant le nombre de dépendances contenu dans le <code>package.json</code> de ce chapitre ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Consommation du nouveau résultat ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Cette fonction sera appelée si une erreur se déclenche en amont de la chaîne de promesses.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Promise.all</code> est une méthode statique de l&#8217;API <em>Promise</em> qui retourne elle-même une promesse.
Elle sera résolue positivement lorsque toutes les promesses passées en argument seront résolues ou négativement dès que l&#8217;une d&#8217;entre elles échouera.</p>
</div>
<div class="paragraph">
<p>Reprenons le précédent exemple pour compter <em>en parallèle</em> les dépendances de trois fichiers <code>package.json</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/promise-all.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const readFilePromise = require('./readfile-promise');

const files = ['chapter-02', 'chapter-01', 'chapter-03'].map(dir =&gt; {
  return join(__dirname, '..', '..', '..', dir, 'package.json');
});

const logError = (err) =&gt; console.error(err);

Promise.all(files.map(readFilePromise))               <i class="conum" data-value="1"></i><b>(1)</b>
  .then(allPkgs =&gt; allPkgs.reduce((count, pkg) =&gt; {   <i class="conum" data-value="2"></i><b>(2)</b>
    return count + Object.keys(pkg.dependencies || {}).length;
  }, 0))
  .then(count =&gt; console.log(count))                  <i class="conum" data-value="3"></i><b>(3)</b>
  .catch(logError);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On passe un tableau de promesses non-résolues à <code>Promise.all</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cette fonction est exécutée dès que le tableau est résolu, avec le contenu de chaque fichier – dont nous comptons un par un le nombre de dépendances ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cette ligne ne change pas par rapport au précédent exemple — un bénéfice d&#8217;une bonne découpe de code.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usez et abusez des promesses : elles sont un des meilleurs moyens à notre disposition pour <strong>modulariser</strong>, <strong>linéariser</strong> et <strong>clarifier le sens</strong> du flot de notre code.</p>
</div>
<div class="paragraph">
<p>Nous aborderons à nouveau les <a href="#pattern-promise">promesses en tant que <em>design pattern</em></a> dans ce même chapitre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Guide des promesses</div>
<div class="paragraph">
<p>Un guide <em>très</em> complet — en anglais — est publié en libre consultation sur le site du W3C.
Un dépôt sur GitHub permet d&#8217;y contribuer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.w3.org/2001/tag/doc/promises-guide" class="bare">www.w3.org/2001/tag/doc/promises-guide</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://github.com/w3ctag/promises-guide" class="bare">github.com/w3ctag/promises-guide</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Pour en savoir plus</div>
<div class="paragraph">
<p>La documentation complète de <code>Promise</code> est disponible en français sur la ressource communautaire MDN :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Promise" class="bare">developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Promise</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-async-await">4.3.13. async/await</h4>
<div class="paragraph">
<p>Nous avons beaucoup appris sur les différents moyens d&#8217;organiser notre code de manière asynchrone.
Peut-être avec une indigestion de <code>then()</code>.<br>
Les opérateurs <code>async</code> et <code>await</code> sont là pour respectivement :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>déclarer une fonction comme pouvant <em>être mise en pause</em> ;</p>
</li>
<li>
<p>mise en pause effectuée avec l&#8217;opérateur <code>await</code>, pause suivie jusqu&#8217;à ce qu&#8217;une… promesse retourne un résultat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Une promesse placée derrière un <code>await</code> jettera une exception.
Cette exception est interceptable avec un bloc <code>try/catch</code>, comme du code synchrone.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Preview</span> Fonctionnalité expérimentale</div>
<div class="paragraph">
<p>Les opérateurs <code>async</code> et <code>await</code> ne sont pas disponibles dans Node v6.
Il nous faudra installer <em>a minima</em> Node v7.6 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ nvm install v7
$ node un-script.js</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reprenons une nouvelle fois notre exemple précédent, en combinant la transformation en promesses et les opérateurs <code>async</code> et <code>await</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">primitives/async-await.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const fs = require('fs');
const promisify = require('pify');
const { readFile:readFilePromise } = promisify(fs);

const files = ['chapter-02', 'chapter-01', 'chapter-03'].map(dir =&gt; {
  return join(__dirname, '..', '..', '..', dir, 'examples', 'package.json');
});

async function getAllDeps (files) {                      <i class="conum" data-value="1"></i><b>(1)</b>
  const deps = {};

  for (let filePath of files) {
    const fileBuffer = await readFilePromise(filePath);  <i class="conum" data-value="2"></i><b>(2)</b>
    const pkg = JSON.parse(String(fileBuffer));          <i class="conum" data-value="3"></i><b>(3)</b>

    Object.assign(deps, pkg.dependencies);
  }

  return deps;
}

getAllDeps(files)                                        <i class="conum" data-value="4"></i><b>(4)</b>
  .then(deps =&gt; console.log(Object.keys(deps).length))   <i class="conum" data-value="5"></i><b>(5)</b>
  .catch(err =&gt; console.error(err));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Déclaration de la fonction <code>getAllDeps</code> en tant que fonction asynchrone ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On itère comme de manière synchrone, en demandant à l&#8217;interpréteur d&#8217;attendre que la promesse <code>readFilePromise</code> soit résolue ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le contenu de <code>fileBuffer</code> est disponible à la ligne d&#8217;après, sans utiliser <code>readFilePromise.then()</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>La fonction <code>getAllDeps</code> retourne une promesse ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&lt;2&gt; Résultat identique à celui calculé dans <code>primitives/promise-all.js</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>À travers cet exemple on comprend qu&#8217;une fonction <code>async</code> retourne en réalité une promesse.
Promesse résolue lorsque toutes ses conditions <code>await</code> sont elles aussi résolues séquentiellement.</p>
</div>
<div class="paragraph">
<p>L&#8217;inconvénient de notre exemple est que la lecture des fichiers ne se fait plus en <em>parallèle</em> mais bel et bien de manière <em>séquentielle</em>.
En effet, notre code est mis en pause à chaque itération de boucle, lors de l&#8217;appel de <code>readFilePromise</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="primitive-regexp">4.3.14. RegExp</h4>
<div class="paragraph">
<p>Les expressions régulières en JavaScript permettent de pratiquer des recherches de motifs simples et complexes au sein de chaînes de caractères.
Elles sont inspirées de l&#8217;implémentation dans Perl 5.</p>
</div>
<div class="paragraph">
<p>L&#8217;opérateur <code>instanceof</code> permet d&#8217;identifier une instance d&#8217;expression régulière :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/Eyroll?es/g instanceof RegExp; <i class="conum" data-value="1"></i><b>(1)</b>
(new RegExp('Eyroll?es', 'g')) instanceof RegExp; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La méthode <code>exec</code> permet de capturer les occurrences d&#8217;une expression régulière au sein d&#8217;une chaîne de caractères :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/(.+)(Script)/.exec('ECMAScript'); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>['ECMAScript', 'ECMA', 'Script']</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Plusieurs drapeaux peuvent être utilisés :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>g</code> pour chercher dans toute la chaîne et ne pas s&#8217;arrêter à la première occurrence trouvée ;</p>
</li>
<li>
<p><code>i</code> pour ne pas tenir compte de la casse ;</p>
</li>
<li>
<p><code>m</code> pour que les caractères <code>^</code> et <code>$</code> correspondent respectivement au début et à la fin d&#8217;une ligne au lieu du début et de la fin de la chaîne ;</p>
</li>
</ul>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">let re;
const text = ['JavaScript', 'ECMAScript'].join("\n");

re = /^([a-z]+)(Script)/;
re.exec(text); <i class="conum" data-value="1"></i><b>(1)</b>

re = /^([a-z]+)(Script)/i;
re.exec(text); <i class="conum" data-value="2"></i><b>(2)</b>

re = /([a-z]+)(Script)$/i;
re.exec(text); <i class="conum" data-value="3"></i><b>(3)</b>

re = /([a-z]+)(Script)$/im;
re.exec(text); <i class="conum" data-value="4"></i><b>(4)</b>

re = /^([a-z]+)(Script)$/gim;
re.exec(text); <i class="conum" data-value="5"></i><b>(5)</b>
re.exec(text); <i class="conum" data-value="6"></i><b>(6)</b>
re.exec(text); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>null</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>['JavaScript', 'Java', 'Script']</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retourne <code>['ECMAScript', 'ECMA', 'Script']</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retourne <code>['JavaScript', 'Java', 'Script']</code>, puisque <code>$</code> correspond à la fin de ligne et non la fin de chaîne ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retourne <code>['JavaScript', 'Java', 'Script']</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Retourne <code>['ECMAScript', 'ECMA', 'Script']</code> puisque le curseur a effectué la recherche après la position de la précédente occurrence ;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Retourne <code>null</code> puisque le curseur a rencontré la fin de la chaîne ;</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Gare à la réutilisation de l&#8217;objet <em>RegExp</em> !</div>
<div class="paragraph">
<p>Vous l&#8217;aurez remarqué avec le drapeau <code>g</code>, le comportement de la méthode <code>exec</code> peut renvoyer un résultat différent à chaque appel.</p>
</div>
<div class="paragraph">
<p>Il faut juste veiller à ce que ce soit un résultat escompté pour éviter tout effet de bord dans vos applications.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>À la manière de <code>exec</code>, la méthode <code>test</code> se contente de renvoyer un booléen si un motif a été trouvé ou non :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/(.+)(Script)/.test('ECMAScript'); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>true</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="primitive-json">4.3.15. JSON</h4>
<div class="paragraph">
<p>L&#8217;introduction du support natif du parsing JSON dans ECMAScript 5 a apporté un grand confort dans la consommation de données issues d&#8217;API.
La sécurité de cette consommation a été améliorée de par sa prise en charge par les développeurs de VM ECMAScript.</p>
</div>
<div class="paragraph">
<p>La fonction <code>JSON.parse</code> tente de convertir une chaîne de texte supposée au format JSON en un objet natif :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const jsonContent = '{ "ECMAScript": 5.1 }';

typeof jsonContent; <i class="conum" data-value="1"></i><b>(1)</b>

const content = JSON.parse(jsonContent);
content.ECMAScript; <i class="conum" data-value="2"></i><b>(2)</b>

try {
  JSON.parse('{ "ECMAScript": 5.1');
}
catch (err) {
  console.log(err.message); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'string'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>5.1</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>Unexpected end of input</code> car <code>JSON.parse</code> a lancé une exception <code>SyntaxError</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>À l&#8217;inverse, la fonction <code>JSON.stringify</code> convertit un objet natif en chaîne de caractères au format JSON :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">JSON.stringify({ ECMAScript: 5.1 }); <i class="conum" data-value="1"></i><b>(1)</b>
JSON.stringify({ ECMAScript: 5.1 }, null, 2); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>'{"ECMAScript":5.1}'</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>'{\n&#160;&#160;"ECMAScript": 5.1\n}'</code>, le troisième argument formate proprement avec la taille d&#8217;indentation spécifiée, exprimée en nombre d&#8217;espaces par niveau de profondeur.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">URL</span> Spécification ECMAScript</div>
<div class="paragraph">
<p>L&#8217;ensemble de la spécification ECMAScript est disponible aux formats PDF et HTML.
Il s&#8217;agit d&#8217;une mine d&#8217;or pour comprendre les mécanismes internes du langage, les types et primitives à disposition.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.ecma-international.org/ecma-262/5.1/" class="bare">www.ecma-international.org/ecma-262/5.1/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="globals">4.4. Variables globales dans Node.js</h3>
<div class="paragraph">
<p>En plus des primitives ECMAScript, Node introduit des variables globales supplémentaires.
Elles vous seront utiles pour faciliter le débogage ou tout simplement pour le développement et le partage de vos modules.</p>
</div>
<div class="sect3">
<h4 id="_console">4.4.1. console</h4>
<div class="paragraph">
<p>Toute personne ayant développé du JavaScript pour le navigateur a très certainement utilisé <code>console.log</code> pour tracer l&#8217;état d&#8217;une expression lors de l&#8217;exécution de son code.</p>
</div>
<div class="paragraph">
<p>Trois fonctions sont à garder dans un coin de la tête :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>console.log</code> ;</p>
</li>
<li>
<p><code>console.error</code> ;</p>
</li>
<li>
<p><code>console.trace</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>console.log</code> affiche une représentation textuelle d&#8217;une expression et la formate avec des motifs équivalents à la fonction C <code>printf()</code>.<br>
Ce contenu est envoyé vers la sortie standard, <code>process.stdout</code> :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console.log('ECMA%s', 'script'); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>'ECMAScript'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>console.error</code> a exactement le même comportement mais redirige vers le flux d&#8217;erreur, <code>process.stderr</code>.</p>
</div>
<div class="paragraph">
<p><code>console.trace</code> envoie l&#8217;état de la <em>stack trace</em> vers le flux d&#8217;erreur :</p>
</div>
<div class="listingblock">
<div class="title">stack-trace.js</div>
<div class="content">
<pre>$ node stack-trace.js
At level 1
At level 2
At level 3
At level 4
Trace: Level 5
    at traceAtLevel (…/examples/02-first-steps/stack-trace.js:11:13)
    at traceAtLevel (…/examples/02-first-steps/stack-trace.js:8:5)
    at traceAtLevel (…/examples/02-first-steps/stack-trace.js:8:5)
    at traceAtLevel (…/examples/02-first-steps/stack-trace.js:8:5)
    at traceAtLevel (…/examples/02-first-steps/stack-trace.js:8:5)
    at Object.&lt;anonymous&gt; (…/examples/02-first-steps/stack-trace.js:15:1)
    at Module._compile (module.js:456:26)
    at Object.Module._extensions..js (module.js:474:10)
    at Module.load (module.js:356:32)
    at Function.Module._load (module.js:312:12)</pre>
</div>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur les méthodes et fonctions disponibles, reportez-vous à la documentation en ligne du module <code>console</code> sur <span class="URL"><a href="https://nodejs.org/api/console.html" class="bare">nodejs.org/api/console.html</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="api-process">4.4.2. process</h4>
<div class="paragraph">
<p>L&#8217;objet <code>process</code> correspond à l&#8217;instance de l&#8217;environnement Node en cours d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Il permet de s&#8217;interfacer avec le système, en écoutant les évènements qu&#8217;il envoie au processus ou en écoutant les évènements que Node s&#8217;apprête à envoyer au système d&#8217;exploitation.</p>
</div>
<div class="paragraph">
<p>Le tableau <code>process.argv</code> contient le chemin du script exécuté ainsi que les différents arguments transmis à Node :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">process.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

console.log(process.argv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécutons ce même script avec différents arguments :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node process.js <i class="conum" data-value="1"></i><b>(1)</b>
node process.js argument1 "argument 2" --option1 <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retourne <code>[ 'node', '…/examples/chapitre-02/process.js' ]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retourne <code>[ 'node', '…/examples/chapitre-02/process.js', 'argument1', 'argument 2', '--option1' ]</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il n&#8217;en faut pas davantage pour bâtir votre premier programme en ligne de commande.
Pour des besoins plus avancés, il existe un certain nombre de modules <em>npm</em> pour exploiter les options et arguments.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Arguments internes</div>
<div class="paragraph">
<p>Comment faire pour passer des arguments à Node sans qu&#8217;ils soient interprétés par le script et vice-versa ?
Il suffit de les placer au bon endroit lorsque vous construisez l&#8217;appel à l&#8217;exécutable Node :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node &lt;arguments node&gt; chemin/vers/script.js &lt;arguments script&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Ces arguments se retrouveront respectivement dans <code>process.execArgv</code> et <code>process.argv</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="stdio" class="paragraph">
<p>Le deuxième ensemble d&#8217;objets à connaître est le trio <code>process.stdin</code>, <code>process.stdout</code> et <code>process.stderr</code>.
Ce sont trois flux (<em>Streams</em>) qui permettent d&#8217;accéder respectivement à l&#8217;entrée standard, à la sortie standard et à l&#8217;erreur standard.</p>
</div>
<div class="paragraph">
<p>Si ces noms ne vous parlent peut-être pas, c&#8217;est parce qu&#8217;ils sont directement inspirés d&#8217;UNIX.
Ils sont directement accessibles via l&#8217;interface JavaScript de Node.</p>
</div>
<div class="paragraph">
<p>Le script suivant convertit toute chaîne de caractères envoyée vers l&#8217;entrée standard en lettres majuscules :</p>
</div>
<div class="listingblock">
<div class="title">uppercase.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

process.stdin.on('data', buffer =&gt; {
  process.stdout.write(buffer.toString().toUpperCase() + '\n');
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécutons ce script sur un système Unix :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>echo "Entrée standard" | node uppercase.js <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>ENTRÉE STANDARD</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le concept de <em>Streams</em> sera développé petit à petit au fil de ce chapitre et dans le reste du livre.
C&#8217;est un concept puissant mais il y a des fonctionnalités plus simples à appréhender pour débuter.</p>
</div>
<div class="paragraph">
<p>Nous venons de voir que <code>process</code> est un objet contenant plusieurs attributs précieux.
L&#8217;héritage prototypal est utilisé pour le rendre capable d&#8217;émettre des évènements via la méthode <code>process.on()</code>.
Cette méthode est utilisée pour écouter les évènements système et permettre à nos programmes de réagir convenablement.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre la réaction face à un signal d&#8217;interruption (abrégé en <code>SIGINT</code>, pour <em>Signal Interrupt</em>).
Ce signal est notamment émis en pressant les touches <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="listingblock">
<div class="title">interrupt.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const maxTries = parseInt(process.argv[2], 10) || 5;

const terminateIn = tries =&gt; {
  return () =&gt; {
    if (--tries === 0) {
      console.log('Arrêt du programme…');
      process.exit(0);

      return;
    }

    console.log('Nombre d\'essais restants: %s', tries);
  };
};

console.log('Appuyer %s fois sur CTRL+C arrêtera le programme.', maxTries);
process.on('SIGINT', terminateIn(maxTries));
process.stdin.on('data', () =&gt; {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant son exécution dans un terminal Unix :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node interrupt.js 3 <i class="conum" data-value="1"></i><b>(1)</b>
^C <i class="conum" data-value="2"></i><b>(2)</b>
^C <i class="conum" data-value="3"></i><b>(3)</b>
^C <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>Appuyer 3 fois sur CTRL+C arrêtera le programme.</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>Nombre d&#8217;essais restants: 2</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>Nombre d&#8217;essais restants: 1</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>Arrêt du programme…</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>process.title</code> est une API intéressante pour assigner un <em>titre</em> de process.
Cela concerne notamment les commandes de liste de processus actifs (comme <code>ls</code>).
On pourrait penser que cela offre l&#8217;avantage de rendre un processus singulier et donc plus facile à repérer :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node
&gt; process.title='hey!'</pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat lorsqu&#8217;on liste les processus :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/process-title.png" alt="process title" width="85%">
</div>
</div>
<div class="paragraph">
<p><strong>Attention</strong> toutefois car il se trouve que le résultat de ce nommage peut se révéler imprédictible en fonction des systèmes d&#8217;exploitation où le programme est exécuté.
Il est donc recommandé de <strong>ne pas utiliser <code>process.title</code></strong>.</p>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur les méthodes et fonctions disponibles, reportez-vous à la documentation en ligne du module <code>process</code> sur <span class="URL"><a href="https://nodejs.org/api/process.html" class="bare">nodejs.org/api/process.html</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_module">4.4.3. module</h4>
<div class="paragraph">
<p>Les modules CommonJS sont au cœur du fonctionnement de Node.
Ils permettent d&#8217;isoler, d&#8217;empaqueter et de rendre le code réutilisable.</p>
</div>
<div class="paragraph">
<p>La magie opère principalement grâce à la fonction <code>require</code> et à l&#8217;objet <code>module</code>.
Ils s&#8217;occupent respectivement de <em>charger</em> et de <em>déclarer</em> un module.</p>
</div>
<div class="paragraph">
<p>Techniquement parlant, un module est un fichier JavaScript dont toutes les variables sont privées et inaccessibles depuis l&#8217;extérieur.
Seules les variables exposées par <code>module.exports</code> sont publiquement accessibles.</p>
</div>
<div class="paragraph">
<p>Prenons l&#8217;exemple suivant :</p>
</div>
<div class="listingblock">
<div class="title">currency-format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const currencies = {
  FR: {
    symbol: '€',
    decimal: ',',
  },
};

const formatNumber = (separator, precision, number) =&gt; {
  return number.toFixed(precision).replace('.', separator);
};

const setupFormatter = currencyId =&gt; {
  const currency = currencies[currencyId];
  const f = formatNumber.bind(null, currency.decimal, 2);

  return function formatCurrency(amount) {
    return f(amount) + currency.symbol;
  };
};

module.exports = setupFormatter;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans le précédent exemple, le module <code>currency-format.js</code> est exposé en tant que fonction.
Les variables <code>currencies</code> et <code>formatNumber</code> restent encapsulées dans la portée du module.</p>
</div>
<div class="paragraph">
<p>Admettons que nous souhaitons utiliser ce module dans un programme, ici <code>currency-main.js</code> :</p>
</div>
<div class="listingblock">
<div class="title">currency-main.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const setupFormatter = require('./currency-format.js');
const formatCurrency = setupFormatter('FR');

console.log(typeof currencies);
console.log(formatCurrency(12));</code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction <code>require</code> chargera le fichier <code>currency-format.js</code> et assignera le résultat de l&#8217;export dans la variable de votre choix, ici, <code>setupFormatter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node currency-main.js <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>undefined</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Puis affiche <code>'12,00€'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lors de l&#8217;exécution du précédent programme, nous avons confirmation que la variable <code>currencies</code> contenue dans le module <code>currency-format.js</code> n&#8217;est pas disponible dans le module <code>currency-main.js</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Les modules Node</div>
<div class="paragraph">
<p>Un module Node est un répertoire contenant un fichier de description <code>package.json</code>.
Ce fichier contient notamment une propriété <code>main</code> indiquant quel fichier charger par défaut.
Les modules Node sont par convention placés dans un répertoire <code>node_modules</code>.</p>
</div>
<div class="paragraph">
<p>Voici un extrait du fichier <code>package.json</code> du module <code>lodash</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "name": "lodash",
  "version": "2.4.1",
  "main": "dist/lodash.js"
}</pre>
</div>
</div>
<div class="paragraph">
<p>Ainsi, exécuter <code>require('lodash');</code> revient à peu près à faire <code>require('./node_modules/lodash/dist/lodash.js');</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur les méthodes et fonctions disponibles, reportez-vous à la documentation en ligne des modules sur <span class="URL"><a href="https://nodejs.org/api/modules.html" class="bare">nodejs.org/api/modules.html</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="api-require">4.4.4. require</h4>
<div class="paragraph">
<p>Nous avons abordé le mécanisme de chargement de modules dans le point précédent.
Regardons plus en détails le comportement de la fonction <code>require</code>.</p>
</div>
<div class="paragraph">
<p>La fonction <code>require</code> permet de charger des fichiers locaux, des modules JavaScript, des modules binaires ou même des fichiers JSON :</p>
</div>
<div class="listingblock">
<div class="title">require.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

/* eslint-disable */

const fs = require('fs'); <i class="conum" data-value="1"></i><b>(1)</b>
const setupFormatter = require('./currency-format'); <i class="conum" data-value="2"></i><b>(2)</b>
const chap2Index = require('..'); <i class="conum" data-value="3"></i><b>(3)</b>
const _ = require('lodash'); <i class="conum" data-value="4"></i><b>(4)</b>
const packageInfos = require('../package.json'); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Charge le module Node natif <code>fs</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Charge le fichier <code>currency-format.js</code> : Node suffixe automatiquement le nom du fichier par <code>.js</code> (module JavaScript) ou par <code>.node</code> (module binaire) si l&#8217;extension manque ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Charge le fichier <code>examples/index.js</code> du répertoire <code>chapitre-02</code> car Node détecte que <code>chapitre-02</code> est un répertoire, découvre le fichier <code>package.json</code> et charge le fichier déclaré dans sa propriété <code>main</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Charge le module Node <code>lodash</code>, vraisemblablement depuis le répertoire <code>node_modules/lodash</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Charge et parse le fichier <code>package.json</code> en tant qu&#8217;objet ECMAScript.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>require</code> est une fonction synchrone <em>et</em> bloquante.
Cela permet de garantir l&#8217;ordre de chargement des modules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const path = require('path'); <i class="conum" data-value="1"></i><b>(1)</b>
const setupFormatter = require('./currency-format.js'); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Node interprète d&#8217;abord cette ligne… ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>… puis interprète celle-ci dès que le module <code>path</code> est chargé.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Qui dit bloquant dit que si du code est exécuté dans le module <em>avant</em> l&#8217;export, il ralentira l&#8217;exécution tant que le module n&#8217;aura pas été mis en cache.<br>
L&#8217;exemple suivant illustre le phénomène :</p>
</div>
<div class="listingblock">
<div class="title">blocking-module.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

let cycles = 0;

while (cycles++ &lt; 1000000000) {
  // do nothing
}

module.exports = cycles;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple précédent, il faut attendre que la boucle soit complétée avant que la fonction <code>require</code> ne rende la main et procède à l&#8217;exécution des instructions suivantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">require('./blocking-module.js');

console.log('module chargé'); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le message ne sera affiché que tardivement, environ une seconde après le chargement du module <code>blocking-module.js</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il faut s&#8217;assurer que le code exécuté pendant le chargement d&#8217;un module soit exclusivement non bloquant pour conserver la performance applicative.<br>
Le concept d&#8217;asynchronicité et de non bloquant est explicité plus en détail dans <em>Comprendre les accès non-bloquants</em>.</p>
</div>
<div class="paragraph">
<p>Node optimise le chargement des modules en les mettant en cache.
Autrement dit et de manière générale, <strong>un module est chargé une seule fois</strong>.
L&#8217;unicité d&#8217;un module est assurée par son emplacement au sein du système de fichiers, en se basant sur la propriété <code>module.id</code>.</p>
</div>
<div class="paragraph">
<p>Prenons le cas de ce module :</p>
</div>
<div class="listingblock">
<div class="title">increment-module.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

let counter = 0;

console.log(module.id);

module.exports = {
  run: () =&gt; counter++,
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le précédent module affichera son identifiant unique à chaque fois qu&#8217;il sera <em>chargé</em>.
Dès que la méthode <code>run()</code> de l&#8217;objet exporté sera appelée, elle incrémentera la variable privée <code>counter</code> et retournera sa nouvelle valeur.</p>
</div>
<div class="paragraph">
<p>Le module suivant fait deux fois appel à <code>increment-module.js</code> et assigne le résultat dans deux variables différentes.
Ceci dans le but de vérifier le comportement du mécanisme de chargement des modules Node.</p>
</div>
<div class="listingblock">
<div class="title">increment-main.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const incrementA = require('./increment-module.js');
const incrementB = require('./increment-module.js');

console.log(incrementA.run());
console.log(incrementB.run());
console.log(incrementA === incrementB);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ne reste plus qu&#8217;à l&#8217;exécuter pour constater ce qu&#8217;il se passe :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node increment-main.js <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>…/examples/chapitre-02/increment-module.js</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>0</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>1</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Affiche <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le module ayant déjà été chargé une fois, Node n&#8217;ira pas charger le fichier une deuxième fois et ne créera pas de nouvelle instance de l&#8217;objet <code>module</code>.
Il se contente de <strong>retourner la même instance de module</strong>.</p>
</div>
<div class="paragraph">
<p>Ce comportement peut être exploité	 en tant que <em>design pattern</em> <em>Singleton</em>, explicité plus en détail dans ce même chapitre.</p>
</div>
<div class="paragraph">
<p>Enfin, Node lancera une exception si une erreur se produit lors du chargement (fichier inexistant, erreur de syntaxe dans le fichier à charger).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">try {
  require('./module-inexistant.js');
}
catch (err) {
  console.log('L\'erreur est la suivante : %s', err.message); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>L&#8217;exécution de ce module affichera <code>L&#8217;erreur est la suivante : Cannot find module './module-inexistant.js'</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur le fonctionnement de la fonction <code>require</code>, reportez-vous à la documentation en ligne des modules sur <span class="URL"><a href="https://nodejs.org/api/modules.html" class="bare">nodejs.org/api/modules.html</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filename_et_dirname">4.4.5. __filename et __dirname</h4>
<div class="paragraph">
<p><code>__filename</code> et <code>__dirname</code> sont des constantes indiquant respectivement le chemin absolu du fichier exécuté et le chemin absolu du répertoire contenant le fichier exécuté.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">filename-dirname.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

console.log(__filename); <i class="conum" data-value="1"></i><b>(1)</b>
console.log(__dirname); <i class="conum" data-value="2"></i><b>(2)</b>
console.log(__filename === module.filename); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>…/examples/chapitre-02/filename-dirname.js</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Affiche <code>…/examples/chapitre-02</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Affiche <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Utiliser <code>__filename</code> et <code>__dirname</code> est utile pour travailler avec des chemins absolus, indépendamment du répertoire de travail de Node.</p>
</div>
</div>
<div class="sect3">
<h4 id="_settimeout_setinterval_et_setimmediate">4.4.6. setTimeout, setInterval et setImmediate</h4>
<div class="paragraph">
<p>Pour des raisons de commodité, Node fournit des implémentations de <code>setTimeout</code>, de <code>setInterval</code> et de <code>setImmediate</code>.
Pour rappel, ces fonctions de temps ne font pas partie de JavaScript mais de la spécification <em>DOM Level 0</em>.</p>
</div>
<div class="paragraph">
<p>Ces fonctions exécutent une fonction respectivement une seule fois dans un délai imparti, un nombre de fois indéterminé à un intervalle imparti et une seule fois immédiatement :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const print = (message) =&gt; {
  return print(){
    console.log(message); <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
  }
};

const timer = setInterval(print('interval'), 250);
setTimeout(print('timeout'), 200);
setImmediate(print('immediate'));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affichera d&#8217;abord <code>immediate</code>… ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>… suivi de <code>timeout</code> environ 200ms plus tard… ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>… puis <code>interval</code> environ 50ms plus tard et ce, toutes les 250ms tant que le programme ne sera pas arrêté ou que <code>clearTimeout</code> n&#8217;annulera pas l&#8217;intervalle.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur les méthodes et fonctions disponibles, reportez-vous à la documentation en ligne du module <code>timers</code> sur <span class="URL"><a href="https://nodejs.org/api/timers.html" class="bare">nodejs.org/api/timers.html</a></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="">4.4.7. _</h4>
<div class="paragraph">
<p>La variable globale <code>_</code> est un cas spécial.
Elle n&#8217;est prédéfinie que dans le terminal interactif (_REPL_).</p>
</div>
<div class="paragraph">
<p>Cette variable <em>magique</em> contient systématiquement le résultat de la dernière évaluation de code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node
&gt; 2 + 2
4
&gt; _ + 2
6</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_patterns">5. Design patterns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Certains concepts de programmation sont utiles à connaître pour écrire un code plus concis, mieux organisé et davantage consistant.</p>
</div>
<div class="paragraph">
<p>Ils vous permettront de mieux comprendre la différence entre du code bloquant et non-bloquant, asynchrone et synchrone et comment organiser votre code de manière robuste tout en apprenant à réagir aux erreurs.</p>
</div>
<div class="sect2">
<h3 id="_code_synchrone_et_asynchrone">5.1. Code synchrone et asynchrone</h3>
<div class="paragraph">
<p>Certains langages et la programmation DOM nous ont déjà habitué à gérer du code de manière asynchrone.
De manière générale, la différence réside dans l&#8217;accès au(x) résultat(s) de nos différentes invocations.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant est une démonstration de code synchrone :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const date = Date.now();</code></pre>
</div>
</div>
<div class="paragraph">
<p>En effet, le résultat est retourné <em>immédiatement</em> à la suite de l&#8217;invocation de la fonction.
La notion d'<em>immédiateté</em> correspond en réalité à un temps variable — dans le cas de cette fonction, à quelques nano-secondes.</p>
</div>
<div class="paragraph">
<p>Maintenant tentons de lire de manière asynchrone le contenu d&#8217;un fichier :</p>
</div>
<div class="listingblock">
<div class="title">pattern/async.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const filename = join(__dirname, '..', 'route.js');

fs.readFile(filename, (err, fileBuffer) =&gt; {
  if (err) {
    return console.error(err);
  }

  console.log(String(fileBuffer));
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Puisque la méthode <code>readFile</code> ne retourne pas de résultat dans le même cycle d'<em>Event loop</em>, il faut bien que le résultat soit transmis d&#8217;une manière ou d&#8217;une autre.</p>
</div>
<div class="paragraph">
<p>Le design pattern <em>callback</em> est employé pour retourner le résultat et le cas échéant, une erreur.
Ce design pattern est expliqué plus en détail dans une section suivante de ce même chapitre.</p>
</div>
<div class="paragraph">
<p>Si ce code est tout à fait fonctionnel, il présente quelques inconvénients :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il n&#8217;est pas réutilisable ;</p>
</li>
<li>
<p>il est difficile de discerner <em>où</em> manipuler le résultat attendu au premier abord ;</p>
</li>
<li>
<p>où intercepter les erreurs ? Et qu&#8217;en faire ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces problèmes seront amplifiés à mesure que la complexité de votre code et la profondeur des <em>callbacks</em> augmentera.</p>
</div>
<div class="paragraph">
<p>Tentons une approche plus modulaire, toujours asynchrone :</p>
</div>
<div class="listingblock">
<div class="title">pattern/async-reusable.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const getFilecontent = require('../filecontent/index.js');
const FILENAME = join(__dirname, '..', 'route.js');

const contentSuccess = (fileContent) =&gt; console.log(fileContent);
const contentFailure = (err) =&gt; console.error(err);

getFilecontent(FILENAME, contentSuccess, contentFailure);</code></pre>
</div>
</div>
<div class="paragraph">
<p>La séparation entre succès et échec est désormais évidente.
Le code est également plus lisible.
Son abstraction en module indépendant le rend réutilisable à tout niveau dans l&#8217;application — et testable par la même occasion :</p>
</div>
<div class="listingblock">
<div class="title">filecontent/index.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');

const getFilecontent = (filename, onSuccess, onError) =&gt; {
  fs.readFile(filename, (err, fileBuffer) =&gt; {
    if (err) {
      return onError(err);
    }

    onSuccess(String(fileBuffer));
  });
};

module.exports = getFilecontent;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Voyons à quoi ressemblerait ce code s&#8217;il était synchrone :</p>
</div>
<div class="listingblock">
<div class="title">pattern/sync.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const getFilecontent = require('../filecontent/sync.js');

const contentSuccess = fileContent =&gt; console.log(fileContent);
const contentFailure = err =&gt; console.error(err);

const fileContent = getFilecontent(join(__dirname, '..', 'route.js'));

if (fileContent instanceof Error){
  contentFailure(fileContent);
}
else {
  contentSuccess(fileContent);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalement le code n&#8217;est pas nécessairement plus clair.
On doit activement essayer de faire la distinction entre un résultat d&#8217;une valeur <em>fausse</em> et un résultat issu d&#8217;une erreur (système surchargé, fichier inexistant, lecture interrompue, <em>timeout</em> etc.).</p>
</div>
<div class="paragraph">
<p>Le module d&#8217;accès synchrone au contenu d&#8217;un fichier ressemblerait à ceci :</p>
</div>
<div class="listingblock">
<div class="title">filecontent/sync.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

/* eslint-disable no-sync */

const fs = require('fs');

const getFilecontent = (filename) =&gt; {
  try {
    const fileBuffer = fs.readFileSync(filename);
    return String(fileBuffer);
  }
  catch (e){
    return e;
  }
};

module.exports = getFilecontent;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il y a légèrement moins de lignes et le gain de lisibilité n&#8217;est pas flagrant.</p>
</div>
<div class="paragraph">
<p>Et d&#8217;ailleurs, puisque Node fournit des méthodes synchrones équivalentes au méthodes asynchrones, pourquoi s&#8217;embêter ?<br>
Parce que l&#8217;asynchronicité est le seul moyen de ne pas bloquer le processus en délégant à l'<em>Event loop</em> la responsabilité d&#8217;exécuter le <em>callback</em>, plus tard.</p>
</div>
<div class="paragraph">
<p><strong>Node nous procure en réalité une API non-bloquante</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_code_bloquant_et_non_bloquant">5.2. Code bloquant et non-bloquant</h3>
<div class="paragraph">
<p>Node est fréquemment acclamé pour son API asynchrone.
Toutefois le facteur le plus important est son caractère non-bloquant.
Mais alors, <strong>quelle différence entre code asynchrone et code non-bloquant</strong> ?</p>
</div>
<div class="paragraph">
<p>Considérons le code suivant :</p>
</div>
<div class="listingblock">
<div class="title">pattern/async-fake.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { join } = require('path');
const getFilecontent = require('../filecontent/async-fake.js');
const FILENAME = join(__dirname, '..', 'route.js');

const contentSuccess = (fileContent) =&gt; console.log(fileContent);
const contentFailure = (err) =&gt; console.error(err);

getFilecontent(FILENAME, contentSuccess, contentFailure);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ressemble en tout point à un de nos exemples précédent de code <em>non-bloquant</em>.
Pourtant il est bloquant car le code sur lequel il repose propose certes un mécanisme de <em>callback</em>, mais exécuté dans le même cycle d'<em>Event loop</em> :</p>
</div>
<div class="listingblock">
<div class="title">filecontent/async-fake.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

/* eslint-disable no-sync */

const fs = require('fs');

const getFilecontent = (filename, onSuccess, onError) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  try {
    const fileBuffer = fs.readFileSync(filename);          <i class="conum" data-value="2"></i><b>(2)</b>
    onSuccess(String(fileBuffer));
  }
  catch (e){
    onError(e);
  }
};

module.exports = getFilecontent;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cette interface de fonction suggère une fonction <em>asynchrone</em>…</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>… tandis que cette ligne est en réalité <strong>bloquante</strong>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le fait que Node explicite tout accès bloquant permet de repérer facilement ces goulots d&#8217;étrangement.</p>
</div>
<div class="paragraph">
<p>Que se passe-t&#8217;il du côté de Node si le code exécuté est :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bloquant</strong> : aucune instruction n&#8217;est traité, on <em>attend</em> ;</p>
</li>
<li>
<p><strong>non-bloquant</strong> : le reste des instructions du même cycle d'<em>Event loop</em> est traité et ainsi de suite.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En clair, on n&#8217;exécute pas du code non-bloquant parce que c&#8217;est davantage à la mode : on exécute du code non-bloquant pour économiser du temps et traiter davantage d&#8217;instructions.<br>
Par effet mécanique, à puissance CPU équivalente, un code non-bloquant pourra traiter davantage d&#8217;instructions à la seconde car il gâchera moins de temps à attendre un retour d&#8217;instruction.</p>
</div>
<div class="paragraph">
<p>Ne vous fiez pas nécessairement à l&#8217;API mise à disposition par les modules employés mais vérifiez bien qu&#8217;elles emploient un minimum d&#8217;instructions bloquantes.<br>
Un seul module bloquant et peu performant peut réduire à néant les performances de vos applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_index_js">5.3. index.js</h3>
<div class="paragraph">
<p>Il arrive que la modularisation de votre code nécessite l&#8217;utilisation de multiples appels à <code>require()</code> pour charger l&#8217;intégralité des modules nécessaires.</p>
</div>
<div class="paragraph">
<p>Ce n&#8217;est pas un signe de mauvais code mais on peut sentir une certaine répétition dans l&#8217;exemple suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const Person = require('./lib/models/person.js');
const Vehicle = require('./lib/models/vehicle.js');
const Location = require('./lib/models/location.js');
const Transaction = require('./lib/models/transaction.js');

const rental = new Transaction({
  // ...
});

rental.save((err, commit) =&gt; {
  if (err) {
    throw err;
	}

  // ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pourrions grouper les appels aux modèles car ils appartiennent à un même domaine.
L&#8217;exemple précédent se résumerait alors à ceci :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const models = require('./lib/models');

const rental = new models.Transaction({
  // ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lorsque le chemin indiqué en paramètre de la fonction <code>require()</code> est un répertoire, l&#8217;heuristique veut que Node vérifie l&#8217;existence d&#8217;un fichier <code>index.js</code> et le charge le cas échéant.</p>
</div>
<div class="paragraph">
<p>Ainsi, <code>require('./lib/models')</code> est équivalent à <code>require('./lib/models/index.js')</code>.</p>
</div>
<div class="paragraph">
<p>Le fichier <code>index.js</code> est quant à lui une factorisation des appels précédents :</p>
</div>
<div class="listingblock">
<div class="title">lib/models/index.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

module.exports = {
  Person: require('./person.js'),
  Location: require('./location.js'),
  Vehicle: require('./vehicle.js'),
  Transaction: require('./transaction.js')
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce <em>pattern</em> est utile pour réduire l&#8217;encombrement visuel et regrouper des modules par logique applicative.</p>
</div>
</div>
<div class="sect2">
<h3 id="_globbing">5.4. Globbing</h3>
<div class="paragraph">
<p>Le <em>globbing</em> est un <em>pattern</em> fréquemment employé dans le monde UNIX.
Au lieu de nommer des fichiers un par un, le mécanisme permet de désigner des motifs de sélection, de profondeur de recherche et d&#8217;exclusion.</p>
</div>
<div class="paragraph">
<p>Les motifs utilisables sont les suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>*</code> : n&#8217;importe quelle chaîne de caractères ;</p>
</li>
<li>
<p><code>**</code> : n&#8217;importe quel répertoire ;</p>
</li>
<li>
<p><code>{js,css}</code> : la chaîne <code>js</code> ou <code>css</code> ;</p>
</li>
<li>
<p><code>[js]</code> : un caractère dans l&#8217;ensemble <code>j</code> et <code>s</code> ;</p>
</li>
<li>
<p><code>!(js)</code> : sauf la chaîne <em>js</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Parcourir et filtrer le contenu d&#8217;un répertoire devient un jeu d&#8217;enfant — bien plus que s&#8217;il avait fallu utiliser soi-même l&#8217;API Node <code>fs</code> à coup de <code>readDir</code> récursif.</p>
</div>
<div class="paragraph">
<p>Au final, c&#8217;est ce qui est effectué mais sans que nous ayons à écrire ce code nous-même.</p>
</div>
<div class="listingblock">
<div class="title">pattern/glob.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const glob = require('glob');
const options = {
  cwd: __dirname
};

const displayFiles = (err, files) =&gt; {
  if (err) {
    throw err;
  }

  console.log(files);
};

glob('../template.*', options, displayFiles);        <i class="conum" data-value="1"></i><b>(1)</b>
glob('../template.{hbs,ej*}', options, displayFiles);<i class="conum" data-value="2"></i><b>(2)</b>
glob('../template.[ej]*', options, displayFiles);    <i class="conum" data-value="3"></i><b>(3)</b>
glob('../template.!(pug)', options, displayFiles);   <i class="conum" data-value="4"></i><b>(4)</b>
glob('../**/*.css', displayFiles);                   <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>fichiers débutant par <code>template</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>fichiers débutant par <code>template</code> et suffixés par <code>hbs</code> ou dont le suffixe débute par <code>ej</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>fichiers débutant par <code>template</code> et dont le suffixe est précédé par les lettres <code>e</code> ou <code>j</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>fichiers débutant par <code>template</code>, à l&#8217;exception de <code>template.pug</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>fichiers contenus dans le répertoire <code>src</code> et suffixés par <code>css</code>, peu importe leur emplacement dans l&#8217;arborescence.</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Certains modules sont bloquants</div>
<div class="paragraph">
<p>Certains modules de <em>globbing</em> sont bloquants, comme <code>globule@~0.2.0</code>.</p>
</div>
<div class="paragraph">
<p>Méfiez-vous donc de leur API séduisante car leur performance s&#8217;en trouvera amoindrie.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_injection_de_module">5.5. Injection de module</h3>
<div class="paragraph">
<p>Il est tentant de créer des modules pour abstraire certaines parties de votre logique applicative.
C&#8217;est d&#8217;autant plus pertinent si vous souhaitez partager ce code au sein d&#8217;un même projet ou entre plusieurs projets similaires.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre la volonté de déporter la configuration d&#8217;une hypothétique application dans un module nommé <code>app-configure.js</code> :</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const app = module.exports = new AppServer();

require('./app-configure.js');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce module de configuration requiert à son tour l&#8217;application pour en configurer l&#8217;objet exporté :</p>
</div>
<div class="listingblock">
<div class="title">app-configure.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const app = require('./app.js');
const ejsEngine = require('consolidate').ejs;

app.set('X-Powered-By', 'ACME Corp.');
app.set('view engine', ejsEngine);

// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette approche pose toutefois deux problèmes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;inclusion cyclique — même si Node s&#8217;en sortira, on pressent une erreur de <em>design</em> ;</p>
</li>
<li>
<p>quid de l&#8217;utilisation de ce module de configuration si l&#8217;on souhaite configurer un autre fichier que <code>app.js</code> ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;injection de variable est un <em>pattern</em> intéressant car il résout ce dilemme sans présenter d&#8217;inconvénient :</p>
</div>
<div class="listingblock">
<div class="title">app-reworked.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const app = new App();

require('./app-configure-reworked.js')(app);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le module de configuration devient alors une fonction recevant l&#8217;objet applicatif en paramètre :</p>
</div>
<div class="listingblock">
<div class="title">app-configure-reworked.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const ejsEngine = require('consolidate').ejs;

module.exports = function(app){
  app.set('X-Powered-By', 'ACME Corp.');
  app.set('view engine', ejsEngine);

  // ...
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce <em>pattern</em> est intéressant à plus d&#8217;un titre :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il rend explicite toute dépendance ;</p>
</li>
<li>
<p>le module d&#8217;injection peut baser son comportement sur l&#8217;état des objets passés en paramètre ;</p>
</li>
<li>
<p>il n&#8217;impose qu&#8217;une seule chose : respecter la signature de la fonction d&#8217;injection.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pattern-callback">5.6. Callback</h3>
<div class="paragraph">
<p>Le <em>pattern</em> <em>callback</em> est très couramment employé et pour cause : il est systématiquement employé dans les API asynchrones de Node. Par exemple, pour lire un fichier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');

fs.readFile('path/to/file', callback(err, fileContent) {
  if (err) { <i class="conum" data-value="1"></i><b>(1)</b>
    // ...
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>err</code> est généralement une instance de <code>Error</code>, sinon la variable est égale à <code>undefined</code> ou <code>null</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le <em>pattern</em> implique une fonction ayant un ou plusieurs arguments ; le premier d&#8217;entre eux étant par convention un objet d&#8217;erreur.<br>
Ce mécanisme permet de <strong>signaler une erreur</strong> ou un <strong>résultat</strong> de manière asynchrone.
Cependant on se rend vite compte que la simplicité du <em>pattern</em> cache une complexité dans la gestion des erreurs.
Comment les déclarer ?
Comment les intercepter ?
Comment les propager ailleurs dans notre application ?</p>
</div>
<div class="paragraph">
<p>Forçons le trait en créant une fonction asynchrone (<code>messageAbbr</code>) faisant appel à trois autres fonctions asynchrones (<code>uppercaseAsync</code>, <code>splitWordsAsync</code> et <code>abbreviateAsync</code>) :</p>
</div>
<div class="listingblock">
<div class="title">message-abbr/index.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const uppercaseAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    callback(null, message.toLocaleUpperCase ? message.toLocaleUpperCase() : message);
  });
}

const splitWordsAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    if (typeof message !== 'string'){
      return callback(new TypeError('message is not a String'));
    }

    return callback(null, message.split(' '));
  });
}

const abbreviateAsync = (words, callback) =&gt; {
  process.nextTick(() =&gt; {
    try {
      const abbr = words.reduce((abbr, word) =&gt; abbr + word[0], '');

      return callback(null, abbr);
    }
    catch (err){
      return callback(err);
    }
  });
}

const messageAbbr = (message, callback) =&gt; {
  uppercaseAsync(message, (err, message) =&gt; {
    if (err) {
      return callback(err);
    }

    splitWordsAsync(message, (err, words) =&gt; {
      if (err) {
        return callback(err);
      }

      abbreviateAsync(words, callback);
    });
  });
};

module.exports = messageAbbr;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plusieurs remarques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>process.nextTick</code> est utilisé pour déporter l&#8217;exécution du process principal vers l'<em>Event Loop</em> ;</p>
</li>
<li>
<p>chaque niveau de <em>callback</em> appellera la fonction de callback initiale avec l&#8217;objet d&#8217;erreur en premier argument ;</p>
</li>
<li>
<p>on constate que l&#8217;imbrication des fonctions rend difficilement contrôlable la possibilité d&#8217;interagir avant que l&#8217;intégralité de la chaîne soit accomplie.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant repose sur les fonctions précédemment listées de <code>message-abbr/index.js</code>.
La fonction <code>messageAbbr</code> est exécutée de trois manières différentes pour souligner plusieurs cas de figure :</p>
</div>
<div class="listingblock">
<div class="title">pattern/callback.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const messageAbbr = require('../message-abbr');

const printAbbr = (err, abbr) =&gt; err ? console.error(err) : console.log(abbr);

messageAbbr('good morning england!', printAbbr);        <i class="conum" data-value="1"></i><b>(1)</b>
messageAbbr(['good', 'morning', 'london!'], printAbbr); <i class="conum" data-value="2"></i><b>(2)</b>

setTimeout(() =&gt; {
  try {
    messageAbbr(null, printAbbr); <i class="conum" data-value="3"></i><b>(3)</b>
  }
  catch (e){
    console.error('null is not a string');
  }
}, 10);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>Premier appel</em> : affiche la chaîne <code>GME</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>Deuxième appel</em> : affiche le message d&#8217;erreur <code>[TypeError: message is not a String]</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>Troisième appel</em> : affiche une exception <code>TypeError: Cannot read property 'toLocaleUpperCase' of null</code> et termine le script de manière prématurée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le premier appel à <code>messageAbbr</code> se déroule dans des conditions optimales.
La fonction de callback transmet un premier paramètre <code>err</code> équivalent à <code>null</code> et une valeur conforme aux attentes.</p>
</div>
<div class="paragraph">
<p>Le deuxième appel illustre une interception maîtrisée d&#8217;un cas d&#8217;erreur.
C&#8217;est bien <code>console.error(err)</code> qui sera interprété suite à une erreur renvoyée par la fonction <code>splitWordsAsync</code>.</p>
</div>
<div class="paragraph">
<p>Le troisième et dernier appel interpelle : pourquoi le bloc <code>try/catch</code> est-il resté sans effet ?
Pour la simple et bonne raison que <code>try/catch</code> ne fonctionne que sur du <em>code synchrone</em>.<br>
L&#8217;exception n&#8217;étant pas interceptée par notre code, elle continue de remonter jusqu&#8217;au processus initial qui émet un événement <code>uncaughtException</code>, processus qui se terminera avec un code d&#8217;erreur si aucune fonction n&#8217;écoute ce dit événement <code>uncaughtException</code>.</p>
</div>
<div class="paragraph">
<p>Autrement dit, un code asynchrone basé sur des <em>callbacks</em> requiert beaucoup de précautions du fait du crash potentiel de l&#8217;application si une erreur n&#8217;est pas interceptée.</p>
</div>
<div class="paragraph">
<p>Enfin, on notera que l&#8217;ordre d&#8217;affichage des deux premiers appels n&#8217;est pas nécessairement le même que l&#8217;ordre d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Le code initial peut être rendu légèrement plus lisible sans toucher à l&#8217;API de callback en utilisant la méthode <code>waterfall</code> de la librairie <code>async</code> (<span class="URL"><a href="https://npmjs.com/async" class="bare">npmjs.com/async</a></span>) :</p>
</div>
<div class="listingblock">
<div class="title">message-abbr/waterfall.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const { waterfall } = require('async');

const uppercaseAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    callback(null, message.toLocaleUpperCase ? message.toLocaleUpperCase() : message);
  });
}

const splitWordsAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    if (typeof message !== 'string'){
      return callback(new TypeError('message is not a String'));
    }

    return callback(null, message.split(' '));
  });
}

const abbreviateAsync = (words, callback) =&gt; {
  process.nextTick(() =&gt; {
    try {
      const abbr = words.reduce((abbr, word) =&gt; abbr + word[0], '');

      return callback(null, abbr);
    }
    catch (err){
      return callback(err);
    }
  });
}

const messageAbbr = (message, callback) =&gt; {
  waterfall([
    (done) =&gt; done(null, message),
    uppercaseAsync,
    splitWordsAsync,
    abbreviateAsync
  ], callback);
};

module.exports = messageAbbr;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le mécanisme <code>waterfall</code> exécute chaque callback de manière séquentielle, en transmettant l&#8217;erreur et le résultat au callback suivant.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> Non-bloquant mais pas rapide pour autant</div>
<div class="paragraph">
<p>Vous aurez beau rendre non-bloquant la majorité de votre code, il n&#8217;en sera pas nécessairement exécuté plus rapidement.</p>
</div>
<div class="paragraph">
<p>Certes votre application pourra <em>accepter</em> davantage de sollicitation mais votre code, lui, ira à la vitesse induite par l&#8217;enchainement logique du flux de données.</p>
</div>
<div class="paragraph">
<p>Le temps d&#8217;exécution des callbacks correspond à la <em>somme du temps d&#8217;exécution de chaque callback</em>.<br>
Un excellent moyen pour gérer du code <em>asynchrone</em> et <em>parallèle</em> est le <em>pattern</em> <em>promesse</em>, abordé dans les pages suivantes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_event">5.7. Event</h3>
<div class="paragraph">
<p>Les <em>callbacks</em> nous permettent d&#8217;agir lorsqu&#8217;une exécution asynchrone est en mesure de nous retourner un résultat ou une erreur.<br>
Leur fonctionnement est toutefois encapsulé et limité à la portée de la portion de code dans laquelle nous pouvons insérer des instructions.
Difficile donc d&#8217;exposer notre logique applicative en dehors de ces <em>callbacks</em>.</p>
</div>
<div class="paragraph">
<p>Les événements nous offrent un tel mécanisme d&#8217;exposition, en permettant la connexion de plusieurs écouteurs (<em>listeners</em>).
Plusieurs composants indépendants peuvent alors utiliser les résultats pour leurs propres besoins.</p>
</div>
<div class="paragraph">
<p>Il s&#8217;agit d&#8217;un <em>pattern</em> particulièrement intéressant pour adresser ces besoins :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gérer des cas de figure ayant trait à une progression ;</p>
</li>
<li>
<p>gérer des cas de figure plus complexes qu&#8217;une logique binaire de réussite ou d&#8217;échec ;</p>
</li>
<li>
<p>séparer la logique d&#8217;exécution d&#8217;un résultat unique (éviter de mettre tous les <em>callbacks</em> dans le même panier dirait-on…);</p>
</li>
<li>
<p>transmettre des résultats au travers de plusieurs couches applicatives (un émetteur, plusieurs récepteurs).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple suivant, nous allons réutiliser la fonction <code>messageAbbr</code> développée dans la précédente section <em>callbacks</em>.
Cette fois-ci, nous allons exécuter des <em>opérations synchrones et asynchrones</em> en <em>callback</em> de la fonction <code>messageAbbr</code> :</p>
</div>
<div class="listingblock">
<div class="title">pattern/callback-naive.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const messageAbbr = require('../message-abbr');
const fs = require('fs');
const timeStart = process.hrtime();

const logErr = (err) =&gt; console.error(err);
const logData = (data) =&gt; console.log(data);

const logPerformance = (functionName, timeDiff) =&gt; {
  const duration = timeDiff[0] + (timeDiff[1] / 1e9);
  console.log('[%s] executed in %ss.', functionName, duration);
}

const storeData = (filename, data) =&gt; {
  fs.writeFile(filename, data, { encoding: 'utf-8' }, (err) =&gt; {
    if (err) {
      return logErr(err);
    }

    console.log('Data written to %s.', filename);
  });
}

messageAbbr('good morning england!', (err, abbr) =&gt; {
  if (err) {
    logErr(err);
  }

  logData(abbr);
  logPerformance('messageAbbr', process.hrtime(timeStart));
  storeData('/dev/null', abbr);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les fonctions <code>logData</code>, <code>logPerformance</code> et <code>storeData</code> sont exécutées en cas de succès du <em>callback</em> de <code>messageAbbr</code>.<br>
Mais que se passe-t-il si une de ces trois fonctions génère une erreur ? Et si l&#8217;une d&#8217;entre elles s&#8217;exécute de manière asynchrone ? Comment faire remonter l&#8217;erreur en dehors de <code>messageAbbr</code> ?</p>
</div>
<div class="paragraph">
<p>Retravaillons le précédent exemple pour explorer une approche événementielle :</p>
</div>
<div class="listingblock">
<div class="title">pattern/event.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const messageAbbr = require('../message-abbr/evented');
const { writeFile } = require('fs');
const timeStart = process.hrtime();

const logErr = (err) =&gt; console.error(err);
const logData = (data) =&gt; console.log(data);

const logPerformance = (functionName, timeDiff) =&gt; {
  const duration = timeDiff[0] + (timeDiff[1] / 1e9);
  console.log('[%s] executed in %ss.', functionName, duration);
}

const storeData = (filename, data) =&gt; {
  writeFile(filename, data, { encoding: 'utf-8' }, (err) =&gt; {
    if (err) {
      return logErr(err);
    }

    console.log('Data written to %s.', filename);
  });
}

const event = messageAbbr('good morning england!');

event.on('error', logErr);
event.on('data', logData);
event.on('data', (data) =&gt; storeData('/dev/null', data));
event.on('data', () =&gt; {
  logPerformance('messageAbbr', process.hrtime(timeStart));
});

module.exports = event; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>L&#8217;utilisation de <code>module.exports</code> permet d&#8217;exposer l&#8217;émetteur d&#8217;événement à d&#8217;autres modules, par exemple <code>require('./pattern/events').on('data', &#8230;&#8203;)</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La fonction <code>messageAbbr</code> retourne désormais une instance de l&#8217;objet <code>EventEmitter</code> de manière synchrone.
Des écouteurs sont branchés sur l&#8217;objet retourné et sont exécutés de manière asynchrone, lorsque leur événement respectif est émis.</p>
</div>
<div class="paragraph">
<p>Observons maintenant le code source modifié de <code>messageAbbr</code> ayant permis d&#8217;exposer cette interface événementielle :</p>
</div>
<div class="listingblock">
<div class="title">message-abbr/evented.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const waterfall = require('async').waterfall;
const EventEmitter = require('events').EventEmitter;

const uppercaseAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    callback(null, message.toLocaleUpperCase ? message.toLocaleUpperCase() : message);
  });
}

const splitWordsAsync = (message, callback) =&gt; {
  process.nextTick(() =&gt; {
    if (typeof message !== 'string'){
      return callback(new TypeError('message is not a String'));
    }

    return callback(null, message.split(' '));
  });
}

const abbreviateAsync = (words, callback) =&gt; {
  process.nextTick(() =&gt; {
    try {
      const abbr = words.reduce((abbr, word) =&gt; abbr + word[0], '');

      return callback(null, abbr);
    }
    catch (err){
      return callback(err);
    }
  });
}

const messageAbbr = (message) =&gt; {
  const emitter = new EventEmitter();

  waterfall([
    (done) =&gt; done(null, message),
    uppercaseAsync,
    splitWordsAsync,
    abbreviateAsync
  ], (err, abbr) =&gt; {
    if (err) {
      return emitter.emit('error', err);
    }

    emitter.emit('data', abbr);
  });

  return emitter;
};

module.exports = messageAbbr;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le seul changement se situe dans la fonction <code>messageAbbr</code> : elle retourne désormais un objet <code>EventEmitter</code>.
Cet objet est interfacé dans les moments critiques de la fonction <code>waterfall</code> et en relaie son cycle de vie <em>en dehors</em> de la fonction <code>messageAbbr</code>.<br>
À noter que le nommage des événements est libre.
Certains noms sont utilisés de manière conventionnelle pour identifier des actions – par exemple, <code>error</code>, <code>data</code>, <code>end</code> etc.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> <code>emitter.setMaxListeners</code></div>
<div class="paragraph">
<p>Vous pouvez brancher dix écouteurs maximum sur un émetteur.
C&#8217;est en général un nombre suffisant mais cette limite peut être augmentée (ou réduite) si le besoin se fait sentir.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const server = require('http').createServer();
server.setMaxListeners(20);
server.listen(4000);

server.on('request', (req, res) =&gt; {
  // ...
  res.writeHead(204, null);
  res.end();
});

if (process.env.NODE_ENV !== 'production') {
  server.on('request', req =&gt; console.log(req.headers));
}

server.on('error', err =&gt; {
  if (err) {
    // ...
  }
  // ...
});</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est important de bien connaître et de bien comprendre ce <em>pattern</em> car il est fréquemment employé au sein des API natives de Node et dans de nombreux modules npm.</p>
</div>
</div>
<div class="sect2">
<h3 id="pattern-promise">5.8. Promesses</h3>
<div class="paragraph">
<p>Le concept des promesses est extrêmement puissant pour gérer, ordonner et organiser un ou plusieurs enchaînements d&#8217;exécutions asynchrones.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs enjeux dans l&#8217;organisation du code liés aux promesses :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>intercepter les <strong>erreurs</strong> ;</p>
</li>
<li>
<p>intégrer du code <strong>à base de <em>callbacks</em></strong> ;</p>
</li>
<li>
<p><strong>intégrer du code</strong> qui n&#8217;est pas au courant d&#8217;être dans une promesse ;</p>
</li>
<li>
<p><strong>modulariser</strong> son code ;</p>
</li>
<li>
<p>profiter de la <strong>parallélisation</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le fichier <code>message-abbr/index.js</code> exporte une fonction asynchrone dont l&#8217;argument final est un <a href="#pattern-callback">callback</a>.
Une première approche pour utiliser cette fonction <em>comme une promesse</em> serait de l&#8217;encapsuler de la manière suivante :</p>
</div>
<div class="listingblock">
<div class="title">pattern/promise-callback.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const messageAbbrAsync = require('../message-abbr');

const messageAbbr = (text) =&gt; {
  return new Promise((resolve, reject) =&gt; {
    messageAbbrAsync(text, (err, abbr) =&gt; {
      if (err) {
        return reject(err);
      }

      resolve(abbr);
    })
  });
};

const logErr = (err) =&gt; console.error(err);
const logData = (data) =&gt; console.log(data);

messageAbbr('good morning Bordeaux!')
  .then(logData, logErr);  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est minimal mais on crée un code <em>fragile</em> : nous devons faire en sorte que les interfaces de l&#8217;encapsulation évoluent en simultané.
La réalité c&#8217;est que nous n&#8217;avons pas envie d&#8217;encapsuler toutes les fonctions asynchrones pour les intégrer dans des chaînes de promesses.</p>
</div>
<div class="paragraph">
<p>Pour cela, une librairie comme <code>bluebird</code> ou <code>pify</code> exposent une fonction pour transformer en promesse une fonction ou un module retournant un objet de fonctions.<br>
L&#8217;exemple précédent serait réécrit de la manière suivante :</p>
</div>
<div class="listingblock">
<div class="title">pattern/promise-promisified.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const pify = require('pify');
const messageAbbrAsync = require('../message-abbr');
const messageAbbr = pify(messageAbbrAsync);    <i class="conum" data-value="1"></i><b>(1)</b>

const logErr = (err) =&gt; console.error(err);
const logData = (data) =&gt; console.log(data);

messageAbbr('good morning Bordeaux!')
  .then(logData, logErr);  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est tout.</p>
</div>
<div class="paragraph">
<p>Explorons désormais une <strong>gestion robuste des erreurs</strong> : toute exception entraine la <em>résolution négative</em> de la promesse – même si on ne fait pas appel à la fonction <code>reject()</code>.
Il est possible de gérer les erreurs finement en ayant recourt à <code>.catch()</code>.</p>
</div>
<div class="listingblock">
<div class="title">pattern/promise-errors.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const pify = require('pify');
const messageAbbr = pify(require('../message-abbr'));

const logErr = (err) =&gt; console.error(err);
const logFinalErr = (err) =&gt; console.error('Erreur dans .catch() final', err);
const logData = (data) =&gt; console.log(data);

messageAbbr('good morning Bordeaux!')
  .then(logData)
  .catch(logErr)                                           <i class="conum" data-value="1"></i><b>(1)</b>
  .then(() =&gt; { throw Error('Erreur volontaire') }, logErr)<i class="conum" data-value="2"></i><b>(2)</b>
  .catch(logFinalErr);                                     <i class="conum" data-value="3"></i><b>(3)</b>

  messageAbbr(null)
    .then(logData, logErr);     <i class="conum" data-value="4"></i><b>(4)</b>

  messageAbbr(null)
    .then(logData);             <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ce <code>.catch()</code> se déclenchera si <code>messageAbbr()</code> ou <code>logData()</code> génèrent une exception ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Génère une exception — elle ne sera pas interceptée par la fonction <code>logErr()</code> située sur la même ligne ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ce <code>.catch()</code> affichera l&#8217;erreur générée à l&#8217;élément <em>précédent</em> dans la chaîne de promesses ;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>La fonction <code>messageAbbr()</code> génère une exception, gérée par l&#8217;élément <em>suivant</em> dans la chaîne de promesses ;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>La fonction <code>messageAbbr()</code> génère une exception, qui n&#8217;est pas interceptée – Node affiche un <em>warning</em> dans la <em>sortie erreur</em> : <code>UnhandledPromiseRejectionWarning: Unhandled promise rejection</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce dernier cas de figure illustre une des limitations des promesses : c&#8217;est à nous de faire attention à intercepter les erreurs.
Celles-ci ne seront pas toutes remontées si un <code>.catch()</code> final n&#8217;est pas ajouté à la chaîne de promesses.<br>
Node affichera un message d&#8217;erreur avec une trace incomplète.</p>
</div>
<div class="paragraph">
<p><code>Promise.all()</code> nous permet d&#8217;exécuter une fonction lorsque <em>toutes</em> les promesses sont résolues.
Détail important cependant, <em>toutes</em> les promesses passées en argument de <code>Promise.all()</code> sont exécutées en <strong>parallèle</strong> :</p>
</div>
<div class="listingblock">
<div class="title">pattern/promise-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const pify = require('pify');
const messageAbbr = pify(require('../message-abbr'));

Promise.all([
  messageAbbr('Hennes &amp; Mauritz'),
  messageAbbr('Her Majesty\'s ship'),
  messageAbbr('gentil organisateur')
]).then((abbreviations) =&gt; console.log(abbreviations)); <i class="conum" data-value="2"></i><b>(2)</b>

console.log('Promesse tenue !'); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>Promesse tenue !</code> en premier ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Puis affiche <code>[ 'H&amp;M', 'HMS', 'GO' ]</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cette technique est plus rapide qu&#8217;un enchainement de promesses du fait de leur <em>exécution en parallèle</em>.
Le temps d&#8217;exécution total correspond à celui de la promesse la plus lente.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Librairies de promesses</div>
<div class="paragraph">
<p>Des librairies de promesses ajoutent des sucres syntaxiques pour faciliter la manipulation des promesses :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/pify" class="bare">npmjs.com/pify</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/bluebird" class="bare">npmjs.com/bluebird</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/when" class="bare">npmjs.com/when</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/es6-promise" class="bare">npmjs.com/es6-promise</a></span> (un polyfill pour d&#8217;anciennes versions de Node et des navigateurs Web peu récents)</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="streams">5.9. Streams</h3>
<div class="paragraph">
<p>Les <em>streams</em> représentent un concept déjà connu par les pratiquants du monde UNIX.
Nous avons déjà vu dans cette section qu&#8217;une opération asynchrone ne bloque pas le reste de l&#8217;exécution du programme.
Mais les <em>patterns</em> précédents n&#8217;adressent pas la problématique de mémoire.</p>
</div>
<div class="paragraph">
<p>Prenons un exemple courant : télécharger un fichier distant et le stocker sur disque.</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">streams-http-async.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const {request} = require('https');
const fs = require('fs');

const BASE_URL = 'https://raw.githubusercontent.com';
const url = `${BASE_URL}/oncletom/nodebook/master/package.json`;

const req = request(url, (res) =&gt; {
  let body = '';

  res.on('error', err =&gt; console.error(err));
  res.on('data', data =&gt; body += data);
  res.on('end', () =&gt; {
    fs.writeFile('/tmp/nodebook.json', body, (err) =&gt; {
      if (err){
        return console.error(err);
      }

      console.log('Fichier archivé !');
    });
  });
});

req.end();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Que se passe-t-il dans le précédent exemple ?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>une requête est envoyée ;</p>
</li>
<li>
<p>la réponse arrive morceau par morceau et s&#8217;accumule en mémoire ;</p>
</li>
<li>
<p>ce <em>callback</em> est exécuté lorsque la lecture de données est épuisée ;</p>
</li>
<li>
<p>les données sont écrites en un bloc sur le système de fichier local.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ça fonctionne, c&#8217;est non-bloquant mais il y a deux possibles inconvénients :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>on exécute les actions de téléchargement et d&#8217;écriture de manière séquentielle ; on accumule le temps d&#8217;attente de chaque <em>callback</em> ;</p>
</li>
<li>
<p>l&#8217;intégralité des données doit être stockée en mémoire.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les <em>streams</em> servent très précisément à résoudre ces inconvénients.
Rectifions notre précédent exemple :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">streams-http.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const {request} = require('https');
const fs = require('fs');

const BASE_URL = 'https://raw.githubusercontent.com';
const url = `${BASE_URL}/oncletom/nodebook/master/package.json`;

const req = request(url, (res) =&gt; {
  res
    .pipe(fs.createWriteStream('/tmp/nodebook.json'))
    .on('finish', () =&gt; console.log('Fichier archivé !'));
});

req.end();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Que se passe-t-il dans cet exemple ?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>la requête passe un objet de type <em>IncomingMessage</em> et qui se trouve implémenter un <em>ReadableStream</em> ;</p>
</li>
<li>
<p><code>fs.createWriteStream</code> retourne un <em>WriteableStream</em> ;</p>
</li>
<li>
<p>la méthode <code>pipe()</code> déverse les données dans le <em>WritableStream</em> ;</p>
</li>
<li>
<p>le <em>WritableStream</em> écrit sur disque au fur et à mesure de la réception des données du <em>ReadableStream</em> ;</p>
</li>
<li>
<p>le <em>ReadableStream</em> termine la connexion en émettant un évènement <em>finish</em> lorsqu&#8217;il n&#8217;y a plus de données à lire.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">API</span> Les types de <em>streams</em></div>
<div class="paragraph">
<p>Node met à disposition plusieurs types de <em>streams</em>, chacun ayant sa propre vocation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>ReadableStream</em> : données en lecture seule ;</p>
</li>
<li>
<p><em>WriteableStream</em> : données en écriture seule ;</p>
</li>
<li>
<p><em>DuplexStream</em> : données en lecture et écriture (connexion bi-directionnelle, opérations asymétriques etc.) ;</p>
</li>
<li>
<p><em>TransformStream</em> : données en lecture, modifiées et émises en écriture (filtres de compression, parsing etc.) ;</p>
</li>
<li>
<p><em>PassThroughStream</em> : données en lecture émises à l&#8217;identique en écriture (<em>logging</em>, débogage etc.).</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les <em>streams</em> sont efficaces pour transférer et modifier des données de manière constante et maitrisée, le tout avec une faible empreinte mémoire.</p>
</div>
<div class="paragraph">
<p>Les opérations asynchrones à base de <em>callbacks</em> allouent autant de mémoire que nécessaire de manière fluctuante tandis que les <em>streams</em> ne consommeront que quelques kilo-octets de manière constante.</p>
</div>
<div class="paragraph">
<p>C&#8217;est là où réside la promesse de Node : des opérations non-bloquantes et à faible empreinte mémoire.
Il s&#8217;agit d&#8217;une combinaison gagnante si ces traitements sont multipliés et rendus simultanés en cas d&#8217;accès concurrents à l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Dix accès concurrents ouvrant un fichier de 10 méga-octets nécessitera au bas mot 100 méga-octets de mémoire disponible.<br>
Les mêmes dix accès concurrents ouvrant ce fichier en <em>streaming</em> nécessitera tout au plus une cinquantaine de kilo-octets de mémoire disponible.</p>
</div>
<div class="paragraph">
<p>Continuons sur notre lancée et intéressons-nous à la manipulation d&#8217;un fichier JSON.
Nous souhaitons le lire, le parser et en afficher le contenu avant de pouvoir procéder à d&#8217;autres opérations de tri ou de filtre.</p>
</div>
<div class="paragraph">
<p>Voilà comment nous procéderions avec une approche classique non-bloquante :</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams-async.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const dataDir = join(__dirname, '..', '..');
const filename = join(dataDir, 'package.json');

fs.readFile(filename, (err, binaryContent) =&gt; {
  if (err) {
    return console.error(err);
  }

  const jsonContent = JSON.parse(String(binaryContent));

  console.log(jsonContent.dependencies);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est certes non-bloquant mais nous faisons face à un problème de performance lié à la montée en charge, en relation avec la taille du fichier à charger et à parser :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JSON.parse</code> doit charger l&#8217;intégralité du fichier JSON en mémoire ;</p>
</li>
<li>
<p><code>JSON.parse</code> ne faisant pas de parsing progressif, il faudra attendre que l&#8217;intégralité du fichier soit parsé pour commencer en à manipuler le résultat.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est peut-être acceptable dans le cas d&#8217;un simple utilitaire exécuté ponctuellement mais ce sera clairement problématique pour la montée en charge d&#8217;une application soumise à des accès concurrents : il faudra en effet multiplier la quantité de mémoire allouée par fichier par le nombre d&#8217;accès simultanés au service.</p>
</div>
<div class="paragraph">
<p>En clair, ce modèle ne fonctionnera pas si vous exposez des archives de fichiers ou même plus simplement, si vous proposez des fonctions d&#8217;export requétant et renvoyant des résultats de base de données.</p>
</div>
<div class="paragraph">
<p>Sur la base de notre premier essai avec les <em>streams</em>, transformons donc la lecture ponctuelle en lecture progressive :</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const dataDir = join(__dirname, '..', '..');
const filename = join(dataDir, 'package.json');

fs.createReadStream(filename)
  .on('data', (chunk) =&gt; {
    const jsonContent = JSON.parse(String(chunk));

    console.log(jsonContent.dependencies);
  })
  .on('error', (err) =&gt; console.error(err));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Que se passe-t-il lors de l&#8217;exécution de la méthode <code>createReadStream</code> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Node retourne une instance d&#8217;objet <code>ReadableStream</code> de manière synchrone ;</p>
</li>
<li>
<p>vous configurez l&#8217;instance de <code>ReadableStream</code> pour choisir votre méthode de consommation de données ;</p>
</li>
<li>
<p>l&#8217;instance de <code>ReadableStream</code> émet des événements relatifs à sa progression ;</p>
</li>
<li>
<p>la consommation des données s&#8217;arrête lorsque vous le décidez ou lorsque l&#8217;instance de <code>ReadableStream</code> émet l&#8217;événement <code>end</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Recyclons notre précédent exemple avec un fichier JSON plus volumineux.
Le fichier en question est issu de la <em>ressourcerie Datalocale</em> (<span class="URL"><a href="https://www.datalocale.fr/drupal7/dataset/catalogue-datalocale" class="bare">www.datalocale.fr/drupal7/dataset/catalogue-datalocale</a></span>), en date du 19 mars 2014 :</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams-large.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const dataDir = join(__dirname, '..', '..', 'data');
const filename = join(dataDir, 'datalocale-20140320-daily.json');

fs.createReadStream(filename)
  .on('data', (chunk) =&gt; {
    const jsonContent = JSON.parse(String(chunk)); <i class="conum" data-value="1"></i><b>(1)</b>

    console.log(jsonContent);
  })
  .on('error', err =&gt; console.error(err));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Jette une exception <code>SyntaxError: Unexpected end of input</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En quoi le simple changement de la source de données peut-il affecter notre script, qui fonctionnait parfaitement dans notre exemple précédent ?</p>
</div>
<div class="paragraph">
<p>Le mécanisme des <em>streams</em> est ici mis en évidence par le volume de données contenus dans le fichier JSON (un peu plus d&#8217;un méga-octet) : seule une dizaine d&#8217;éléments ont été retournés ; le dernier étant même partiellement tronqué.</p>
</div>
<div class="paragraph">
<p>En pratique, chaque <em>buffer</em> correspond plus ou moins à 4Ko de données… mais 4Ko de données brutes.<br>
La fonction <code>JSON.parse</code> devient alors inefficace car elle impose d&#8217;avoir à disposition une structure JSON finie et complète.</p>
</div>
<div class="paragraph">
<p>Il nous faudrait un parseur JSON compatible avec les <em>streams</em> ; c&#8217;est à dire qui soit capable de parser une structure JSON au fur et à mesure de sa lecture.<br>
C&#8217;est exactement ce que nous propose le module npm <code>JSONStream</code> (<span class="URL"><a href="https://npmjs.com/JSONStream" class="bare">npmjs.com/JSONStream</a></span>).</p>
</div>
<div class="paragraph">
<p>Notre script se transforme légèrement et nécessite l&#8217;emploi de la méthode <code>pipe()</code> sur laquelle nous nous pencherons juste après :</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams-jsonstream.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const JSONStream = require('JSONStream');
const dataDir = join(__dirname, '..', '..', 'data');
const filename = join(dataDir, 'datalocale-20140320-daily.json');
let count = 0;

fs.createReadStream(filename)
  .pipe(JSONStream.parse('*'))
  .on('data', () =&gt; count++)
  .on('end', () =&gt; console.log(count)) <i class="conum" data-value="1"></i><b>(1)</b>
  .on('error', (err) =&gt; console.error(err));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Affiche <code>208</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La fonction <code>JSONStream.parse()</code> retourne en réalité un nouveau <em>stream</em> qui lit les données émises par <code>fs.createReadStream</code>.<br>
Ce nouveau <em>stream</em> a été configuré pour retourner chaque élément (<code>*</code>) du tableau JSON.<br>
Si nous avions voulu ne retourner que la propriété <code>resources</code> de chaque élément, nous aurions alors écrit <code>JSONStream.parse('*.resources')</code>.</p>
</div>
<div class="paragraph">
<p>Le mécanisme de <code>pipe</code> permet de transvaser un flux de données d&#8217;un <em>stream</em> vers un autre.
Ce comportement est littéralement le même que l&#8217;opérateur <code>|</code> dans le monde UNIX :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat /etc/networks | head -n3 | grep -i 'database'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cet exemple précédent pourrait être écrit de la manière suivante avec Node (les modules npm sont fictifs et servent uniquement à illustrer le propos) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const head = require('head');
const grep = require('stream-grep');
const fs = require('fs');

fs.createReadStream('/etc/networks')
  .pipe(head({ count: 3 }))
  .pipe(grep(/database/i))
  .pipe(process.stdout);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette manipulation équivaut à une transmission de pointeur de données.
Autrement dit, vous pouvez router un <em>stream</em> vers plusieurs autres <em>streams</em> sans pénaliser les ressources système !</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams-multipipes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const JSONStream = require('JSONStream');
const dataDir = join(__dirname, '..', '..', 'data');
const filename = join(dataDir, 'datalocale-20140320-daily.json');

const readStream = fs.createReadStream(filename);
const resourcesStream = JSONStream.parse('*.resources');

readStream
  .pipe(resourcesStream)
  .on('data', resource =&gt; console.log(resource));

readStream
  .pipe(fs.createWriteStream('/tmp/datalocale-daily-backup.json'));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tout comme dans notre exemple précédent <code>pattern/streams-jsonstream.js</code>, nous avons recours à l&#8217;évènement <code>data</code>.
Le module <em>JSONStream</em> met temporairement en mémoire la structure de données parsée avant de l&#8217;émettre.</p>
</div>
<div class="paragraph">
<p>Mais cela empêche de <em>piper</em> à nouveau.
Pour ce faire, il faut reconstituer un <em>stream</em>… tâche ardue mais simplifiée grâce au module <em>event-stream</em> et à ses méthodes <code>map</code> et <code>mapSync</code>.<br>
Elles créent un nouveau <em>stream</em> et écrivent dedans à chaque émission de l&#8217;évènement <em>data</em> du <em>stream</em> précédent.</p>
</div>
<div class="paragraph">
<p>On peut ainsi diriger notre <em>stream</em> principal vers un fichier sur disque, mais aussi vers le parseur JSON qui lui aussi est dirigé vers le disque et la sortie standard :</p>
</div>
<div class="listingblock">
<div class="title">pattern/streams-multipipes-es.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">'use strict';

const fs = require('fs');
const { join } = require('path');
const JSONStream = require('JSONStream');
const es = require('event-stream');
const dataDir = join(__dirname, '..', '..', 'data');
const filename = join(dataDir, 'datalocale-20140320-daily.json');

const readStream = fs.createReadStream(filename);
const resourcesStream = readStream
  .pipe(JSONStream.parse('*.resources.*'))
  .pipe(es.map((resource, next) =&gt; {
    next(null, JSON.stringify(resource));
  }));

readStream
  .pipe(fs.createWriteStream('/tmp/datalocale-daily-backup.json'));

resourcesStream
  .pipe(fs.createWriteStream('/tmp/datalocale-resources.json'));

resourcesStream.pipe(process.stdout);</code></pre>
</div>
</div>
<div class="paragraph">
<p>De nombreuses API Node exposent des <em>streams</em> : requête HTTP, serveur HTTP, lecture et écriture de fichier, cryptographie, entrée/sortie standard du processus etc.</p>
</div>
<div class="paragraph">
<p>Pour être explicite : toute API vous permettra à un moment ou à un autre de manipuler des ensembles de données dont vous ne maitrisez pas la taille sans affecter les performances du système.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bien_utiliser_npm_au_quotidien">6. Bien utiliser npm au quotidien</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons évoqué la notion de <em>modules</em> dans les pages précédentes.
Il est temps de plonger plus en détails dans le sujet pour mieux comprendre une des pierres angulaires de Node.</p>
</div>
<div class="paragraph">
<p>Lorsque la fonction globale <code>require</code> est invoquée, plusieurs scénarios de chargement peuvent se dérouler, en fonction de la syntaxe employée :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un fichier local en utilisant un chemin relatif (<code>require('./mon-fichier.js')</code>) ;</p>
</li>
<li>
<p>un module Node (<code>require('comma-separated-values')</code>) ;</p>
</li>
<li>
<p>un module Node natif (par exemple, <code>require('fs')</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;objectif de Node est de fournir des modules natifs de bas niveau, stables et robustes.
Le reste est pris en charge par la communauté.
Et c&#8217;est de la communauté dont émergent les modules et les <em>patterns</em> utiles et efficaces.</p>
</div>
<div class="sect2">
<h3 id="_npm">6.1. npm</h3>
<div class="paragraph">
<p>Cette communauté a créé, conçu et contribue à alimenter le registre <code>npm</code> pour faciliter la distribution, l&#8217;installation et la mise à jour des modules.
C&#8217;est de loin le mécanisme privilégié pour installer des modules Node de la manière la plus simple qu&#8217;il soit.</p>
</div>
<div class="paragraph">
<p>Si vous avez installé Node depuis les binaires officiels, <code>npm</code> est inclus par défaut.
Véfifions que le programme <code>npm</code> est installé sur notre machine :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm --version
4.1.1</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initialiser_un_projet_node">6.2. Initialiser un projet Node</h3>
<div class="paragraph">
<p>La pierre angulaire d&#8217;un projet Node est le fichier <code>package.json</code>.
Il décrit les composants essentiels du projet.
Il se situe à la racine de chaque projet et contient plusieurs catégories d&#8217;informations :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>textuels</strong> : titre, descriptions, liens et licence ;</p>
</li>
<li>
<p><strong>version</strong> : une chaîne respectant le fonctionnement de <em>node-semver</em> (<span class="URL"><a href="https://github.com/npm/node-semver" class="bare">github.com/npm/node-semver</a></span>) ;</p>
</li>
<li>
<p><strong>dépendances</strong> : emplacement du module principal et liste explicite de modules nécessaires au bon fonctionnement du projet ;</p>
</li>
<li>
<p><strong>actions</strong> : commandes à exécuter lors des différentes étapes du cycle de vie du projet ;</p>
</li>
<li>
<p><strong>divers</strong> : données de configuration ou utilisées par des modules Node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de la commande <code>npm init</code> est une bonne habitude à prendre pour débuter tout projet Node.
À l&#8217;issue de la série de questions, le fichier <code>package.json</code> sera créé dans le répertoire courant.
Ensuite libre à vous de le compléter avec d&#8217;autres éléments optionnels de configuration.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/npm-init.png" alt="npm init" width="85%">
</div>
<div class="title">Figure 3. Exemple de questions posées lors de la séquence <code>npm init</code></div>
</div>
<div class="paragraph">
<p>On peut gagner du temps en utilisant l&#8217;option <code>--yes</code> (et son raccourci <code>-y</code>) pour créer le fichier <code>package.json</code> sans avoir à répondre aux questions :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm init -y</pre>
</div>
</div>
<div class="paragraph">
<p>Que votre projet soit public ou non, il est important de renseigner les champs décrits ci-après.
Ils indiqueront aux utilisateurs les intentions du projet ainsi que l&#8217;emplacement des ressources pour en savoir davantage à son propos ou tout simplement, pour y contribuer.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Commande</span> <code>npm help json</code></div>
<div class="paragraph">
<p>Le détail de chaque clé de configuration est expliqué <em>via</em> cette commande.
Des exemples vous permettront également de mieux comprendre leur utilité.</p>
</div>
<div class="paragraph">
<p>Cette même documentation est disponible en ligne, en anglais :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://docs.npmjs.com/files/package.json" class="bare">docs.npmjs.com/files/package.json</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>name</strong> : il s&#8217;agit de l&#8217;identifiant du module lorsqu&#8217;il est chargé via la fonction <code>require()</code>. Ce sera également l&#8217;identifiant npm si vous publiez ce module dans un registre public ou privé. Par exemple, si la propriété <strong>name</strong> vaut <em>nodebook</em>, le module se chargera via <code>require('nodebook')</code> et s&#8217;installera avec la commande <code>npm install nodebook</code> ;</p>
</li>
<li>
<p><strong>description</strong> : une indication textuelle des objectifs et fonctionnalités du module, écrite généralement en anglais ;</p>
</li>
<li>
<p><strong>version</strong> : chaîne respectant la sémantique <em>semver</em> — par exemple <code>1.0.0</code>. Nous verrons un peu plus loin dans ce chapitre comment utiliser intelligemment cette valeur pour assurer des mises à jour tout en préservant la compatibilité descendante au sein des projets dépendants de ce module ;</p>
</li>
<li>
<p><strong>main</strong> : emplacement du fichier Node chargé par défaut lors d&#8217;un appel à <code>require(&lt;name&gt;)</code>. S&#8217;il n&#8217;est pas spécifié, Node tentera de charger par défaut le fichier <code>index.js</code> ;</p>
</li>
<li>
<p><strong>repository</strong> : objet spécifiant le type de dépôt de code ainsi que son URL. Présent essentiellement à titre informatif ;</p>
</li>
<li>
<p><strong>preferGlobal</strong> : booléen indiquant si ce module a davantage vocation à être installé globalement au niveau du système ou non (<code>false</code> par défaut) ;</p>
</li>
<li>
<p><strong>bin</strong> : emplacement du fichier. npm effectue un lien symbolique pour rendre <code>&lt;name&gt;</code> disponible en tant qu&#8217;exécutable système lors d&#8217;une installation globale ;</p>
</li>
<li>
<p><strong>private</strong> : booléen spécifiant que le module ne doit pas être publié dans un registre npm (<code>false</code> par défaut) ;</p>
</li>
<li>
<p><strong>dependencies</strong> : objet représentant respectivement en clé/valeur les noms/versions des modules dont le projet dépend ;</p>
</li>
<li>
<p><strong>engines</strong> : objet spécifiant des contraintes de compatibilité avec la version de Node — cette valeur est exprimée selon la notation <a href="../chapter-01/index.html#semver"><em>semver</em></a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_installer_une_application_node">6.3. Installer une application Node</h3>
<div class="paragraph">
<p>TBD.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installer_un_module_em_npm_em">6.4. Installer un module <em>npm</em></h3>
<div class="paragraph">
<p>Revenons à notre exemple précédent.
Nous voulons un module Node permettant de parser et d&#8217;itérer facilement sur un fichier CSV sans avoir à nous soucier des cas limites.</p>
</div>
<div class="paragraph">
<p>Après quelques recherches, il se trouve que le module <code>comma-separated-values</code> est un bon candidat pour améliorer notre précédent script.
La documentation et les informations relatives à son utilisation sont accessibles sur <span class="URL"><a href="https://npmjs.com/comma-separated-values" class="bare">npmjs.com/comma-separated-values</a></span>.</p>
</div>
<div class="paragraph">
<p>Après avoir préalablement navigué dans le répertoire <code>chapitre-02/examples</code>, l&#8217;installation du module se déroule en invoquant la commande <code>npm install</code> de la manière suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm install comma-separated-values</pre>
</div>
</div>
<div class="paragraph">
<p>Le module est désormais installé dans le répertoire <code>chapitre-02/examples/node_modules/comma-separated-values</code> et est disponible pour tout script invoqué dans le répertoire <code>chapitre-02/examples</code>.</p>
</div>
<div class="paragraph">
<p>Lire un fichier CSV et en afficher son contenu devient aussi simple que le script suivant :</p>
</div>
<div class="listingblock">
<div class="title">print-csv-reloaded.js</div>
<div class="content">
<pre>'use strict';

const fs = require('fs');
const {join} = require('path');
const csv = require('comma-separated-values'); <i class="conum" data-value="1"></i><b>(1)</b>
const FILENAME = join(__dirname, '..', 'data', 'books.csv');

fs.readFile(FILENAME, (err, binaryContent) =&gt; {
  if (err) {
    return console.error(err);
  }

  const csvFile = new csv(String(binaryContent), {
    header: true,
    delimiter: ';',
  }); <i class="conum" data-value="2"></i><b>(2)</b>

  console.log(csvFile.parse()); <i class="conum" data-value="3"></i><b>(3)</b>
});</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>importe le module <code>comma-separated-values</code> dans la variable <code>csv</code> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>configure un nouvel objet <em>CSV</em> ;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>décode le contenu initial et affiche la structure JavaScript appropriée.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est toutefois recommandé d&#8217;installer les modules localement, afin de limiter leur portée uniquement au projet tout en maintenant une dépendance explicite et gérable via le fichier <em>package.json</em>.</p>
</div>
<div class="paragraph">
<p>Déroulons ensemble l&#8217;algorithme d&#8217;installation de <code>npm install</code> par le biais de cet exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm install --save async yargs</pre>
</div>
</div>
<div class="paragraph">
<p>La commande précédente effectue plusieurs opérations :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>requête du registre <em>npmjs.com</em> à propos des deux modules <em>async</em> et <em>yargs</em> ;</p>
</li>
<li>
<p>si les modules existent, la version compatible la plus récente est retournée (équivalent à <code>npm view async version</code> et <code>npm view yargs version</code> — respectivement <code>2.1.4</code> et <code>6.6.0</code>) ;</p>
</li>
<li>
<p>téléchargement et décompression des paquets dans les répertoire <code>node_modules/async</code> et <code>node_modules/yargs</code> ;</p>
</li>
<li>
<p>introspection récursive des dépendances de ces modules et si besoin est, téléchargement et décompression dans leur répertoire <em>node_modules</em> respectif (ici <code>node_modules/async/node_modules</code> et <code>node_modules/yargs/node_modules</code>) ;</p>
</li>
<li>
<p>inscription de <em>async</em> et de <em>yargs</em> dans la configuration <em>dependencies</em> de notre fichier <code>package.json</code>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/npm-install-save.png" alt="npm install save" width="85%">
</div>
<div class="title">Figure 4. Exemple de résultat de la commande <code>npm install</code></div>
</div>
<div class="paragraph">
<p>La commande npm prend soin de télécharger et de persister les dépendances, à la fois dans le répertoire <em>node_modules</em> et dans le fichier <em>package.json</em>.
Ce dernier contient désormais une section <em>dependencies</em> :</p>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
  ...
  "dependencies": {
    "async": "^2.1.4",
    "yargs": "^6.6.0"
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Aide</span> Plusieurs types de dépendances</div>
<div class="paragraph">
<p>Il existe plusieurs types de dépendances, chacune ayant sa propre utilité :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>dependencies</strong> : dépendances utiles à un fonctionnement en production ;</p>
</li>
<li>
<p><strong>devDependencies</strong> : dépendances utiles uniquement dans le cadre du développement, par exemple pour exécuter des tests ou s&#8217;assurer de la qualité du code ou encore empaqueter le projet ;</p>
</li>
<li>
<p><strong>optionalDependencies</strong> : dépendances dont l&#8217;installation ne sera pas nécessairement satisfaite, notamment pour des raisons de compatibilité. En général votre code prévoira que le chargement de ces modules via <code>require()</code> pourra échouer en prévoyant le traitement des exceptions avec un <code>try {} catch ()</code> ;</p>
</li>
<li>
<p><strong>peerDependencies</strong> : modules dont l&#8217;installation vous est recommandée ; pratique couramment employée dans le cas de <em>plugins</em>.<br>
Par exemple, si votre projet <code>A</code> installe <code>gulp-webserver</code> en <code>devDependencies</code> et que <code>gulp-webserver</code> déclare <code>gulp</code> en <code>peerDependencies</code>, npm vous recommandera d&#8217;installer également <code>gulp</code> en tant que <code>devDependencies</code> de votre projet <code>A</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les modules installés sont désormais manipulables via la fonction <code>require</code> au sein de notre code :</p>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const async = require('async');
const { argv } = require('yargs');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous savons installer et sauvegarder des dépendances par le biais du fichier <code>package.json</code>, sauvegardons l&#8217;état actuel du projet avec un gestionnaire de versions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_comprendre_em_npm_em_et_son_organisation_du_répertoire_em_node_modules_em">6.5. Comprendre <em>npm</em> et son organisation du répertoire <em>node_modules</em></h3>
<div class="paragraph">
<p><em>npm</em> organise les dépendances selon une structure dite <em>plate</em> (<em>flat tree structure</em>).
Ainsi, si deux modules distincts se basent sur une <strong>version compatible d&#8217;une même dépendance</strong> selon <em>semver</em> — ici, jQuery v2 —  voici l&#8217;arbre de dépendance de <em>npm</em> et la disposition sur le système de fichiers qui en résultent :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm ls
my-app@1.0.0
├── module-a@1.0.0
|   └── jquery@2.1.0
└── module-b@1.0.0
    └── jquery@2.1.4

$ tree node_modules
node_modules
├── jquery
├── module-a
└── module-b</pre>
</div>
</div>
<div class="paragraph">
<p>Dans le cas où plusieurs modules dépendant d&#8217;un même paquet mais dans une version <em>semver</em> incompatible — ici jQuery v1 et jQuery v2 — la version la plus <em>ancienne</em> se trouvera à la racine du répertoire <em>node_modules</em> tandis que les autres seront <em>encapsulées</em> au plus près du module en dépendant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm ls
my-app@1.0.0
├── module-a@1.0.0
|   └── jquery@1.11.3
└── module-b@1.0.0
    └── jquery@2.1.4

$ tree node_modules
node_modules
├── jquery
├── module-a
└── module-b
    └── jquery</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>npm dedupe</code> peut être un ultime recours pour optimiser un arbre plus complexe que celui-ci.
Ceci dans l&#8217;optique de diminuer les inclusions multiples d&#8217;une librairie techniquement compatible avec d&#8217;autres versions mineures.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Résolution de chemins</div>
<div class="paragraph">
<p>Il est fortement <strong>déconseillé de se baser sur des chemins en dur</strong> tapant dans le répertoire <em>node_modules</em>.
Il est <strong>préférable de faire appel à <code>require.resolve</code></strong> pour déterminer le chemin vers un fichier compris dans une dépendance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// À ne surtout pas faire
const jqueryCore = require('./node_modules/jquery/src/core.js');

// À faire
const jQueryCore = require('jquery/src/core.js');</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_trouver_son_bonheur_dans_le_em_registre_npm_em">6.6. Trouver son bonheur dans le <em>registre npm</em></h3>
<div class="paragraph">
<p>Le <em>registre npm</em> (<span class="URL"><a href="https://npmjs.com" class="bare">npmjs.com</a></span>) fourmille de modules en tous genres.
Ils fournissent de simples fonctions, des librairies ou des <em>frameworks</em> complets pour gérer vos accès réseau, vos bases de données, la qualité de vos projets et leur automatisation.</p>
</div>
<div class="paragraph">
<p>La <strong>sélection d&#8217;un module est un choix subjectif</strong> : la qualité, la pertinence et la popularité sont corrélées sans pour autant être des critères impératifs.<br>
Un module peu populaire sera-t-il moins bon pour autant ? Un module populaire est-il plus performant qu&#8217;une alternative ? Un module bien testé sera-t-il plus aisé à utiliser ?</p>
</div>
<div class="paragraph">
<p>Bref, pour vous aider à choisir — et ce peu importe le contexte — voici une liste subjective de critères et leur impact sur votre processus de décision :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>documentation</strong> : un fichier <em>README</em> décrivant l&#8217;API ou une <strong>documentation technique illustrée d&#8217;exemples</strong> sont des exemples d&#8217;objectif de qualité aidant tant à l&#8217;utilisation qu&#8217;à la contribution du-dit module ;</p>
</li>
<li>
<p><strong>badge d&#8217;intégration continue</strong> : la présence de tests est indispensable pour assurer une certaine qualité. Le badge d&#8217;intégration continue est un mécanisme supplémentaire pour démontrer l'<strong>existence de tests</strong> et leur <strong>automatisation</strong> lors de toute contribution de code ;</p>
</li>
<li>
<p><strong>dépendances</strong> : l&#8217;existence de modules reposant sur un autre démontre une <strong>marque de confiance</strong> d&#8217;autres développeurs. Confiance suffisante dans la solidité des fondations sur lesquelles ils s&#8217;appuient pour bâtir leur propre module ;</p>
</li>
<li>
<p><strong>date de mise à jour</strong> : une ou plusieurs versions majeures de Node sont-elles sorties entre temps ? Si oui, des <strong>risques d&#8217;incompatibilité</strong> peuvent se présenter. Certaines dépendances peuvent également être devenues obsolètes ou avoir présenté des failles de sécurité ;</p>
</li>
<li>
<p><strong>maintenance</strong> : si personne ne met à jour le module alors que des contributions se présentent, cela peut se révéler bloquant, dénoter une <strong>obsolescence</strong> d&#8217;idée ou impliquer l&#8217;existence d&#8217;un <em>fork</em> de ce module ;</p>
</li>
<li>
<p><strong>état des contributions</strong> : les mainteneurs répondent-ils aux contributeurs ? Les contributions de code sont-elles acceptées dans des conditions légitimes ? Ou tout simplement, y&#8217;a-t-il beaucoup de déclaration de bugs en suspens ? Telles sont les indicateurs de vitalité pour estimer la gravité et la probabilité que la librairie nous explose au visage lorsqu&#8217;on ne s&#8217;y attendra pas.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/module-npm-ok.png" alt="module npm ok" width="85%">
</div>
<div class="title">Figure 5. Page npm d&#8217;un module populaire et fiable</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/module-npm-ko.png" alt="module npm ko" width="85%">
</div>
<div class="title">Figure 6. Page npm peu encourageante</div>
</div>
<div class="paragraph">
<p>Enfin, n&#8217;oubliez pas qu&#8217;il s&#8217;agit de critères subjectifs.
Les mainteneurs du module ne sont peut-être pas de bons communicants ou n&#8217;ont que peu d&#8217;expérience en terme de tests… ou ils n&#8217;ont tout simplement pas eu le temps.<br>
N&#8217;hésitez pas à les encourager si vos expérimentations se révèlent concluantes.
Contribuez des tests et de la documentation à hauteur de votre temps.
Même s&#8217;il ne s&#8217;agit <em>que</em> de cinq lignes de code, d&#8217;un exemple supplémentaire ou d&#8217;une faute d&#8217;orthographe en moins.</p>
</div>
<div class="paragraph">
<p>C&#8217;est comme cela que l&#8217;écosystème s&#8217;améliore petit à petit… et que vous apprenez par la même occasion.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Communauté</span> Des personnes de confiance</div>
<div class="paragraph">
<p>Des organisations et des individus contribuent activement à Node en mettant à disposition une large majorité de leurs créations.</p>
</div>
<div class="paragraph">
<p>La liste suivante est non-exhaustive et référence des contributeurs de qualité :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>substack (<span class="URL"><a href="https://npmjs.com/~substack" class="bare">npmjs.com/~substack</a></span>) ;</p>
</li>
<li>
<p>jshttp (<span class="URL"><a href="https://github.com/jshttp" class="bare">github.com/jshttp</a></span>) ;</p>
</li>
<li>
<p>nodejitsu (<span class="URL"><a href="https://github.com/nodejitsu" class="bare">github.com/nodejitsu</a></span>) ;</p>
</li>
<li>
<p>mafintosh (<span class="URL"><a href="https://npmjs.com/~mafintosh" class="bare">npmjs.com/~mafintosh</a></span>) ;</p>
</li>
<li>
<p>feross (<span class="URL"><a href="https://npmjs.com/~feross" class="bare">npmjs.com/~feross</a></span>) ;</p>
</li>
<li>
<p>dougwilson (<span class="URL"><a href="https://npmjs.com/~dougwilson" class="bare">npmjs.com/~dougwilson</a></span>) ;</p>
</li>
<li>
<p>isaacs (<span class="URL"><a href="https://npmjs.com/~isaacs" class="bare">npmjs.com/~isaacs</a></span>) ;</p>
</li>
<li>
<p>fgribreau (<span class="URL"><a href="https://npmjs.com/~fgribreau" class="bare">npmjs.com/~fgribreau</a></span>) ;</p>
</li>
<li>
<p>mikeal (<span class="URL"><a href="https://npmjs.com/~mikeal" class="bare">npmjs.com/~mikeal</a></span>) ;</p>
</li>
<li>
<p>rwaldron (<span class="URL"><a href="https://npmjs.com/~rwaldron" class="bare">npmjs.com/~rwaldron</a></span>).</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_exécuter_les_tests">6.7. Exécuter les tests</h3>
<div class="paragraph">
<p>L&#8217;écriture de tests et la vérification de la qualité de votre code sont un excellent moyen de vous assurer que de nouveaux bugs ne sont pas introduits dans votre application.</p>
</div>
<div class="paragraph">
<p>Écrire des modules et les empiler sans écrire de tests revient à construire un château de carte : le moindre changement accentue le risque de propager des erreurs dans toutes les applications en dépendant.</p>
</div>
<div class="paragraph">
<p>Nous verrons ultérieurement comment écrire des tests unitaires pour vos applications et votre code exécuté dans un contexte Web.</p>
</div>
<div class="paragraph">
<p>À la manière du démarrage d&#8217;une application, la commande npm fournit un contexte d&#8217;exécution dédié aux tests :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm test</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande effectue deux choses :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>elle règle la variable d&#8217;environnement <code>NODE_ENV</code> à <code>test</code> ;</p>
</li>
<li>
<p>elle exécute l&#8217;instruction du script <code>test</code> déclarée dans le fichier <code>package.json</code> :</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code>{
  "name": "nodebook",
  ...
  "scripts": {
    "test": "mocha tests/**/*.js"
  },
  "devDependencies": {
    "mocha": "*"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, exécuter la commande <code>npm test</code> revient à actionner l&#8217;exécutable déclaré par le module <em>mocha</em> avec comme argument l&#8217;ensemble des fichiers JavaScript contenus dans le répertoire <code>tests/</code> de notre projet.</p>
</div>
<div class="paragraph">
<p>En cas de test fautif, l&#8217;exécutable de tests affichera des précisions quant à leur origine et se terminera avec un code de sortie différent de 0.</p>
</div>
<div class="paragraph">
<p>Ce qui signifie en jargon Unixien que vous pouvez chaîner la commande avec d&#8217;autres actions basées sur un état de réussite des tests :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm test &amp;&amp; git push</pre>
</div>
</div>
<div class="paragraph">
<p>Cette précédente commande a deux scénarios possibles :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>npm test</code> échoue et <code>git push</code> ne sera pas exécuté ;</p>
</li>
<li>
<p><code>npm test</code> réussit et <code>git push</code> sera exécuté.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En se basant sur ce principe de chaîne, vous pouvez faire évoluer votre commande de test en quelque chose de plus poussé :</p>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code>{
  "name": "nodebook",
  ...
  "scripts": {
    "test": "npm run lint-code &amp;&amp; npm run unit-tests",
    "lint-code": "eslint ",
    "unit-tests": "mocha tests/**/*.js"
  },
  "devDependencies": {
    "mocha": "*",
    "eslint": "^3.0.0"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande <code>npm test</code> est alors composée de deux autres commandes personnalisées.
Vous maintenez ainsi une lisibilité au sein de votre fichier <code>package.json</code> tout en bénéficiant d&#8217;une indépendance d&#8217;exécution de vos commandes.</p>
</div>
</div>
<div class="sect2">
<h3 id="npm-outdated">6.8. Vérifier et mettre à jour les dépendances</h3>
<div class="paragraph">
<p>Maintenir ses dépendances à jour est important pour deux raisons :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>colmater des bugs</strong> qui pourraient se répercuter sur votre application ;</p>
</li>
<li>
<p>se <strong>prémunir de faille de sécurité</strong> mettant en danger vos données et votre système informatique.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En dernier recours, vérifier la fraîcheur de ses dépendances permet de prendre connaissance de nouvelles versions majeures ou mineures dont vous pourriez bénéficier.</p>
</div>
<div class="paragraph">
<p>Quoiqu&#8217;il en soit, une commande npm nous aidera une fois de plus à obtenir les informations voulues :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm outdated</pre>
</div>
</div>
<div class="paragraph">
<p>La lecture de sa sortie peut être déroutante au premier abord, notamment dans le cas d&#8217;un module qui n&#8217;a pas été mis à jour via <code>npm update</code> depuis un moment :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/npm-outdated.png" alt="npm outdated" width="85%">
</div>
<div class="title">Figure 7. Résultats obsolètes issus de <code>npm outdated</code></div>
</div>
<div class="paragraph">
<p>Le tableau ne liste que les dépendances considérées comme obsolètes en l&#8217;état actuel d&#8217;installation de votre projet.
Il se peut donc que le résultat varie d&#8217;une machine à l&#8217;autre, en fonction des versions installées localement.<br>
Les résultats est divisé en cinq colonnes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Package</strong> : nom du paquet concerné — en jaune une dépendance qui sera satisfaite en cas de <code>npm update</code>, en rouge une dépendance qui nécessite une mise à jour manuelle ;</p>
</li>
<li>
<p><strong>Current</strong> : version installée localement — <em>MISSING</em> sera affiché si la dépendance n&#8217;est pas encore installée, <em>git</em> indique que la dépendance est installée via git ;</p>
</li>
<li>
<p><strong>Wanted</strong> : version installée après exécution de <code>npm update</code> ;</p>
</li>
<li>
<p><strong>Latest</strong> : version la plus récente publiée dans le registre npm ;</p>
</li>
<li>
<p><strong>Location</strong> : emplacement de la dépendance — dépendance directe ou dépendance incluse dans une autre dépendance etc.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Et si une dépendance n&#8217;est pas listée ?</div>
<div class="paragraph">
<p>Toute dépendance listée dans le fichier <code>package.json</code> mais absente du tableau est considérée comme à jour.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La première action à mener est de procéder à l&#8217;exécution de la commande <code>npm update</code>, puis de relancer la commande <code>npm outdated</code> :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/npm-outdated-wanted.png" alt="npm outdated wanted" width="85%">
</div>
<div class="title">Figure 8. Résultats <code>npm outdated</code> après mise à jour</div>
</div>
<div class="paragraph">
<p>Le résultat est probant : de nombreuses dépendances précédemment listées en rouge ont disparu.
Il ne reste que trois dépendances sur lesquelles nous pouvons avoir une action directe en modifiant la version référencées dans le fichier <code>package.json</code>.</p>
</div>
<div class="paragraph">
<p>Pour forcer l&#8217;installation de la version correspondant à la colonne <em>Latest</em> de la commande <code>npm outdated</code>, il suffit d&#8217;utiliser le suffixe <code>@latest</code> lors de l&#8217;installation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm install --save-dev mocha@latest karma@latest …</pre>
</div>
</div>
<div class="paragraph">
<p>Et ainsi de suite pour les autres dépendances de premier niveau.
La commande <code>npm outdated</code> ne devrait pas retourner de résultats, sauf si une de vos dépendances n&#8217;est pas à jour elle-même.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">7. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous sommes désormais en mesure d&#8217;installer Node sur notre ordinateur, de créer un projet, d&#8217;installer et d&#8217;ajouter des dépendances avant d&#8217;exécuter un programme.</p>
</div>
<div class="paragraph">
<p>Nous avons également passé en revue des fondamentaux d&#8217;UNIX, d&#8217;ECMAScript et de l&#8217;API Node.</p>
</div>
<div class="paragraph">
<p>Les prochains chapitres abordent une thématique différente pour saisir la <strong>versatilité du champ d&#8217;applications</strong> de Node.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-09-06 14:02:03 UTC
</div>
</div>
</body>
</html>